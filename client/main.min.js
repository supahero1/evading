let c=document.getElementById("loading");c.innerHTML="Fetching servers...";
let ca=document.getElementById("sub"),d=document.getElementById("name"),l=document.getElementById("canvas"),p=l.getContext("2d"),r=document.createElement("canvas"),t=r.getContext("2d"),u=document.createElement("canvas"),da=u.getContext("2d"),ea=0,fa=["#dddddd","#aaaaaa","#333333","#fedf78"],ha=["#808080","#fc46aa","#008080","#ff8e06","#d2b48c"],w=Array(ha.length),ia=0,ja=0,x=0,ka=new ArrayBuffer(524288),y=new Uint8Array(ka),z=new DataView(y.buffer),A=0,B=0,C=Array(256),D=[];
var la=0,ma=0,na=0,E=0,oa=0,F=0;let G=[0,0],H=null,pa=0,qa=0,ra=0,sa=0;var I=0,J=0,K=0,L=0,M=1,O=0,ta=0,P=0,S=0,T=0,U=0,V=[],W=[];let X=1,Y=X,Z=[0,0];window.s.then(f=>f.json()).then(f=>ua(f));function xa(){setTimeout(location.reload.bind(location),1E3)}
function ua(f){if(0==f.length)c.innerHTML="No servers found",xa();else{c.innerHTML="Connecting...";var n=f.map(function(m){m=new WebSocket(m[1]);m.binaryType="arraybuffer";m.i=[];m.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};m.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return m});setTimeout(function(){let m=999999,q=null;for(let k of n){k.h=0;for(let v of k.i)k.h+=v;0<k.i.length?k.h/=k.i.length:
k.h=999999;k.h<m&&(m=k.h,q=k)}for(let k of n)k.onopen=function(){},k.onmessage=function(){},delete k.i,delete k.time,delete k.h,k!=q&&k.close();null==q||1!=q.readyState?(c.innerHTML="Failed connecting",xa()):ya(q)},1E3)}}function za(){na=E;oa=F;for(let f of C)f&&(f.g.x1=f.g.x2,f.g.y1=f.g.y2,f.g.r1=f.g.r2);for(let f of D)f&&(f.g.x1=f.g.x2,f.g.y1=f.g.y2,f.g.r1=f.g.r2)}
function ya(f){c.innerHTML="Enter your name<br>";ca.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";d.style.display="block";d.onkeypress=d.onblur=d.onpaste=function(n){let m=n.target.value+n.key;4<(new TextEncoder).encode(m).byteLength?n.target.value=n.target.m||"":(n.target.value=m,n.target.m=m);n.preventDefault();return!1};f.onclose=function(){window.onbeforeunload=function(){};l.parentElement.removeChild(l);c.innerHTML="Disconnected";
ca.innerHTML="";d.style.display="none";xa()};window.onkeydown=function(n){13==(n.keyCode||n.which)&&(c.innerHTML="Spawning...",ca.innerHTML="",d.style.display="none",n=(n=window.localStorage.getItem("token"))?n.split(",").map(m=>+m):[],f.send(new Uint8Array([0,...(new TextEncoder).encode(d.value),0,...n,0])),Aa(f))}}
function Aa(f){function n({data:a}){y.set(new Uint8Array(a));A=a.byteLength;a=y[0]|y[1]<<8|y[2]<<16|y[3]<<24;if(0!=aa&&4!=a-aa)throw f.onmessage=function(){},Error(`tick - last_tick = ${a-aa}`);aa=a;a=4;Z[0]=Z[1];Z[1]+=40;za();if(a!=A){if(0==y[a]){++a;pa=1;D=[];B=y[a++];a+=2;S=y[a]|y[a+1]<<8;a+=2;T=y[a]|y[a+1]<<8;a+=2;U=y[a++];V=Array(256);W=Array(256);for(var g=0;g<S;++g)for(var e=0;e<T;++e)null==V[y[a]]&&(V[y[a]]=new Path2D,W[y[a]]=new Path2D),V[y[a]].rect(4*(1.5+g*U),4*(1.5+e*U),4*(U-3),4*(U-3)),
W[y[a]].rect(g*U*4,e*U*4,4*U,4*U),++a;r.width=U*S*4;r.height=U*T*4;u.width=U*S*4;u.height=U*T*4;for(g=0;256>g;++g)V[g]&&(t.fillStyle=fa[g]+"b0",t.fill(W[g]),t.fillStyle=fa[g],t.fill(V[g]),da.fillStyle=fa[g],da.fill(W[g]));ea||(requestAnimationFrame(va),ea=1)}if(a!=A){if(1==y[a])for(++a,g=y[a++],e=0;e<g;++e){var b=y[a++];if(C[b]){var h=y[a++];if(h)for(;h;){switch(h){case 1:C[b].g.x2=z.getFloat32(a,!0);a+=4;B==b&&(E=C[b].g.x2);break;case 2:C[b].g.y2=z.getFloat32(a,!0);a+=4;B==b&&(F=C[b].g.y2);break;
case 3:C[b].g.r2=z.getFloat32(a,!0);a+=4;break;case 4:C[b].j=y[a++],C[b].j&&(C[b].l=y[a++])}h=y[a++]}else C[b]=void 0}else{h=z.getFloat32(a,!0);a+=4;var N=z.getFloat32(a,!0);a+=4;var Q=z.getFloat32(a,!0);a+=4;var R=y[a++],ba=(new TextDecoder).decode(y.subarray(a,a+R));a+=R;R=y[a++];let wa=0;R&&(wa=y[a++]);C[b]={x:0,y:0,r:0,g:{x1:h,x2:h,y1:N,y2:N,r1:Q,r2:Q},name:ba,j:R,l:wa};B==b&&(E=h,F=N)}}if(a!=A&&2==y[a])for(++a,g=y[a]|y[a+1]<<8,a+=2,e=0;e<g;++e)if(b=y[a]|y[a+1]<<8,a+=2,D[b])if(h=y[a++])for(;h;){switch(h){case 1:D[b].g.x2=
z.getFloat32(a,!0);a+=4;break;case 2:D[b].g.y2=z.getFloat32(a,!0);a+=4;break;case 3:D[b].g.r2=z.getFloat32(a,!0);if(1>D[b].g.r2||60<D[b].g.r2)throw console.log(`update ball id ${b} r ${D[b].g.r2}`),f.onmessage=function(){},Error();a+=4}h=y[a++]}else D[b]=void 0;else if(h=y[a++],0!=h&&(--h,N=z.getFloat32(a,!0),a+=4,Q=z.getFloat32(a,!0),a+=4,ba=z.getFloat32(a,!0),a+=4,D[b]={type:h,x:0,y:0,r:0,g:{x1:N,x2:N,y1:Q,y2:Q,r1:ba,r2:ba}},1>D[b].g.r2||60<D[b].g.r2))throw console.log(`create ball id ${b} r ${D[b].g.r2}`),
f.onmessage=function(){},Error();}}}function m(){if(window.innerWidth!=ia||window.innerHeight!=ja||x!=window.devicePixelRatio)x=window.devicePixelRatio,ia=window.innerWidth,l.width=ia*x,ja=window.innerHeight,l.height=ja*x}function q(a,g,e){return a+(g-a)*e}function k(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function v(){ta||
(I||J||K||L?(O=Math.atan2(L-I,K-J),P=160*x):P=O=0);z.setFloat32(0,O,!0);P>=160*x?z.setUint8(4,255*M>>>0):z.setUint8(4,1.59375*P/x*M>>>0);f.send(y.subarray(0,5))}function va(a){if(0!=Z[0]){H?H<Z[0]?H=Z[0]:H>Z[1]&&(H=Z[1]):H=Z[0];var g=X;X=q(X,Y,.1);X!=g&&(P=Math.hypot(G[0]-l.width/2,G[1]-l.height/2)/X,v());g=Z[0]==Z[1]?0:(H-Z[0])/(Z[1]-Z[0]);H+=a-sa;sa=a;la=q(na,E,g);ma=q(oa,F,g);p.resetTransform();p.fillStyle="#333";p.fillRect(0,0,l.width,l.height);p.translate(l.width/2,l.height/2);p.scale(X,X);p.translate(-la,
-ma);p.drawImage(r,0,0,r.width/4,r.height/4);1>X&&(p.globalAlpha=1-X*X,p.drawImage(u,0,0,r.width/4,r.height/4),p.globalAlpha=1);a=new Path2D;for(var e of C)e&&(e.x=q(e.g.x1,e.g.x2,g),e.y=q(e.g.y1,e.g.y2,g),e.r=q(e.g.r1,e.g.r2,g),a.moveTo(e.x+e.r-2,e.y),a.arc(e.x,e.y,e.r-2,0,2*Math.PI));p.beginPath();p.fillStyle="#ebecf0";p.strokeStyle=k("#ebecf0");p.lineWidth=4;p.stroke(a);p.fill(a);for(e=0;e<w.length;++e)w[e]=new Path2D;for(var b of D)b&&(b.x=q(b.g.x1,b.g.x2,g),b.y=q(b.g.y1,b.g.y2,g),b.r=q(b.g.r1,
b.g.r2,g),w[b.type].moveTo(b.x+b.r-2,b.y),w[b.type].arc(b.x,b.y,b.r-2,0,2*Math.PI));p.beginPath();p.lineWidth=4;for(b=0;b<w.length;++b)p.fillStyle=ha[b],p.strokeStyle=k(ha[b]),p.stroke(w[b]),p.fill(w[b]);for(let h of C)h&&(p.beginPath(),0!=h.name.length&&(p.font=`700 ${h.r/X}px Ubuntu`,p.textAlign="center",p.textBaseline="middle",p.fillStyle="#00000080",ra=1<X?.5*h.r:.5*h.r+2/(X*X),qa=q(qa,ra,.1),p.fillText(h.name,h.x,h.y-h.r-qa)),h.j&&(p.font=`700 ${h.r/Math.min(X,1)}px Ubuntu`,p.textAlign="center",
p.textBaseline="middle",p.fillStyle="#f00",p.fillText(h.l,h.x,h.y)))}requestAnimationFrame(va)}let aa=0;f.onmessage=function(a){pa=0;n(a);pa&&(c.innerHTML="",za())};m();window.onresize=m;window.onwheel=function(a){a=.05*-Math.sign(a.deltaY);Y=1<Y?Y+3*a:Y+a;Y=Math.min(Math.max(Y,.25),4)};window.onmousemove=function(a){G=[a.clientX*x,a.clientY*x];O=Math.atan2(G[1]-l.height/2,G[0]-l.width/2);P=Math.hypot(G[0]-l.width/2,G[1]-l.height/2)/X;v()};window.onmousedown=function(){ta=!ta;O=Math.atan2(G[1]-l.height/
2,G[0]-l.width/2);P=Math.hypot(G[0]-l.width/2,G[1]-l.height/2)/X;v()};window.onkeydown=function(a){switch(a.keyCode||a.which){case 16:1==M&&(M=.5,v());break;case 87:case 38:I||(I=1,v());break;case 65:case 37:J||(J=1,v());break;case 68:case 39:K||(K=1,v());break;case 83:case 40:L||(L=1,v())}};window.onkeyup=function(a){switch(a.keyCode||a.which){case 16:.5==M&&(M=1,v());break;case 87:case 38:I&&(I=0,v());break;case 65:case 37:J&&(J=0,v());break;case 68:case 39:K&&(K=0,v());break;case 83:case 40:L&&
(L=0,v())}};window.onbeforeunload=function(a){a.preventDefault();return a.returnValue="Are you sure you want to quit?"}};
