let c=document.getElementById("loading");c.innerHTML="Fetching servers...";
let aa=document.getElementById("sub"),e=document.getElementById("name"),g=document.getElementById("canvas"),n=g.getContext("2d"),t=document.createElement("canvas"),ba=t.getContext("2d"),ca=document.createElement("canvas"),da=ca.getContext("2d"),u=document.createElement("canvas"),v=u.getContext("2d"),ea=0,fa=["#dddddd","#aaaaaa","#333333","#fedf78"],ha=["#808080","#fc46aa","#008080","#ff8e06","#3cdfff"],ka=0,la=0,w=0,ma=new ArrayBuffer(1048576),x=new Uint8Array(ma),z=new DataView(x.buffer),na=0,oa=
0,A=[],C=[];var pa=0,qa=0,ra=0,sa=0,ta=0,ua=0;let D=[0,0],E=null,va=0,F=[0,0],wa=0,ya=0,za=0,Aa=document.getElementById("settings"),G=document.getElementById("ss"),H=!1,I=Array(5).fill(0),Ba=window.localStorage.getItem("keybinds"),Ca={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft"},J=null!=Ba?JSON.parse(Ba):Ca;for(let b in Ca)void 0==J[b]&&(J[b]=Ca[b]);for(let b in J)void 0==Ca[b]&&delete J[b];var K=0,L=0,M=0,N=0,O=1,Da=0,Ea=0,P=0,Fa=0,Ga=0,Q=0,Ha=[],Ia=[];
let Ja=window.localStorage.getItem("settings"),R={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},chat_text_scale:{min:1,max:2,value:1,step:.05},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!1,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!1,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,
value:40,step:1}},S=null!=Ja?JSON.parse(Ja):JSON.parse(JSON.stringify(R));for(let b in R)void 0==S[b]&&(S[b]=R[b]);for(let b in S)void 0==R[b]&&delete S[b],S[b].min&&S[b].min!=R[b].min&&(S[b].min=R[b].min),S[b].max&&S[b].max!=R[b].max&&(S[b].max=R[b].max),S[b].value=Math.max(Math.min(S[b].value,S[b].max),S[b].min);window.localStorage.setItem("settings",JSON.stringify(S));
let Ka=!1,La="",Ma,T=S.fov.value,U=T,Na=document.getElementById("chat"),V=document.getElementById("messages"),W=document.getElementById("sendmsg"),Oa=S.chat_on,Qa=0;window.s.then(b=>b.json()).then(b=>Ra(b));function Sa(){setTimeout(location.reload.bind(location),1E3)}function Ta(){window.localStorage.setItem("settings",JSON.stringify(S))}function Ua(){window.localStorage.setItem("keybinds",JSON.stringify(J))}function Va(b){let d=document.createElement("h1");d.innerHTML=b;return d}
function X(b){let d=document.createElement("h3");d.innerHTML=b;return d}function Wa(){return document.createElement("table")}function Y(b,d,q){let r=document.createElement("tr"),h=document.createElement("td");h.appendChild(d);r.appendChild(h);h=document.createElement("td");h.appendChild(q);r.appendChild(h);b.appendChild(r)}
function Z(b){let d=document.createElement("button");S[b]=!S[b];d.onclick=function(){S[b]=!S[b];1==S[b]?(d.innerHTML="ON",d.style["background-color"]="#23c552"):(d.innerHTML="OFF",d.style["background-color"]="#f84f31");Ta()};d.onclick();return d}function Xa(b){let d=document.createElement("button");d.innerHTML=J[b];d.onclick=async function(){d.innerHTML="...";Ka=1;await new Promise(function(q){Ma=q});Ka=0;d.innerHTML=La;J[b]=La;Ua()};return d}
function Ya(b,d="",q=function(){}){let r=document.createElement("div");r.className="input";let h=document.createElement("input");h.type="range";h.min=S[b].min;h.max=S[b].max;h.step=S[b].step;h.value=S[b].value;h.oninput=function(){h.nextElementSibling.innerHTML=h.value+d;S[b].value=h.valueAsNumber;q()};h.onchange=Ta;r.appendChild(h);r.appendChild(X(h.value+d));return r}function Za(b){let d=document.createElement("button");d.innerHTML="RESET";d.onclick=b;return d}
function $a(){G.innerHTML="";G.appendChild(Va("CHAT"));let b=Wa();Y(b,X("Show chat"),Z("chat_on"));Y(b,X("Max number of chat messages"),Ya("max_chat_messages","",function(){for(;Qa>S.max_chat_messages.value;)V.removeChild(V.lastChild),--Qa}));Y(b,X("Chat text scale"),Ya("chat_text_scale","",function(){V.style["font-size"]=S.chat_text_scale.value+"em"}));G.appendChild(b);G.appendChild(Va("VISUALS"));b=Wa();Y(b,X("Default FOV"),Ya("fov"));Y(b,X("Draw balls' fill"),Z("draw_ball_fill"));Y(b,X("Draw balls' stroke"),
Z("draw_ball_stroke"));Y(b,X("Draw stroke-only balls with brighter color"),Z("draw_ball_stroke_bright"));Y(b,X("Balls' stroke radius percentage"),Ya("ball_stroke"," %"));Y(b,X("Draw players' fill"),Z("draw_player_fill"));Y(b,X("Draw players' stroke"),Z("draw_player_stroke"));Y(b,X("Draw stroke-only players with brighter color"),Z("draw_player_stroke_bright"));Y(b,X("Players' stroke radius percentage"),Ya("player_stroke"," %"));Y(b,X("Draw players' name"),Z("draw_player_name"));Y(b,X("Draw an arrow towards dead players"),
Z("draw_death_arrow"));Y(b,X("Death arrow size"),Ya("death_arrow_size","px",ab));G.appendChild(b);G.appendChild(Va("KEYBINDS"));b=Wa();Y(b,X("Settings"),Xa("settings"));Y(b,X("Move up"),Xa("up"));Y(b,X("Move left"),Xa("left"));Y(b,X("Move down"),Xa("down"));Y(b,X("Move right"),Xa("right"));Y(b,X("Move slowly"),Xa("slowwalk"));G.appendChild(b);G.appendChild(Va("RESET"));b=Wa();Y(b,X("Reset settings"),Za(function(){S=R;Ta();$a()}));Y(b,X("Reset keybinds"),Za(function(){J=Ca;Ua();$a()}));G.appendChild(b)}
$a();function bb(b,d){let q=document.createElement("p");q.appendChild(document.createTextNode(b+": "+d));V.insertBefore(q,V.firstChild);++Qa>S.max_chat_messages.value&&V.removeChild(V.lastChild)}function ab(){u.width=u.height=S.death_arrow_size.value;let b=.5*u.width,d=u.width;v.beginPath();v.moveTo(b+.45*d,b);v.lineTo(b-.225*d,b-.675*d/Math.sqrt(3));v.lineTo(b-.225*d,b+.675*d/Math.sqrt(3));v.closePath();v.fillStyle="#bbbbbbb0";v.fill();v.lineWidth=.05*u.width;v.strokeStyle="#f00";v.stroke()}ab();
function Ra(b){if(0==b.length)c.innerHTML="No servers found",Sa();else{c.innerHTML="Connecting...";var d=b.map(function(q){q=new WebSocket(q[1]);q.binaryType="arraybuffer";q.i=[];q.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};q.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return q});setTimeout(function(){let q=999999,r=null;for(let h of d){h.h=0;for(let B of h.i)h.h+=B;0<h.i.length?h.h/=h.i.length:
h.h=999999;h.h<q&&(q=h.h,r=h)}for(let h of d)h.onopen=function(){},h.onmessage=function(){},delete h.i,delete h.time,delete h.h,h!=r&&h.close();null==r||1!=r.readyState?(c.innerHTML="Failed connecting",Sa()):eb(r)},1E3)}}function fb(){ra=sa;ta=ua;for(let b of A)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2);for(let b of C)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2)}
function gb(b){return function(d){let q=d instanceof ClipboardEvent;if(q&&"paste"!=d.type)return!0;let r=d.target.value+(q?d.clipboardData.getData("text"):d.key);if((new TextEncoder).encode(r).byteLength>b){if(""==d.target.value&&q){const h=d.target.placeholder;d.target.placeholder="Text too long to paste!";setTimeout(function(){d.target.placeholder=h},1E3)}d.preventDefault();return!1}return!0}}
function eb(b){c.innerHTML="Enter your name<br>";aa.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";e.style.display="block";e.focus();let d=window.localStorage.getItem("name");d&&(e.value=d);e.onkeypress=e.onpaste=gb(4);b.onclose=function(){window.onbeforeunload=function(){};g.parentElement.removeChild(g);Aa.parentElement.removeChild(Aa);Na.parentElement.removeChild(Na);c.innerHTML="Disconnected";aa.innerHTML="";e.style.display="none";
Sa()};window.onkeydown=function(q){if("Enter"==q.code){window.localStorage.setItem("name",e.value);c.innerHTML="Spawning...";aa.innerHTML="";e.style.display="none";q=(q=window.localStorage.getItem("token"))?q.split(",").map(h=>+h):[];let r=(new TextEncoder).encode(e.value);b.send(new Uint8Array([...r,...q]));hb(b)}}}
function hb(b){function d({data:a}){x.set(new Uint8Array(a));na=a.byteLength;a=x[0]|x[1]<<8|x[2]<<16|x[3]<<24;if(0!=xa&&4!=a-xa)throw b.onmessage=function(){},Error(`tick - last_tick = ${a-xa}`);xa=a;a=4;F[0]=F[1];F[1]=performance.now();fb();if(a!=na){if(0==x[a]){++a;wa=1;C=[];oa=x[a++];a+=2;Fa=x[a]|x[a+1]<<8;a+=2;Ga=x[a]|x[a+1]<<8;a+=2;Q=x[a++];Ha=Array(256);Ia=Array(256);for(var k=0;k<Fa;++k)for(var l=0;l<Ga;++l)null==Ha[x[a]]&&(Ha[x[a]]=new Path2D,Ia[x[a]]=new Path2D),Ha[x[a]].rect((1.5+k*Q)*S.fov.max,
(1.5+l*Q)*S.fov.max,(Q-3)*S.fov.max,(Q-3)*S.fov.max),Ia[x[a]].rect(k*Q*S.fov.max,l*Q*S.fov.max,Q*S.fov.max,Q*S.fov.max),++a;t.width=Q*Fa*S.fov.max;t.height=Q*Ga*S.fov.max;ca.width=Q*Fa*S.fov.max;ca.height=Q*Ga*S.fov.max;for(k=0;256>k;++k)Ha[k]&&(ba.fillStyle=fa[k]+"b0",ba.fill(Ia[k]),ba.fillStyle=fa[k],ba.fill(Ha[k]),da.fillStyle=fa[k],da.fill(Ia[k]));ea||(requestAnimationFrame(cb),ea=1)}if(a!=na){if(1==x[a])for(++a,k=x[a++],l=0;l<k;++l){var f=x[a++];if(A[f]){var m=x[a++];if(m)for(;m;){switch(m){case 1:A[f].g.x2=
z.getFloat32(a,!0);a+=4;oa==f&&(sa=A[f].g.x2);break;case 2:A[f].g.y2=z.getFloat32(a,!0);a+=4;oa==f&&(ua=A[f].g.y2);break;case 3:A[f].g.r2=z.getFloat32(a,!0);a+=4;break;case 4:A[f].j=x[a++];A[f].j&&(A[f].l=x[a++]);break;case 5:m=x[a++],bb(A[f].name,(new TextDecoder).decode(x.subarray(a,a+m))),a+=m}m=x[a++]}else A[f]=void 0}else{m=z.getFloat32(a,!0);a+=4;var p=z.getFloat32(a,!0);a+=4;var y=z.getFloat32(a,!0);a+=4;var ia=x[a++],ja=(new TextDecoder).decode(x.subarray(a,a+ia));a+=ia;ia=x[a++];let db=0;
ia&&(db=x[a++]);let Pa=x[a++];0<Pa&&(bb(ja,(new TextDecoder).decode(x.subarray(a,a+Pa))),a+=Pa);A[f]={x:0,y:0,r:0,g:{x1:m,x2:m,y1:p,y2:p,r1:y,r2:y},name:ja,j:ia,l:db};oa==f&&(sa=m,ua=p)}}if(a!=na){if(2==x[a])for(++a,k=x[a]|x[a+1]<<8,a+=2,l=0;l<k;++l)if(f=x[a]|x[a+1]<<8,a+=2,C[f])if(m=x[a++])for(;m;){switch(m){case 1:C[f].g.x2=z.getFloat32(a,!0);a+=4;break;case 2:C[f].g.y2=z.getFloat32(a,!0);a+=4;break;case 3:C[f].g.r2=z.getFloat32(a,!0);if(1>C[f].g.r2||60<C[f].g.r2)throw console.log(`update ball id ${f} r ${C[f].g.r2}`),
b.onmessage=function(){},Error();a+=4}m=x[a++]}else C[f]=void 0;else if(m=x[a++],0!=m&&(--m,p=z.getFloat32(a,!0),a+=4,y=z.getFloat32(a,!0),a+=4,ja=z.getFloat32(a,!0),a+=4,C[f]={type:m,x:0,y:0,r:0,g:{x1:p,x2:p,y1:y,y2:y,r1:ja,r2:ja}},1>C[f].g.r2||60<C[f].g.r2))throw console.log(`create ball id ${f} r ${C[f].g.r2}`),b.onmessage=function(){},Error();if(a!=na&&3==x[a])for(++a,k=x[a++],l=0;l<k;++l)m=x[a++],f=(new TextDecoder).decode(x.subarray(a,a+m)),a+=m,m=x[a++],bb(f,(new TextDecoder).decode(x.subarray(a,
a+m))),a+=m}}}}function q(){if(window.innerWidth!=ka||window.innerHeight!=la||w!=window.devicePixelRatio)w=window.devicePixelRatio,ka=window.innerWidth,g.width=ka*w,la=window.innerHeight,g.height=la*w}function r(a,k,l){return a+(k-a)*l}function h(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function B(){Ea||(0==N-K&&
0==M-L?P=Da=0:(Da=Math.atan2(N-K,M-L),P=160*w));H?b.send(new Uint8Array([0,0,0,0,0,0])):(x[0]=0,z.setFloat32(1,Da,!0),P>=160*w?z.setUint8(5,255*O>>>0):z.setUint8(5,1.59375*P/w*O>>>0),b.send(x.subarray(0,6)))}function cb(a){if(0!=F[0]){S.chat_on==!Oa&&(Oa=S.chat_on,Na.style.display=Oa?"block":"none");E?E<F[0]?E=F[0]:E>F[1]&&(E=F[1]):E=F[0];var k=T;T=r(T,U,.1);T!=k&&(P=Math.hypot(D[0]-.5*g.width,D[1]-.5*g.height)/T,B());k=F[0]==F[1]?0:(E-F[0])/(F[1]-F[0]);E+=a-va;va=a;pa=r(ra,sa,k);qa=r(ta,ua,k);n.resetTransform();
n.fillStyle="#333";n.fillRect(0,0,g.width,g.height);n.translate(.5*g.width,.5*g.height);n.scale(T,T);n.translate(-pa,-qa);n.drawImage(t,0,0,t.width/S.fov.max,t.height/S.fov.max);1>T&&(n.globalAlpha=1-T*T,n.drawImage(ca,0,0,t.width/S.fov.max,t.height/S.fov.max),n.globalAlpha=1);a=[];if(S.draw_player_fill||S.draw_player_stroke)for(var l of A)l&&(l.x=r(l.g.x1,l.g.x2,k),l.y=r(l.g.y1,l.g.y2,k),l.r=r(l.g.r1,l.g.r2,k),a[a.length]={u:l});if(S.draw_ball_fill||S.draw_ball_stroke)for(var f of C)f&&(f.x=r(f.g.x1,
f.g.x2,k),f.y=r(f.g.y1,f.g.y2,k),f.r=r(f.g.r1,f.g.r2,k),a[a.length]={o:f});a.sort((m,p)=>m.r-p.r);for(let {o:m,u:p}of a)if(n.beginPath(),p){if(l=S.player_stroke.value/200*p.r,n.moveTo(p.x+p.r-l,p.y),n.arc(p.x,p.y,p.r-l,0,2*Math.PI),S.draw_player_fill&&(n.fillStyle="#ebecf0",n.fill()),S.draw_player_stroke&&(!S.draw_player_fill&&S.draw_player_stroke_bright?n.strokeStyle="#ebecf0":n.strokeStyle=h("#ebecf0"),n.lineWidth=2*l,n.stroke()),S.draw_player_name&&0!=p.name.length&&(n.font=`700 ${p.r/T}px Ubuntu`,
n.textAlign="center",n.textBaseline="middle",n.fillStyle="#00000080",za=1<T?.5*p.r:.5*p.r+2/(T*T),ya=r(ya,za,.1),n.fillText(p.name,p.x,p.y-p.r-ya)),p.j&&(n.font=`700 ${p.r/Math.min(T,1)}px Ubuntu`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#f00",n.fillText(p.l,p.x,p.y),S.draw_death_arrow)){a=.5*g.width+(p.x-pa)*T;k=.5*g.height+(p.y-qa)*T;let y=.75*u.width*T;if(0>a||a>g.width||0>k||k>g.height)f=Math.max(Math.min(a,g.width-y),y),l=Math.max(Math.min(k,g.height-y),y),a=(a<y||a>g.width-
y)&&(k<y||k>g.height-y)?Math.atan2(k-l,a-f):Math.atan2(k<y?-1:k>g.height-y?1:0,a<y?-1:a>g.width-y?1:0),f=(f-.5*g.width)/T+pa,l=(l-.5*g.height)/T+qa,n.translate(f,l),n.rotate(a),n.drawImage(u,.5*-u.width,.5*-u.width),n.rotate(-a),n.font=`700 ${.3*u.width}px Ubuntu`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#f00",n.fillText(p.l,0,0),n.translate(-f,-l)}}else l=S.ball_stroke.value/200*m.r,n.moveTo(m.x+m.r-l,m.y),n.arc(m.x,m.y,m.r-l,0,2*Math.PI),S.draw_ball_fill&&(n.fillStyle=ha[m.type],
n.fill()),S.draw_ball_stroke&&(n.strokeStyle=!S.draw_ball_fill&&S.draw_ball_stroke_bright?ha[m.type]:h(ha[m.type]),n.lineWidth=2*l,n.stroke())}requestAnimationFrame(cb)}Oa=!S.chat_on;let xa=0;b.onmessage=function(a){wa=0;d(a);wa&&(c.innerHTML="",fb())};W.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=(new TextEncoder).encode(W.value);if(0<a.length){x[0]=1;x[1]=a.length;x.set(a,2);b.send(x.subarray(0,x[1]+2));I.pop();I.unshift((new Date).getTime());a=Math.abs(I[I.length-1]-I[0]);const k=
1E3*I.length;if(a<k){const l=W.placeholder;W.placeholder="You are on cooldown for sending too many messages too fast";W.m=1;W.onkeypress=W.onpaste=null;setTimeout(function(){W.onkeypress=W.onpaste=gb(128);W.m=0;W.placeholder=l},k-a)}}W.value="";W.blur();g.focus()}};W.onkeyup=function(a){a.stopPropagation()};W.onkeypress=W.onpaste=gb(128);q();window.onresize=q;g.onwheel=function(a){a=.05*-Math.sign(a.deltaY);U=1<U?U+3*a:U+a;U=Math.min(Math.max(U,S.fov.min),S.fov.max)};window.onmousemove=function(a){D=
[a.clientX*w,a.clientY*w];Da=Math.atan2(D[1]-.5*g.height,D[0]-.5*g.width);P=Math.hypot(D[0]-.5*g.width,D[1]-.5*g.height)/T;B()};g.onmousedown=function(){Ea=!Ea;Da=Math.atan2(D[1]-.5*g.height,D[0]-.5*g.width);P=Math.hypot(D[0]-.5*g.width,D[1]-.5*g.height)/T;B()};window.onkeydown=function(a){if(!a.repeat)if(H)Ka?(a.preventDefault(),La=a.code,Ma()):a.code==J.settings&&(H=!1,Aa.style.display="none");else switch(a.code){case "Enter":W.m||W.focus();a.preventDefault();break;case J.slowwalk:1==O&&(O=.5,B());
break;case J.up:K||(K=1,B());break;case J.left:L||(L=1,B());break;case J.right:M||(M=1,B());break;case J.down:N||(N=1,B());break;case J.settings:H=!H,Aa.style.display=H?"block":"none"}};window.onkeyup=function(a){if(!a.repeat&&!H)switch(a.code){case J.slowwalk:.5==O&&(O=1,B());break;case J.up:K&&(K=0,B());break;case J.left:L&&(L=0,B());break;case J.right:M&&(M=0,B());break;case J.down:N&&(N=0,B())}};window.onbeforeunload=function(a){a.preventDefault();a.returnValue="Are you sure you want to quit?";
window.localStorage.setItem("settings",JSON.stringify(S));return"Are you sure you want to quit?"};g.oncontextmenu=function(a){a.preventDefault();return!1}};
