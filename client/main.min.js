let c=document.getElementById("loading");c.innerHTML="Fetching servers...";
let aa=document.getElementById("sub"),e=document.getElementById("name"),g=document.getElementById("canvas"),n=g.getContext("2d"),t=document.createElement("canvas"),ba=t.getContext("2d"),ca=document.createElement("canvas"),da=ca.getContext("2d"),u=document.createElement("canvas"),v=u.getContext("2d"),ea=0,fa=["#dddddd","#aaaaaa","#333333","#fedf78"],ja=["#808080","#fc46aa","#008080","#ff8e06","#3cdfff"],ka=0,la=0,w=0,ma=new ArrayBuffer(1048576),y=new Uint8Array(ma),z=new DataView(y.buffer),na=0,oa=
0,B=[],C=[];var pa=0,qa=0,ra=0,sa=0,ta=0,ua=0;let D=[0,0],E=null,wa=0,F=[0,0],xa=0,ya=0,za=0,Aa=document.getElementById("settings"),G=document.getElementById("ss"),H=!1,I=Array(5).fill(0),Ba=window.localStorage.getItem("keybinds"),Ca={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft"},J=null!=Ba?JSON.parse(Ba):Ca;for(let b in Ca)void 0==J[b]&&(J[b]=Ca[b]);for(let b in J)void 0==Ca[b]&&delete J[b];var K=0,L=0,M=0,N=0,O=1,Da=0,Ea=0,P=0,Fa=0,Ga=0,Q=0,R=[],Ha=[];
let Ia=window.localStorage.getItem("settings"),S={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!1,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!1,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1}},T=null!=Ia?JSON.parse(Ia):JSON.parse(JSON.stringify(S));
for(let b in S)void 0==T[b]&&(T[b]=S[b]);for(let b in T)void 0==S[b]&&delete T[b],T[b].min&&T[b].min!=S[b].min&&(T[b].min=S[b].min),T[b].max&&T[b].max!=S[b].max&&(T[b].max=S[b].max),T[b].value=Math.max(Math.min(T[b].value,T[b].max),T[b].min);window.localStorage.setItem("settings",JSON.stringify(T));let Ja=!1,Ka="",La,U=T.fov.value,V=U,Na=document.getElementById("chat"),Oa=document.getElementById("messages"),W=document.getElementById("sendmsg"),Pa=T.chat_on,Qa=0;
window.s.then(b=>b.json()).then(b=>Ra(b));function Sa(){setTimeout(location.reload.bind(location),1E3)}function Ta(){window.localStorage.setItem("settings",JSON.stringify(T))}function Ua(){window.localStorage.setItem("keybinds",JSON.stringify(J))}function Va(b){let d=document.createElement("h1");d.innerHTML=b;return d}function X(b){let d=document.createElement("h3");d.innerHTML=b;return d}
function Y(b,d,q){let r=document.createElement("tr"),h=document.createElement("td");h.appendChild(d);r.appendChild(h);h=document.createElement("td");h.appendChild(q);r.appendChild(h);b.appendChild(r)}function Z(b){let d=document.createElement("button");T[b]=!T[b];d.onclick=function(){T[b]=!T[b];1==T[b]?(d.innerHTML="ON",d.style["background-color"]="#23c552"):(d.innerHTML="OFF",d.style["background-color"]="#f84f31");Ta()};d.onclick();return d}
function Wa(b){let d=document.createElement("button");d.innerHTML=J[b];d.onclick=async function(){d.innerHTML="...";Ja=1;await new Promise(function(q){La=q});Ja=0;d.innerHTML=Ka;J[b]=Ka;Ua()};return d}
function Xa(b,d="",q=function(){}){let r=document.createElement("div");r.className="input";let h=document.createElement("input");h.type="range";h.min=T[b].min;h.max=T[b].max;h.step=T[b].step;h.value=T[b].value;h.oninput=function(){h.nextElementSibling.innerHTML=h.value+d;T[b].value=h.valueAsNumber;q()};h.onchange=Ta;r.appendChild(h);r.appendChild(X(h.value+d));return r}function Ya(b){let d=document.createElement("button");d.innerHTML="RESET";d.onclick=b;return d}
function Za(){G.innerHTML="";G.appendChild(Va("GENERAL"));let b=document.createElement("table");Y(b,X("Show chat"),Z("chat_on"));Y(b,X("Max number of chat messages"),Xa("max_chat_messages"));Y(b,X("Default FOV"),Xa("fov"));Y(b,X("Draw balls' fill"),Z("draw_ball_fill"));Y(b,X("Draw balls' stroke"),Z("draw_ball_stroke"));Y(b,X("Draw stroke-only balls with brighter color"),Z("draw_ball_stroke_bright"));Y(b,X("Balls' stroke radius percentage"),Xa("ball_stroke"," %"));Y(b,X("Draw players' fill"),Z("draw_player_fill"));
Y(b,X("Draw players' stroke"),Z("draw_player_stroke"));Y(b,X("Draw stroke-only players with brighter color"),Z("draw_player_stroke_bright"));Y(b,X("Players' stroke radius percentage"),Xa("player_stroke"," %"));Y(b,X("Draw players' name"),Z("draw_player_name"));Y(b,X("Draw an arrow towards dead players"),Z("draw_death_arrow"));Y(b,X("Death arrow size"),Xa("death_arrow_size","px",$a));G.appendChild(b);G.appendChild(Va("KEYBINDS"));b=document.createElement("table");Y(b,X("Settings"),Wa("settings"));
Y(b,X("Move up"),Wa("up"));Y(b,X("Move left"),Wa("left"));Y(b,X("Move down"),Wa("down"));Y(b,X("Move right"),Wa("right"));Y(b,X("Move slowly"),Wa("slowwalk"));G.appendChild(b);G.appendChild(Va("RESET"));b=document.createElement("table");Y(b,X("Reset settings"),Ya(function(){T=S;Ta();Za()}));Y(b,X("Reset keybinds"),Ya(function(){J=Ca;Ua();Za()}));G.appendChild(b)}Za();
function cb(b,d){let q=document.createElement("p");q.appendChild(document.createTextNode(b+": "+d));Oa.insertBefore(q,Oa.firstChild);++Qa>T.max_chat_messages.value&&Oa.removeChild(Oa.lastChild)}function $a(){u.width=u.height=T.death_arrow_size.value;let b=.5*u.width,d=u.width;v.beginPath();v.moveTo(b+.45*d,b);v.lineTo(b-.225*d,b-.675*d/Math.sqrt(3));v.lineTo(b-.225*d,b+.675*d/Math.sqrt(3));v.closePath();v.fillStyle="#bbbbbbb0";v.fill();v.lineWidth=.05*u.width;v.strokeStyle="#f00";v.stroke()}$a();
function Ra(b){if(0==b.length)c.innerHTML="No servers found",Sa();else{c.innerHTML="Connecting...";var d=b.map(function(q){q=new WebSocket(q[1]);q.binaryType="arraybuffer";q.i=[];q.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};q.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return q});setTimeout(function(){let q=999999,r=null;for(let h of d){h.h=0;for(let A of h.i)h.h+=A;0<h.i.length?h.h/=h.i.length:
h.h=999999;h.h<q&&(q=h.h,r=h)}for(let h of d)h.onopen=function(){},h.onmessage=function(){},delete h.i,delete h.time,delete h.h,h!=r&&h.close();null==r||1!=r.readyState?(c.innerHTML="Failed connecting",Sa()):db(r)},1E3)}}function eb(){ra=sa;ta=ua;for(let b of B)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2);for(let b of C)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2)}
function fb(b){return function(d){let q=d instanceof ClipboardEvent;if(q&&"paste"!=d.type)return!0;let r=d.target.value+(q?d.clipboardData.getData("text"):d.key);if((new TextEncoder).encode(r).byteLength>b){if(""==d.target.value&&q){const h=d.target.placeholder;d.target.placeholder="Text too long to paste!";setTimeout(function(){d.target.placeholder=h},1E3)}d.preventDefault();return!1}return!0}}
function db(b){c.innerHTML="Enter your name<br>";aa.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";e.style.display="block";e.focus();let d=window.localStorage.getItem("name");d&&(e.value=d);e.onkeypress=e.onpaste=fb(4);b.onclose=function(){window.onbeforeunload=function(){};g.parentElement.removeChild(g);Aa.parentElement.removeChild(Aa);Na.parentElement.removeChild(Na);c.innerHTML="Disconnected";aa.innerHTML="";e.style.display="none";
Sa()};window.onkeydown=function(q){if("Enter"==q.code){window.localStorage.setItem("name",e.value);c.innerHTML="Spawning...";aa.innerHTML="";e.style.display="none";q=(q=window.localStorage.getItem("token"))?q.split(",").map(h=>+h):[];let r=(new TextEncoder).encode(e.value);b.send(new Uint8Array([...r,...q]));gb(b)}}}
function gb(b){function d({data:a}){y.set(new Uint8Array(a));na=a.byteLength;a=y[0]|y[1]<<8|y[2]<<16|y[3]<<24;if(0!=va&&4!=a-va)throw b.onmessage=function(){},Error(`tick - last_tick = ${a-va}`);va=a;a=4;F[0]=F[1];F[1]=performance.now();eb();if(a!=na){if(0==y[a]){++a;xa=1;C=[];oa=y[a++];a+=2;Fa=y[a]|y[a+1]<<8;a+=2;Ga=y[a]|y[a+1]<<8;a+=2;Q=y[a++];R=Array(256);Ha=Array(256);for(var k=0;k<Fa;++k)for(var l=0;l<Ga;++l)null==R[y[a]]&&(R[y[a]]=new Path2D,Ha[y[a]]=new Path2D),R[y[a]].rect((1.5+k*Q)*T.fov.max,
(1.5+l*Q)*T.fov.max,(Q-3)*T.fov.max,(Q-3)*T.fov.max),Ha[y[a]].rect(k*Q*T.fov.max,l*Q*T.fov.max,Q*T.fov.max,Q*T.fov.max),++a;t.width=Q*Fa*T.fov.max;t.height=Q*Ga*T.fov.max;ca.width=Q*Fa*T.fov.max;ca.height=Q*Ga*T.fov.max;for(k=0;256>k;++k)R[k]&&(ba.fillStyle=fa[k]+"b0",ba.fill(Ha[k]),ba.fillStyle=fa[k],ba.fill(R[k]),da.fillStyle=fa[k],da.fill(Ha[k]));ea||(requestAnimationFrame(ab),ea=1)}if(a!=na){if(1==y[a])for(++a,k=y[a++],l=0;l<k;++l){var f=y[a++];if(B[f]){var m=y[a++];if(m)for(;m;){switch(m){case 1:B[f].g.x2=
z.getFloat32(a,!0);a+=4;oa==f&&(sa=B[f].g.x2);break;case 2:B[f].g.y2=z.getFloat32(a,!0);a+=4;oa==f&&(ua=B[f].g.y2);break;case 3:B[f].g.r2=z.getFloat32(a,!0);a+=4;break;case 4:B[f].j=y[a++];B[f].j&&(B[f].l=y[a++]);break;case 5:m=y[a++],cb(B[f].name,(new TextDecoder).decode(y.subarray(a,a+m))),a+=m}m=y[a++]}else B[f]=void 0}else{m=z.getFloat32(a,!0);a+=4;var p=z.getFloat32(a,!0);a+=4;var x=z.getFloat32(a,!0);a+=4;var ha=y[a++],ia=(new TextDecoder).decode(y.subarray(a,a+ha));a+=ha;ha=y[a++];let bb=0;
ha&&(bb=y[a++]);let Ma=y[a++];0<Ma&&(cb(ia,(new TextDecoder).decode(y.subarray(a,a+Ma))),a+=Ma);B[f]={x:0,y:0,r:0,g:{x1:m,x2:m,y1:p,y2:p,r1:x,r2:x},name:ia,j:ha,l:bb};oa==f&&(sa=m,ua=p)}}if(a!=na){if(2==y[a])for(++a,k=y[a]|y[a+1]<<8,a+=2,l=0;l<k;++l)if(f=y[a]|y[a+1]<<8,a+=2,C[f])if(m=y[a++])for(;m;){switch(m){case 1:C[f].g.x2=z.getFloat32(a,!0);a+=4;break;case 2:C[f].g.y2=z.getFloat32(a,!0);a+=4;break;case 3:C[f].g.r2=z.getFloat32(a,!0);if(1>C[f].g.r2||60<C[f].g.r2)throw console.log(`update ball id ${f} r ${C[f].g.r2}`),
b.onmessage=function(){},Error();a+=4}m=y[a++]}else C[f]=void 0;else if(m=y[a++],0!=m&&(--m,p=z.getFloat32(a,!0),a+=4,x=z.getFloat32(a,!0),a+=4,ia=z.getFloat32(a,!0),a+=4,C[f]={type:m,x:0,y:0,r:0,g:{x1:p,x2:p,y1:x,y2:x,r1:ia,r2:ia}},1>C[f].g.r2||60<C[f].g.r2))throw console.log(`create ball id ${f} r ${C[f].g.r2}`),b.onmessage=function(){},Error();if(a!=na&&3==y[a])for(++a,k=y[a++],l=0;l<k;++l)m=y[a++],f=(new TextDecoder).decode(y.subarray(a,a+m)),a+=m,m=y[a++],cb(f,(new TextDecoder).decode(y.subarray(a,
a+m))),a+=m}}}}function q(){if(window.innerWidth!=ka||window.innerHeight!=la||w!=window.devicePixelRatio)w=window.devicePixelRatio,ka=window.innerWidth,g.width=ka*w,la=window.innerHeight,g.height=la*w}function r(a,k,l){return a+(k-a)*l}function h(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function A(){Ea||(0==N-K&&
0==M-L?P=Da=0:(Da=Math.atan2(N-K,M-L),P=160*w));H?b.send(new Uint8Array([0,0,0,0,0,0])):(y[0]=0,z.setFloat32(1,Da,!0),P>=160*w?z.setUint8(5,255*O>>>0):z.setUint8(5,1.59375*P/w*O>>>0),b.send(y.subarray(0,6)))}function ab(a){if(0!=F[0]){T.chat_on==!Pa&&(Pa=T.chat_on,Na.style.display=Pa?"block":"none");E?E<F[0]?E=F[0]:E>F[1]&&(E=F[1]):E=F[0];var k=U;U=r(U,V,.1);U!=k&&(P=Math.hypot(D[0]-.5*g.width,D[1]-.5*g.height)/U,A());k=F[0]==F[1]?0:(E-F[0])/(F[1]-F[0]);E+=a-wa;wa=a;pa=r(ra,sa,k);qa=r(ta,ua,k);n.resetTransform();
n.fillStyle="#333";n.fillRect(0,0,g.width,g.height);n.translate(.5*g.width,.5*g.height);n.scale(U,U);n.translate(-pa,-qa);n.drawImage(t,0,0,t.width/T.fov.max,t.height/T.fov.max);1>U&&(n.globalAlpha=1-U*U,n.drawImage(ca,0,0,t.width/T.fov.max,t.height/T.fov.max),n.globalAlpha=1);a=[];if(T.draw_player_fill||T.draw_player_stroke)for(var l of B)l&&(l.x=r(l.g.x1,l.g.x2,k),l.y=r(l.g.y1,l.g.y2,k),l.r=r(l.g.r1,l.g.r2,k),a[a.length]={o:l});if(T.draw_ball_fill||T.draw_ball_stroke)for(var f of C)f&&(f.x=r(f.g.x1,
f.g.x2,k),f.y=r(f.g.y1,f.g.y2,k),f.r=r(f.g.r1,f.g.r2,k),a[a.length]={m:f});a.sort((m,p)=>m.r-p.r);for(let {m,o:p}of a)if(n.beginPath(),p){if(l=T.player_stroke.value/200*p.r,n.moveTo(p.x+p.r-l,p.y),n.arc(p.x,p.y,p.r-l,0,2*Math.PI),T.draw_player_fill&&(n.fillStyle="#ebecf0",n.fill()),T.draw_player_stroke&&(!T.draw_player_fill&&T.draw_player_stroke_bright?n.strokeStyle="#ebecf0":n.strokeStyle=h("#ebecf0"),n.lineWidth=2*l,n.stroke()),T.draw_player_name&&0!=p.name.length&&(n.font=`700 ${p.r/U}px Ubuntu`,
n.textAlign="center",n.textBaseline="middle",n.fillStyle="#00000080",za=1<U?.5*p.r:.5*p.r+2/(U*U),ya=r(ya,za,.1),n.fillText(p.name,p.x,p.y-p.r-ya)),p.j&&(n.font=`700 ${p.r/Math.min(U,1)}px Ubuntu`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#f00",n.fillText(p.l,p.x,p.y),T.draw_death_arrow)){a=.5*g.width+(p.x-pa)*U;k=.5*g.height+(p.y-qa)*U;let x=.75*u.width*U;if(0>a||a>g.width||0>k||k>g.height)f=Math.max(Math.min(a,g.width-x),x),l=Math.max(Math.min(k,g.height-x),x),a=(a<x||a>g.width-
x)&&(k<x||k>g.height-x)?Math.atan2(k-l,a-f):Math.atan2(k<x?-1:k>g.height-x?1:0,a<x?-1:a>g.width-x?1:0),f=(f-.5*g.width)/U+pa,l=(l-.5*g.height)/U+qa,n.translate(f,l),n.rotate(a),n.drawImage(u,.5*-u.width,.5*-u.width),n.rotate(-a),n.font=`700 ${.3*u.width}px Ubuntu`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#f00",n.fillText(p.l,0,0),n.translate(-f,-l)}}else l=T.ball_stroke.value/200*m.r,n.moveTo(m.x+m.r-l,m.y),n.arc(m.x,m.y,m.r-l,0,2*Math.PI),T.draw_ball_fill&&(n.fillStyle=ja[m.type],
n.fill()),T.draw_ball_stroke&&(n.strokeStyle=!T.draw_ball_fill&&T.draw_ball_stroke_bright?ja[m.type]:h(ja[m.type]),n.lineWidth=2*l,n.stroke())}requestAnimationFrame(ab)}Pa=!T.chat_on;let va=0;b.onmessage=function(a){xa=0;d(a);xa&&(c.innerHTML="",eb())};W.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=(new TextEncoder).encode(W.value.trim());if(0<a.length){y[0]=1;y[1]=a.length;y.set(a,2);b.send(y.subarray(0,y[1]+2));I.pop();I.unshift((new Date).getTime());a=Math.abs(I[I.length-1]-
I[0]);const k=1E3*I.length;if(a<k){const l=W.placeholder;W.placeholder="You are on cooldown";W.disabled=1;setTimeout(function(){W.disabled=0;W.placeholder=l},k-a)}}W.value="";W.u="";W.blur();g.focus()}};W.onkeyup=function(a){a.stopPropagation()};W.onkeypress=W.onpaste=fb(128);q();window.onresize=q;g.onwheel=function(a){a=.05*-Math.sign(a.deltaY);V=1<V?V+3*a:V+a;V=Math.min(Math.max(V,T.fov.min),T.fov.max)};window.onmousemove=function(a){D=[a.clientX*w,a.clientY*w];Da=Math.atan2(D[1]-.5*g.height,D[0]-
.5*g.width);P=Math.hypot(D[0]-.5*g.width,D[1]-.5*g.height)/U;A()};g.onmousedown=function(){Ea=!Ea;Da=Math.atan2(D[1]-.5*g.height,D[0]-.5*g.width);P=Math.hypot(D[0]-.5*g.width,D[1]-.5*g.height)/U;A()};window.onkeydown=function(a){if(!a.repeat)if(H)Ja?(a.preventDefault(),Ka=a.code,La()):a.code==J.settings&&(H=!1,Aa.style.display="none");else switch(a.code){case "Enter":W.focus();a.preventDefault();break;case J.slowwalk:1==O&&(O=.5,A());break;case J.up:K||(K=1,A());break;case J.left:L||(L=1,A());break;
case J.right:M||(M=1,A());break;case J.down:N||(N=1,A());break;case J.settings:H=!H,Aa.style.display=H?"block":"none"}};window.onkeyup=function(a){if(!a.repeat&&!H)switch(a.code){case J.slowwalk:.5==O&&(O=1,A());break;case J.up:K&&(K=0,A());break;case J.left:L&&(L=0,A());break;case J.right:M&&(M=0,A());break;case J.down:N&&(N=0,A())}};window.onbeforeunload=function(a){a.preventDefault();a.returnValue="Are you sure you want to quit?";window.localStorage.setItem("settings",JSON.stringify(T));return"Are you sure you want to quit?"};
g.oncontextmenu=function(a){a.preventDefault();return!1}};
