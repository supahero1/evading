const c=document.getElementById.bind(document),e=document.createElement.bind(document),g=window.localStorage;let n=c("loading");n.innerHTML="Fetching servers...";
let aa=c("sub"),t=c("name"),u=c("canvas"),v=u.getContext("2d"),w=e("canvas"),ba=w.getContext("2d"),ca=e("canvas"),da=ca.getContext("2d"),x=e("canvas"),y=x.getContext("2d"),ea=0,fa=["#dddddd","#aaaaaa","#333333","#fedf78"],ha="#808080 #fc46aa #008080 #ff8e06 #3cdfff #663a82".split(" "),ia=0,ja=0,A=0,ka=new ArrayBuffer(1048576),B=new Uint8Array(ka),D=new DataView(B.buffer),na=0,oa=0,E=[],F=[];var pa=0,qa=0,ra=0,sa=0,ta=0,ua=0;
let G=[0,0],H=null,va=0,I=[0,0],wa=0,xa=0,ya=0,Aa=c("settings"),Ba=c("ss"),J=!1,K=Array(5).fill(0),Ca=g.getItem("keybinds"),Da={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft"},L=null!=Ca?JSON.parse(Ca):Da;for(let b in Da)void 0==L[b]&&(L[b]=Da[b]);for(let b in L)void 0==Da[b]&&delete L[b];var M=0,N=0,Ea=0,Fa=0,Ga=1,Ha=0,Ia=0,O=0,Ja=0,Ka=0,P=0,La=[],Ma=[];
let Na=g.getItem("settings"),Q={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},chat_text_scale:{min:1,max:2,value:1,step:.05},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!1,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!1,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1}},
R=null!=Na?JSON.parse(Na):JSON.parse(JSON.stringify(Q));for(let b in Q)void 0==R[b]&&(R[b]=Q[b]);for(let b in R)void 0==Q[b]&&delete R[b],R[b].min&&R[b].min!=Q[b].min&&(R[b].min=Q[b].min),R[b].max&&R[b].max!=Q[b].max&&(R[b].max=Q[b].max),R[b].value=Math.max(Math.min(R[b].value,R[b].max),R[b].min);g.setItem("settings",JSON.stringify(R));let Oa=!1,Pa="",Qa,S=R.fov.value,T=S,Sa=c("chat"),U=c("messages"),V=c("sendmsg"),Ta=R.chat_on,Ua=0;window.s.then(b=>b.json()).then(b=>Va(b));
function Wa(){setTimeout(location.reload.bind(location),1E3)}function Xa(){g.setItem("settings",JSON.stringify(R))}function Ya(){g.setItem("keybinds",JSON.stringify(L))}function W(b){Ba.appendChild(b)}function Za(b){let d=e("h1");d.innerHTML=b;return d}function X(b){let d=e("h3");d.innerHTML=b;return d}function $a(){let b=e("h5");b.innerHTML="To change, click a button on the right side and then press the key you want to asign to it.";return b}
function Y(b,d,q){let r=e("tr"),h=e("td");h.appendChild(d);r.appendChild(h);h=e("td");h.appendChild(q);r.appendChild(h);b.appendChild(r)}function Z(b){let d=e("button");R[b]=!R[b];d.onclick=function(){R[b]=!R[b];1==R[b]?(d.innerHTML="ON",d.style["background-color"]="#23c552"):(d.innerHTML="OFF",d.style["background-color"]="#f84f31");Xa()};d.onclick();return d}
function ab(b){let d=e("button");d.innerHTML=L[b];d.onclick=async function(){d.innerHTML="...";Oa=1;await new Promise(function(q){Qa=q});Oa=0;d.innerHTML=Pa;L[b]=Pa;Ya()};return d}
function bb(b,d="",q=function(){}){let r=e("div");r.className="input";let h=e("input");h.type="range";h.min=R[b].min;h.max=R[b].max;h.step=R[b].step;h.value=R[b].value;h.oninput=function(){h.nextElementSibling.innerHTML=h.value+d;R[b].value=h.valueAsNumber;q()};h.onchange=Xa;r.appendChild(h);r.appendChild(X(h.value+d));return r}function cb(b){let d=e("button");d.innerHTML="RESET";d.onclick=b;return d}
function db(){Ba.innerHTML="";W(Za("CHAT"));let b=e("table");Y(b,X("Show chat"),Z("chat_on"));Y(b,X("Max number of chat messages"),bb("max_chat_messages","",function(){for(;Ua>R.max_chat_messages.value;)U.removeChild(U.lastChild),--Ua}));Y(b,X("Chat text scale"),bb("chat_text_scale","",function(){U.style["font-size"]=R.chat_text_scale.value+"em"}));W(b);W(Za("VISUALS"));b=e("table");Y(b,X("Default FOV"),bb("fov"));Y(b,X("Draw balls' fill"),Z("draw_ball_fill"));Y(b,X("Draw balls' stroke"),Z("draw_ball_stroke"));
Y(b,X("Draw stroke-only balls with brighter color"),Z("draw_ball_stroke_bright"));Y(b,X("Balls' stroke radius percentage"),bb("ball_stroke"," %"));Y(b,X("Draw players' fill"),Z("draw_player_fill"));Y(b,X("Draw players' stroke"),Z("draw_player_stroke"));Y(b,X("Draw stroke-only players with brighter color"),Z("draw_player_stroke_bright"));Y(b,X("Players' stroke radius percentage"),bb("player_stroke"," %"));Y(b,X("Draw players' name"),Z("draw_player_name"));Y(b,X("Draw an arrow towards dead players"),
Z("draw_death_arrow"));Y(b,X("Death arrow size"),bb("death_arrow_size","px",eb));W(b);W(Za("KEYBINDS"));W($a());b=e("table");Y(b,X("Settings"),ab("settings"));Y(b,X("Move up"),ab("up"));Y(b,X("Move left"),ab("left"));Y(b,X("Move down"),ab("down"));Y(b,X("Move right"),ab("right"));Y(b,X("Move slowly"),ab("slowwalk"));W(b);W(Za("RESET"));b=e("table");Y(b,X("Reset settings"),cb(function(){R=Q;Xa();db()}));Y(b,X("Reset keybinds"),cb(function(){L=Da;Ya();db()}));W(b)}db();
function hb(b,d){let q=e("p");q.appendChild(document.createTextNode(b+": "+d));U.insertBefore(q,U.firstChild);++Ua>R.max_chat_messages.value&&U.removeChild(U.lastChild)}function eb(){x.width=x.height=R.death_arrow_size.value;let b=.5*x.width,d=x.width;y.beginPath();y.moveTo(b+.45*d,b);y.lineTo(b-.225*d,b-.675*d/Math.sqrt(3));y.lineTo(b-.225*d,b+.675*d/Math.sqrt(3));y.closePath();y.fillStyle="#bbbbbbb0";y.fill();y.lineWidth=.05*x.width;y.strokeStyle="#f00";y.stroke()}eb();
function Va(b){if(0==b.length)n.innerHTML="No servers found",Wa();else{n.innerHTML="Connecting...";var d=b.map(function(q){q=new WebSocket(q[1]);q.binaryType="arraybuffer";q.i=[];q.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};q.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return q});setTimeout(function(){let q=999999,r=null;for(let h of d){h.h=0;for(let C of h.i)h.h+=C;0<h.i.length?h.h/=h.i.length:
h.h=999999;h.h<q&&(q=h.h,r=h)}for(let h of d)h.onopen=function(){},h.onmessage=function(){},delete h.i,delete h.time,delete h.h,h!=r&&h.close();null==r||1!=r.readyState?(n.innerHTML="Failed connecting",Wa()):ib(r)},1E3)}}function jb(){ra=sa;ta=ua;for(let b of E)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2);for(let b of F)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2)}
function kb(b){return function(d){let q=d instanceof ClipboardEvent;if(q&&"paste"!=d.type)return!0;let r=d.target.value+(q?d.clipboardData.getData("text"):d.key);if((new TextEncoder).encode(r).byteLength>b){if(""==d.target.value&&q){const h=d.target.placeholder;d.target.placeholder="Text too long to paste!";setTimeout(function(){d.target.placeholder=h},1E3)}d.preventDefault();return!1}return!0}}
function ib(b){n.innerHTML="Enter your name<br>";aa.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";t.style.display="block";t.focus();let d=g.getItem("name");d&&(t.value=d);t.onkeypress=t.onpaste=kb(4);b.onclose=function(){window.onbeforeunload=function(){};u.parentElement.removeChild(u);Aa.parentElement.removeChild(Aa);Sa.parentElement.removeChild(Sa);n.innerHTML="Disconnected";aa.innerHTML="";t.style.display="none";Wa()};window.onkeydown=
function(q){if("Enter"==q.code){g.setItem("name",t.value);n.innerHTML="Spawning...";aa.innerHTML="";t.style.display="none";q=(q=g.getItem("token"))?q.split(",").map(h=>+h):[];let r=(new TextEncoder).encode(t.value);b.send(new Uint8Array([...r,...q]));lb(b)}}}
function lb(b){function d({data:a}){B.set(new Uint8Array(a));na=a.byteLength;a=B[0]|B[1]<<8|B[2]<<16|B[3]<<24;if(0!=za&&4!=a-za)throw b.onmessage=function(){},Error(`tick - last_tick = ${a-za}`);za=a;a=4;I[0]=I[1];I[1]=performance.now();jb();if(a!=na){if(0==B[a]){++a;wa=1;F=[];oa=B[a++];a+=2;Ja=B[a]|B[a+1]<<8;a+=2;Ka=B[a]|B[a+1]<<8;a+=2;P=B[a++];La=Array(256);Ma=Array(256);for(var k=0;k<Ja;++k)for(var l=0;l<Ka;++l)null==La[B[a]]&&(La[B[a]]=new Path2D,Ma[B[a]]=new Path2D),La[B[a]].rect((1.5+k*P)*R.fov.max,
(1.5+l*P)*R.fov.max,(P-3)*R.fov.max,(P-3)*R.fov.max),Ma[B[a]].rect(k*P*R.fov.max,l*P*R.fov.max,P*R.fov.max,P*R.fov.max),++a;w.width=P*Ja*R.fov.max;w.height=P*Ka*R.fov.max;ca.width=P*Ja*R.fov.max;ca.height=P*Ka*R.fov.max;for(k=0;256>k;++k)La[k]&&(ba.fillStyle=fa[k]+"b0",ba.fill(Ma[k]),ba.fillStyle=fa[k],ba.fill(La[k]),da.fillStyle=fa[k],da.fill(Ma[k]));ea||(requestAnimationFrame(fb),ea=1)}if(a!=na){if(1==B[a])for(++a,k=B[a++],l=0;l<k;++l){var f=B[a++];if(E[f]){var m=B[a++];if(m)for(;m;){switch(m){case 1:E[f].g.x2=
D.getFloat32(a,!0);a+=4;oa==f&&(sa=E[f].g.x2);break;case 2:E[f].g.y2=D.getFloat32(a,!0);a+=4;oa==f&&(ua=E[f].g.y2);break;case 3:E[f].g.r2=D.getFloat32(a,!0);a+=4;break;case 4:E[f].j=B[a++];E[f].j&&(E[f].l=B[a++]);break;case 5:m=B[a++],hb(E[f].name,(new TextDecoder).decode(B.subarray(a,a+m))),a+=m}m=B[a++]}else E[f]=void 0}else{m=D.getFloat32(a,!0);a+=4;var p=D.getFloat32(a,!0);a+=4;var z=D.getFloat32(a,!0);a+=4;var la=B[a++],ma=(new TextDecoder).decode(B.subarray(a,a+la));a+=la;la=B[a++];let gb=0;
la&&(gb=B[a++]);let Ra=B[a++];0<Ra&&(hb(ma,(new TextDecoder).decode(B.subarray(a,a+Ra))),a+=Ra);E[f]={x:0,y:0,r:0,g:{x1:m,x2:m,y1:p,y2:p,r1:z,r2:z},name:ma,j:la,l:gb};oa==f&&(sa=m,ua=p)}}if(a!=na){if(2==B[a])for(++a,k=B[a]|B[a+1]<<8,a+=2,l=0;l<k;++l)if(f=B[a]|B[a+1]<<8,a+=2,F[f])if(m=B[a++])for(;m;){switch(m){case 1:F[f].g.x2=D.getFloat32(a,!0);a+=4;break;case 2:F[f].g.y2=D.getFloat32(a,!0);a+=4;break;case 3:F[f].g.r2=D.getFloat32(a,!0);if(1>F[f].g.r2||60<F[f].g.r2)throw console.log(`update ball id ${f} r ${F[f].g.r2}`),
b.onmessage=function(){},Error();a+=4}m=B[a++]}else F[f]=void 0;else if(m=B[a++],0!=m&&(--m,p=D.getFloat32(a,!0),a+=4,z=D.getFloat32(a,!0),a+=4,ma=D.getFloat32(a,!0),a+=4,F[f]={type:m,x:0,y:0,r:0,g:{x1:p,x2:p,y1:z,y2:z,r1:ma,r2:ma}},1>F[f].g.r2||60<F[f].g.r2))throw console.log(`create ball id ${f} r ${F[f].g.r2}`),b.onmessage=function(){},Error();if(a!=na&&3==B[a])for(++a,k=B[a++],l=0;l<k;++l)m=B[a++],f=(new TextDecoder).decode(B.subarray(a,a+m)),a+=m,m=B[a++],hb(f,(new TextDecoder).decode(B.subarray(a,
a+m))),a+=m}}}}function q(){if(window.innerWidth!=ia||window.innerHeight!=ja||A!=window.devicePixelRatio)A=window.devicePixelRatio,ia=window.innerWidth,u.width=ia*A,ja=window.innerHeight,u.height=ja*A}function r(a,k,l){return a+(k-a)*l}function h(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function C(){Ia||(0==Fa-M&&
0==Ea-N?O=Ha=0:(Ha=Math.atan2(Fa-M,Ea-N),O=160*A));J?b.send(new Uint8Array([0,0,0,0,0,0])):(B[0]=0,D.setFloat32(1,Ha,!0),O>=160*A?D.setUint8(5,255*Ga>>>0):D.setUint8(5,1.59375*O/A*Ga>>>0),b.send(B.subarray(0,6)))}function fb(a){if(0!=I[0]){R.chat_on==!Ta&&(Ta=R.chat_on,Sa.style.display=Ta?"block":"none");H?H<I[0]?H=I[0]:H>I[1]&&(H=I[1]):H=I[0];var k=S;S=r(S,T,.1);S!=k&&(O=Math.hypot(G[0]-.5*u.width,G[1]-.5*u.height)/S,C());k=I[0]==I[1]?0:(H-I[0])/(I[1]-I[0]);H+=a-va;va=a;pa=r(ra,sa,k);qa=r(ta,ua,
k);v.resetTransform();v.fillStyle="#333";v.fillRect(0,0,u.width,u.height);v.translate(.5*u.width,.5*u.height);v.scale(S,S);v.translate(-pa,-qa);v.drawImage(w,0,0,w.width/R.fov.max,w.height/R.fov.max);1>S&&(v.globalAlpha=1-S*S,v.drawImage(ca,0,0,w.width/R.fov.max,w.height/R.fov.max),v.globalAlpha=1);a=[];if(R.draw_player_fill||R.draw_player_stroke)for(var l of E)l&&(l.x=r(l.g.x1,l.g.x2,k),l.y=r(l.g.y1,l.g.y2,k),l.r=r(l.g.r1,l.g.r2,k),a[a.length]={u:l});if(R.draw_ball_fill||R.draw_ball_stroke)for(var f of F)f&&
(f.x=r(f.g.x1,f.g.x2,k),f.y=r(f.g.y1,f.g.y2,k),f.r=r(f.g.r1,f.g.r2,k),a[a.length]={o:f});a.sort((m,p)=>m.r-p.r);for(let {o:m,u:p}of a)if(v.beginPath(),p){if(l=R.player_stroke.value/200*p.r,v.moveTo(p.x+p.r-l,p.y),v.arc(p.x,p.y,p.r-l,0,2*Math.PI),R.draw_player_fill&&(v.fillStyle="#ebecf0",v.fill()),R.draw_player_stroke&&(!R.draw_player_fill&&R.draw_player_stroke_bright?v.strokeStyle="#ebecf0":v.strokeStyle=h("#ebecf0"),v.lineWidth=2*l,v.stroke()),R.draw_player_name&&0!=p.name.length&&(v.font=`700 ${p.r/
S}px Ubuntu`,v.textAlign="center",v.textBaseline="middle",v.fillStyle="#00000080",ya=1<S?.5*p.r:.5*p.r+2/(S*S),xa=r(xa,ya,.1),v.fillText(p.name,p.x,p.y-p.r-xa)),p.j&&(v.font=`700 ${p.r/Math.min(S,1)}px Ubuntu`,v.textAlign="center",v.textBaseline="middle",v.fillStyle="#f00",v.fillText(p.l,p.x,p.y),R.draw_death_arrow)){a=.5*u.width+(p.x-pa)*S;k=.5*u.height+(p.y-qa)*S;let z=.75*x.width*S;if(0>a||a>u.width||0>k||k>u.height)f=Math.max(Math.min(a,u.width-z),z),l=Math.max(Math.min(k,u.height-z),z),a=(a<
z||a>u.width-z)&&(k<z||k>u.height-z)?Math.atan2(k-l,a-f):Math.atan2(k<z?-1:k>u.height-z?1:0,a<z?-1:a>u.width-z?1:0),f=(f-.5*u.width)/S+pa,l=(l-.5*u.height)/S+qa,v.translate(f,l),v.rotate(a),v.drawImage(x,.5*-x.width,.5*-x.width),v.rotate(-a),v.font=`700 ${.3*x.width}px Ubuntu`,v.textAlign="center",v.textBaseline="middle",v.fillStyle="#f00",v.fillText(p.l,0,0),v.translate(-f,-l)}}else l=R.ball_stroke.value/200*m.r,v.moveTo(m.x+m.r-l,m.y),v.arc(m.x,m.y,m.r-l,0,2*Math.PI),R.draw_ball_fill&&(v.fillStyle=
ha[m.type],v.fill()),R.draw_ball_stroke&&(v.strokeStyle=!R.draw_ball_fill&&R.draw_ball_stroke_bright?ha[m.type]:h(ha[m.type]),v.lineWidth=2*l,v.stroke())}requestAnimationFrame(fb)}Ta=!R.chat_on;let za=0;b.onmessage=function(a){wa=0;d(a);wa&&(n.innerHTML="",jb())};V.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=(new TextEncoder).encode(V.value.trim());if(0<a.length){B[0]=1;B[1]=a.length;B.set(a,2);b.send(B.subarray(0,B[1]+2));K.pop();K.unshift((new Date).getTime());a=Math.abs(K[K.length-
1]-K[0]);const k=1E3*K.length;if(a<k){const l=V.placeholder;V.placeholder="You are on cooldown for sending too many messages too fast";V.m=1;V.onkeypress=V.onpaste=null;setTimeout(function(){V.onkeypress=V.onpaste=kb(128);V.m=0;V.placeholder=l},k-a)}}V.value="";V.blur();u.focus()}};V.onkeyup=function(a){a.stopPropagation()};V.onkeypress=V.onpaste=kb(128);q();window.onresize=q;u.onwheel=function(a){a=.05*-Math.sign(a.deltaY);T=1<T?T+3*a:T+a;T=Math.min(Math.max(T,R.fov.min),R.fov.max)};window.onmousemove=
function(a){G=[a.clientX*A,a.clientY*A];Ha=Math.atan2(G[1]-.5*u.height,G[0]-.5*u.width);O=Math.hypot(G[0]-.5*u.width,G[1]-.5*u.height)/S;C()};u.onmousedown=function(){Ia=!Ia;Ha=Math.atan2(G[1]-.5*u.height,G[0]-.5*u.width);O=Math.hypot(G[0]-.5*u.width,G[1]-.5*u.height)/S;C()};window.onkeydown=function(a){if(!a.repeat)if(J)Oa?(a.preventDefault(),Pa=a.code,Qa()):a.code==L.settings&&(J=!1,Aa.style.display="none");else switch(a.code){case "Enter":V.m||V.focus();a.preventDefault();break;case L.slowwalk:1==
Ga&&(Ga=.5,C());break;case L.up:M||(M=1,C());break;case L.left:N||(N=1,C());break;case L.right:Ea||(Ea=1,C());break;case L.down:Fa||(Fa=1,C());break;case L.settings:J=!J,Aa.style.display=J?"block":"none"}};window.onkeyup=function(a){if(!a.repeat&&!J)switch(a.code){case L.slowwalk:.5==Ga&&(Ga=1,C());break;case L.up:M&&(M=0,C());break;case L.left:N&&(N=0,C());break;case L.right:Ea&&(Ea=0,C());break;case L.down:Fa&&(Fa=0,C())}};window.onbeforeunload=function(a){a.preventDefault();a.returnValue="Are you sure you want to quit?";
g.setItem("settings",JSON.stringify(R));return"Are you sure you want to quit?"};u.oncontextmenu=function(a){a.preventDefault();return!1}};
