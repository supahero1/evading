let c=document.getElementById("loading");c.innerHTML="Fetching servers...";
let aa=document.getElementById("sub"),e=document.getElementById("name"),g=document.getElementById("canvas"),n=g.getContext("2d"),t=document.createElement("canvas"),ba=t.getContext("2d"),ca=document.createElement("canvas"),da=ca.getContext("2d"),u=document.createElement("canvas"),v=u.getContext("2d"),ea=0,fa=["#dddddd","#aaaaaa","#333333","#fedf78"],ja=["#808080","#fc46aa","#008080","#ff8e06","#3cdfff"],ka=0,la=0,w=0,ma=new ArrayBuffer(1048576),y=new Uint8Array(ma),z=new DataView(y.buffer),na=0,oa=
0,B=[],C=[];var pa=0,qa=0,ra=0,sa=0,ta=0,va=0;let D=[0,0],E=null,wa=0,F=[0,0],xa=0,ya=0,za=0,Aa=document.getElementById("settings"),G=document.getElementById("ss"),H=!1,Ba=window.localStorage.getItem("keybinds"),Ca={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft"},I=null!=Ba?JSON.parse(Ba):Ca;for(let b in Ca)void 0==I[b]&&(I[b]=Ca[b]);for(let b in I)void 0==Ca[b]&&delete I[b];var J=0,K=0,L=0,M=0,N=1,Da=0,Ea=0,O=0,Fa=0,Ga=0,P=0,Q=[],Ha=[];
let Ia=window.localStorage.getItem("settings"),R={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!1,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!1,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1}},S=null!=Ia?JSON.parse(Ia):JSON.parse(JSON.stringify(R));
for(let b in R)void 0==S[b]&&(S[b]=R[b]);for(let b in S)void 0==R[b]&&delete S[b],S[b].min&&S[b].min!=R[b].min&&(S[b].min=R[b].min),S[b].max&&S[b].max!=R[b].max&&(S[b].max=R[b].max),S[b].value=Math.max(Math.min(S[b].value,S[b].max),S[b].min);window.localStorage.setItem("settings",JSON.stringify(S));let Ja=!1,Ka="",Ma,T=S.fov.value,U=T,Na=document.getElementById("chat"),Oa=document.getElementById("messages"),V=document.getElementById("sendmsg"),Pa=S.chat_on,Qa=0;
window.s.then(b=>b.json()).then(b=>Ra(b));function Sa(){setTimeout(location.reload.bind(location),1E3)}function Ta(){window.localStorage.setItem("settings",JSON.stringify(S))}function Ua(){window.localStorage.setItem("keybinds",JSON.stringify(I))}function Va(b){let d=document.createElement("h1");d.innerHTML=b;return d}function W(b){let d=document.createElement("h3");d.innerHTML=b;return d}
function X(b,d,p){let r=document.createElement("tr"),h=document.createElement("td");h.appendChild(d);r.appendChild(h);h=document.createElement("td");h.appendChild(p);r.appendChild(h);b.appendChild(r)}function Y(b){let d=document.createElement("button");S[b]=!S[b];d.onclick=function(){S[b]=!S[b];1==S[b]?(d.innerHTML="ON",d.style["background-color"]="#23c552"):(d.innerHTML="OFF",d.style["background-color"]="#f84f31");Ta()};d.onclick();return d}
function Z(b){let d=document.createElement("button");d.innerHTML=I[b];d.onclick=async function(){d.innerHTML="...";Ja=1;await new Promise(function(p){Ma=p});Ja=0;d.innerHTML=Ka;I[b]=Ka;Ua()};return d}
function Wa(b,d="",p=function(){}){let r=document.createElement("div");r.className="input";let h=document.createElement("input");h.type="range";h.min=S[b].min;h.max=S[b].max;h.step=S[b].step;h.value=S[b].value;h.oninput=function(){h.nextElementSibling.innerHTML=h.value+d;S[b].value=h.valueAsNumber;p()};h.onchange=Ta;r.appendChild(h);r.appendChild(W(h.value+d));return r}function Xa(b){let d=document.createElement("button");d.innerHTML="RESET";d.onclick=b;return d}
function Ya(){G.innerHTML="";G.appendChild(Va("GENERAL"));let b=document.createElement("table");X(b,W("Show chat"),Y("chat_on"));X(b,W("Max number of chat messages"),Wa("max_chat_messages"));X(b,W("Default FOV"),Wa("fov"));X(b,W("Draw balls' fill"),Y("draw_ball_fill"));X(b,W("Draw balls' stroke"),Y("draw_ball_stroke"));X(b,W("Draw stroke-only balls with brighter color"),Y("draw_ball_stroke_bright"));X(b,W("Balls' stroke radius percentage"),Wa("ball_stroke"," %"));X(b,W("Draw players' fill"),Y("draw_player_fill"));
X(b,W("Draw players' stroke"),Y("draw_player_stroke"));X(b,W("Draw stroke-only players with brighter color"),Y("draw_player_stroke_bright"));X(b,W("Players' stroke radius percentage"),Wa("player_stroke"," %"));X(b,W("Draw players' name"),Y("draw_player_name"));X(b,W("Draw an arrow towards dead players"),Y("draw_death_arrow"));X(b,W("Death arrow size"),Wa("death_arrow_size","px",Za));G.appendChild(b);G.appendChild(Va("KEYBINDS"));b=document.createElement("table");X(b,W("Settings"),Z("settings"));X(b,
W("Move up"),Z("up"));X(b,W("Move left"),Z("left"));X(b,W("Move down"),Z("down"));X(b,W("Move right"),Z("right"));X(b,W("Move slowly"),Z("slowwalk"));G.appendChild(b);G.appendChild(Va("RESET"));b=document.createElement("table");X(b,W("Reset settings"),Xa(function(){S=R;Ta();Ya()}));X(b,W("Reset keybinds"),Xa(function(){I=Ca;Ua();Ya()}));G.appendChild(b)}Ya();
function bb(b,d){let p=document.createElement("p");p.appendChild(document.createTextNode(b+": "+d));Oa.insertBefore(p,Oa.firstChild);++Qa>S.max_chat_messages.value&&Oa.removeChild(Oa.lastChild)}function Za(){u.width=u.height=S.death_arrow_size.value;let b=.5*u.width,d=u.width;v.beginPath();v.moveTo(b+.45*d,b);v.lineTo(b-.225*d,b-.675*d/Math.sqrt(3));v.lineTo(b-.225*d,b+.675*d/Math.sqrt(3));v.closePath();v.fillStyle="#bbbbbbb0";v.fill();v.lineWidth=.05*u.width;v.strokeStyle="#f00";v.stroke()}Za();
function Ra(b){if(0==b.length)c.innerHTML="No servers found",Sa();else{c.innerHTML="Connecting...";var d=b.map(function(p){p=new WebSocket(p[1]);p.binaryType="arraybuffer";p.i=[];p.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};p.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return p});setTimeout(function(){let p=999999,r=null;for(let h of d){h.h=0;for(let A of h.i)h.h+=A;0<h.i.length?h.h/=h.i.length:
h.h=999999;h.h<p&&(p=h.h,r=h)}for(let h of d)h.onopen=function(){},h.onmessage=function(){},delete h.i,delete h.time,delete h.h,h!=r&&h.close();null==r||1!=r.readyState?(c.innerHTML="Failed connecting",Sa()):cb(r)},1E3)}}function db(){ra=sa;ta=va;for(let b of B)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2);for(let b of C)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2)}
function eb(b){return function(d){void 0==d.target.m&&(d.target.m=d.target.value);let p=d.target.value+d.key;(new TextEncoder).encode(p).byteLength>b?d.target.value=d.target.m||"":(d.target.value=p,d.target.m=p);d.preventDefault();return!1}}
function cb(b){c.innerHTML="Enter your name<br>";aa.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";e.style.display="block";e.focus();let d=window.localStorage.getItem("name");d&&(e.value=d);e.onkeypress=e.onpaste=eb(4);b.onclose=function(){window.onbeforeunload=function(){};g.parentElement.removeChild(g);Aa.parentElement.removeChild(Aa);Na.parentElement.removeChild(Na);c.innerHTML="Disconnected";aa.innerHTML="";e.style.display="none";
Sa()};window.onkeydown=function(p){if(13==(p.keyCode||p.which)){window.localStorage.setItem("name",e.value);c.innerHTML="Spawning...";aa.innerHTML="";e.style.display="none";p=(p=window.localStorage.getItem("token"))?p.split(",").map(h=>+h):[];let r=(new TextEncoder).encode(e.value);b.send(new Uint8Array([...r,...p]));fb(b)}}}
function fb(b){function d({data:a}){y.set(new Uint8Array(a));na=a.byteLength;a=y[0]|y[1]<<8|y[2]<<16|y[3]<<24;if(0!=ua&&4!=a-ua)throw b.onmessage=function(){},Error(`tick - last_tick = ${a-ua}`);ua=a;a=4;F[0]=F[1];F[1]=performance.now();db();if(a!=na){if(0==y[a]){++a;xa=1;C=[];oa=y[a++];a+=2;Fa=y[a]|y[a+1]<<8;a+=2;Ga=y[a]|y[a+1]<<8;a+=2;P=y[a++];Q=Array(256);Ha=Array(256);for(var k=0;k<Fa;++k)for(var l=0;l<Ga;++l)null==Q[y[a]]&&(Q[y[a]]=new Path2D,Ha[y[a]]=new Path2D),Q[y[a]].rect((1.5+k*P)*S.fov.max,
(1.5+l*P)*S.fov.max,(P-3)*S.fov.max,(P-3)*S.fov.max),Ha[y[a]].rect(k*P*S.fov.max,l*P*S.fov.max,P*S.fov.max,P*S.fov.max),++a;t.width=P*Fa*S.fov.max;t.height=P*Ga*S.fov.max;ca.width=P*Fa*S.fov.max;ca.height=P*Ga*S.fov.max;for(k=0;256>k;++k)Q[k]&&(ba.fillStyle=fa[k]+"b0",ba.fill(Ha[k]),ba.fillStyle=fa[k],ba.fill(Q[k]),da.fillStyle=fa[k],da.fill(Ha[k]));ea||(requestAnimationFrame($a),ea=1)}if(a!=na){if(1==y[a])for(++a,k=y[a++],l=0;l<k;++l){var f=y[a++];if(B[f]){var m=y[a++];if(m)for(;m;){switch(m){case 1:B[f].g.x2=
z.getFloat32(a,!0);a+=4;oa==f&&(sa=B[f].g.x2);break;case 2:B[f].g.y2=z.getFloat32(a,!0);a+=4;oa==f&&(va=B[f].g.y2);break;case 3:B[f].g.r2=z.getFloat32(a,!0);a+=4;break;case 4:B[f].j=y[a++];B[f].j&&(B[f].l=y[a++]);break;case 5:m=y[a++],bb(B[f].name,(new TextDecoder).decode(y.subarray(a,a+m))),a+=m}m=y[a++]}else B[f]=void 0}else{m=z.getFloat32(a,!0);a+=4;var q=z.getFloat32(a,!0);a+=4;var x=z.getFloat32(a,!0);a+=4;var ha=y[a++],ia=(new TextDecoder).decode(y.subarray(a,a+ha));a+=ha;ha=y[a++];let ab=0;
ha&&(ab=y[a++]);let La=y[a++];0<La&&(bb(ia,(new TextDecoder).decode(y.subarray(a,a+La))),a+=La);B[f]={x:0,y:0,r:0,g:{x1:m,x2:m,y1:q,y2:q,r1:x,r2:x},name:ia,j:ha,l:ab};oa==f&&(sa=m,va=q)}}if(a!=na){if(2==y[a])for(++a,k=y[a]|y[a+1]<<8,a+=2,l=0;l<k;++l)if(f=y[a]|y[a+1]<<8,a+=2,C[f])if(m=y[a++])for(;m;){switch(m){case 1:C[f].g.x2=z.getFloat32(a,!0);a+=4;break;case 2:C[f].g.y2=z.getFloat32(a,!0);a+=4;break;case 3:C[f].g.r2=z.getFloat32(a,!0);if(1>C[f].g.r2||60<C[f].g.r2)throw console.log(`update ball id ${f} r ${C[f].g.r2}`),
b.onmessage=function(){},Error();a+=4}m=y[a++]}else C[f]=void 0;else if(m=y[a++],0!=m&&(--m,q=z.getFloat32(a,!0),a+=4,x=z.getFloat32(a,!0),a+=4,ia=z.getFloat32(a,!0),a+=4,C[f]={type:m,x:0,y:0,r:0,g:{x1:q,x2:q,y1:x,y2:x,r1:ia,r2:ia}},1>C[f].g.r2||60<C[f].g.r2))throw console.log(`create ball id ${f} r ${C[f].g.r2}`),b.onmessage=function(){},Error();if(a!=na&&3==y[a])for(++a,k=y[a++],l=0;l<k;++l)m=y[a++],f=(new TextDecoder).decode(y.subarray(a,a+m)),a+=m,m=y[a++],bb(f,(new TextDecoder).decode(y.subarray(a,
a+m))),a+=m}}}}function p(){if(window.innerWidth!=ka||window.innerHeight!=la||w!=window.devicePixelRatio)w=window.devicePixelRatio,ka=window.innerWidth,g.width=ka*w,la=window.innerHeight,g.height=la*w}function r(a,k,l){return a+(k-a)*l}function h(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function A(){Ea||(0==M-J&&
0==L-K?O=Da=0:(Da=Math.atan2(M-J,L-K),O=160*w));H?b.send(new Uint8Array([0,0,0,0,0,0])):(y[0]=0,z.setFloat32(1,Da,!0),O>=160*w?z.setUint8(5,255*N>>>0):z.setUint8(5,1.59375*O/w*N>>>0),b.send(y.subarray(0,6)))}function $a(a){if(0!=F[0]){S.chat_on==!Pa&&(Pa=S.chat_on,Na.style.display=Pa?"block":"none");E?E<F[0]?E=F[0]:E>F[1]&&(E=F[1]):E=F[0];var k=T;T=r(T,U,.1);T!=k&&(O=Math.hypot(D[0]-.5*g.width,D[1]-.5*g.height)/T,A());k=F[0]==F[1]?0:(E-F[0])/(F[1]-F[0]);E+=a-wa;wa=a;pa=r(ra,sa,k);qa=r(ta,va,k);n.resetTransform();
n.fillStyle="#333";n.fillRect(0,0,g.width,g.height);n.translate(.5*g.width,.5*g.height);n.scale(T,T);n.translate(-pa,-qa);n.drawImage(t,0,0,t.width/S.fov.max,t.height/S.fov.max);1>T&&(n.globalAlpha=1-T*T,n.drawImage(ca,0,0,t.width/S.fov.max,t.height/S.fov.max),n.globalAlpha=1);a=[];if(S.draw_player_fill||S.draw_player_stroke)for(var l of B)l&&(l.x=r(l.g.x1,l.g.x2,k),l.y=r(l.g.y1,l.g.y2,k),l.r=r(l.g.r1,l.g.r2,k),a[a.length]={u:l});if(S.draw_ball_fill||S.draw_ball_stroke)for(var f of C)f&&(f.x=r(f.g.x1,
f.g.x2,k),f.y=r(f.g.y1,f.g.y2,k),f.r=r(f.g.r1,f.g.r2,k),a[a.length]={o:f});a.sort((m,q)=>m.r-q.r);for(let {o:m,u:q}of a)if(n.beginPath(),q){if(l=S.player_stroke.value/200*q.r,n.moveTo(q.x+q.r-l,q.y),n.arc(q.x,q.y,q.r-l,0,2*Math.PI),S.draw_player_fill&&(n.fillStyle="#ebecf0",n.fill()),S.draw_player_stroke&&(!S.draw_player_fill&&S.draw_player_stroke_bright?n.strokeStyle="#ebecf0":n.strokeStyle=h("#ebecf0"),n.lineWidth=2*l,n.stroke()),S.draw_player_name&&0!=q.name.length&&(n.font=`700 ${q.r/T}px Ubuntu`,
n.textAlign="center",n.textBaseline="middle",n.fillStyle="#00000080",za=1<T?.5*q.r:.5*q.r+2/(T*T),ya=r(ya,za,.1),n.fillText(q.name,q.x,q.y-q.r-ya)),q.j&&(n.font=`700 ${q.r/Math.min(T,1)}px Ubuntu`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#f00",n.fillText(q.l,q.x,q.y),S.draw_death_arrow)){a=.5*g.width+(q.x-pa)*T;k=.5*g.height+(q.y-qa)*T;let x=.75*u.width*T;if(0>a||a>g.width||0>k||k>g.height)f=Math.max(Math.min(a,g.width-x),x),l=Math.max(Math.min(k,g.height-x),x),a=(a<x||a>g.width-
x)&&(k<x||k>g.height-x)?Math.atan2(k-l,a-f):Math.atan2(k<x?-1:k>g.height-x?1:0,a<x?-1:a>g.width-x?1:0),f=(f-.5*g.width)/T+pa,l=(l-.5*g.height)/T+qa,n.translate(f,l),n.rotate(a),n.drawImage(u,.5*-u.width,.5*-u.width),n.rotate(-a),n.font=`700 ${.3*u.width}px Ubuntu`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#f00",n.fillText(q.l,0,0),n.translate(-f,-l)}}else l=S.ball_stroke.value/200*m.r,n.moveTo(m.x+m.r-l,m.y),n.arc(m.x,m.y,m.r-l,0,2*Math.PI),S.draw_ball_fill&&(n.fillStyle=ja[m.type],
n.fill()),S.draw_ball_stroke&&(n.strokeStyle=!S.draw_ball_fill&&S.draw_ball_stroke_bright?ja[m.type]:h(ja[m.type]),n.lineWidth=2*l,n.stroke())}requestAnimationFrame($a)}Pa=!S.chat_on;let ua=0;b.onmessage=function(a){xa=0;d(a);xa&&(c.innerHTML="",db())};V.onmousedown=function(a){a.stopPropagation()};V.onmouseup=function(a){a.stopPropagation()};V.onkeydown=function(a){a.stopPropagation();"Enter"==a.code&&(a=(new TextEncoder).encode(V.value),y[0]=1,y[1]=a.length,y.set(a,2),b.send(y.subarray(0,y[1]+2)),
V.value="",V.blur(),V.disabled=1,setTimeout(function(){V.disabled=0},1E3),g.focus())};V.onkeyup=function(a){a.stopPropagation()};V.onkeypress=V.onpaste=eb(64);Oa.onwheel=function(a){a.stopPropagation()};p();window.onresize=p;window.onwheel=function(a){H||(a=.05*-Math.sign(a.deltaY),U=1<U?U+3*a:U+a,U=Math.min(Math.max(U,S.fov.min),S.fov.max))};window.onmousemove=function(a){D=[a.clientX*w,a.clientY*w];Da=Math.atan2(D[1]-.5*g.height,D[0]-.5*g.width);O=Math.hypot(D[0]-.5*g.width,D[1]-.5*g.height)/T;
A()};window.onmousedown=function(){H||(Ea=!Ea);Da=Math.atan2(D[1]-.5*g.height,D[0]-.5*g.width);O=Math.hypot(D[0]-.5*g.width,D[1]-.5*g.height)/T;A()};window.onkeydown=function(a){if(!a.repeat)if(H)Ja?(a.preventDefault(),Ka=a.code,Ma()):a.code==I.settings&&(H=!1,Aa.style.display="none");else switch(a.code){case "Enter":V.focus();a.preventDefault();break;case I.slowwalk:1==N&&(N=.5,A());break;case I.up:J||(J=1,A());break;case I.left:K||(K=1,A());break;case I.right:L||(L=1,A());break;case I.down:M||(M=
1,A());break;case I.settings:H=!H,Aa.style.display=H?"block":"none"}};window.onkeyup=function(a){if(!a.repeat&&!H)switch(a.code){case I.slowwalk:.5==N&&(N=1,A());break;case I.up:J&&(J=0,A());break;case I.left:K&&(K=0,A());break;case I.right:L&&(L=0,A());break;case I.down:M&&(M=0,A())}};window.onbeforeunload=function(a){a.preventDefault();a.returnValue="Are you sure you want to quit?";window.localStorage.setItem("settings",JSON.stringify(S));return"Are you sure you want to quit?"};g.oncontextmenu=
function(a){a.preventDefault();return!1}};
