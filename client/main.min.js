let c=document.getElementById("loading");c.innerHTML="Fetching servers...";
let ba=document.getElementById("sub"),k=document.getElementById("name"),l=document.getElementById("canvas"),q=l.getContext("2d"),r=document.createElement("canvas"),ca=r.getContext("2d"),da=document.createElement("canvas"),ea=da.getContext("2d"),fa=0,ha=["#dddddd","#aaaaaa","#333333","#fedf78"],ia=["#808080","#fc46aa","#008080","#ff8e06","#d2b48c"],ja=0,ka=0,t=0,na=new ArrayBuffer(1048576),u=new Uint8Array(na),v=new DataView(u.buffer),oa=0,pa=0,w=[],x=[];var qa=0,ra=0,sa=0,ta=0,ua=0,va=0;
let z=[0,0],A=null,wa=0,B=[0,0],xa=0,ya=0,za=0,Aa=document.getElementById("settings"),C=document.getElementById("ss"),D=!1,Ba=window.localStorage.getItem("keybinds"),E={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft"},F=null!=Ba?JSON.parse(Ba):E;for(let b in E)void 0===F[b]&&(F[b]=E[b]);for(let b in F)void 0===E[b]&&delete F[b];var G=0,H=0,I=0,J=0,K=1,L=0,Ca=0,M=0,Da=0,Ea=0,N=0,O=[],P=[];
let Fa=window.localStorage.getItem("settings"),Q={fov:{min:.25,max:4,value:1,step:.05},chat_on:!0,chat_position:{selected:"Bottom left",options:["Top left","Top right","Bottom left","Bottom right"]},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!1,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!1,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0},R=null!=Fa?JSON.parse(Fa):JSON.parse(JSON.stringify(Q));
for(let b in Q)void 0===R[b]&&(R[b]=Q[b]);for(let b in R)void 0===Q[b]&&delete R[b];window.localStorage.setItem("settings",JSON.stringify(R));let Ga=!1,Ha="",Ia,S=R.fov.value,T=S;window.s.then(b=>b.json()).then(b=>Ja(b));function Ka(){setTimeout(location.reload.bind(location),1E3)}function La(){window.localStorage.setItem("settings",JSON.stringify(R))}function Ma(){window.localStorage.setItem("keybinds",JSON.stringify(F))}function Na(b){let f=document.createElement("h1");f.innerHTML=b;return f}
function V(b){let f=document.createElement("h3");f.innerHTML=b;return f}function W(b,f,e){let h=document.createElement("tr"),p=document.createElement("td");p.appendChild(f);h.appendChild(p);p=document.createElement("td");p.appendChild(e);h.appendChild(p);b.appendChild(h)}
function X(b){let f=document.createElement("button");R[b]=!R[b];f.onclick=function(){R[b]=!R[b];1==R[b]?(f.innerHTML="ON",f.style["background-color"]="#23c552"):(f.innerHTML="OFF",f.style["background-color"]="#f84f31");La()};f.onclick();return f}function Oa(){let b=document.createElement("select");for(let f of R.chat_position.options){let e=document.createElement("option");e.value=f;f==R.chat_position.selected&&(e.selected=1);e.innerHTML=f;b.appendChild(e)}b.onchange=La;return b}
function Y(b){let f=document.createElement("button");f.innerHTML=F[b];f.onclick=async function(){f.innerHTML="...";Ga=1;await new Promise(function(e){Ia=e});Ga=0;f.innerHTML=Ha;F[b]=Ha;Ma()};return f}
function Pa(b,f=""){let e=document.createElement("div");e.className="input";let h=document.createElement("input");h.type="range";h.min=R[b].min;h.max=R[b].max;h.step=R[b].step;h.value=R[b].value;h.oninput=function(){h.nextElementSibling.innerHTML=h.value+f;R[b].value=h.valueAsNumber};h.onchange=La;e.appendChild(h);e.appendChild(V(h.value+f));return e}function Sa(b){let f=document.createElement("button");f.innerHTML="RESET";f.onclick=b;return f}
function Ta(){C.innerHTML="";C.appendChild(Na("GENERAL"));let b=document.createElement("table");W(b,V("Show chat"),X("chat_on"));W(b,V("Chat position"),Oa());W(b,V("Default FOV"),Pa("fov"));W(b,V("Draw balls' fill"),X("draw_ball_fill"));W(b,V("Draw balls' stroke"),X("draw_ball_stroke"));W(b,V("Draw stroke-only balls with brighter color"),X("draw_ball_stroke_bright"));W(b,V("Balls' stroke radius percentage"),Pa("ball_stroke"," %"));W(b,V("Draw players' fill"),X("draw_player_fill"));W(b,V("Draw players' stroke"),
X("draw_player_stroke"));W(b,V("Draw stroke-only players with brighter color"),X("draw_player_stroke_bright"));W(b,V("Players' stroke radius percentage"),Pa("player_stroke"," %"));W(b,V("Draw players' name"),X("draw_player_name"));C.appendChild(b);C.appendChild(Na("KEYBINDS"));b=document.createElement("table");W(b,V("Settings"),Y("settings"));W(b,V("Move up"),Y("up"));W(b,V("Move left"),Y("left"));W(b,V("Move down"),Y("down"));W(b,V("Move right"),Y("right"));W(b,V("Move slowly"),Y("slowwalk"));C.appendChild(b);
C.appendChild(Na("RESET"));b=document.createElement("table");W(b,V("Reset settings"),Sa(function(){R=Q;La();Ta()}));W(b,V("Reset keybinds"),Sa(function(){F=E;Ma();Ta()}));C.appendChild(b)}Ta();
function Ja(b){if(0==b.length)c.innerHTML="No servers found",Ka();else{c.innerHTML="Connecting...";var f=b.map(function(e){e=new WebSocket(e[1]);e.binaryType="arraybuffer";e.i=[];e.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};e.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return e});setTimeout(function(){let e=999999,h=null;for(let p of f){p.h=0;for(let y of p.i)p.h+=y;0<p.i.length?p.h/=p.i.length:
p.h=999999;p.h<e&&(e=p.h,h=p)}for(let p of f)p.onopen=function(){},p.onmessage=function(){},delete p.i,delete p.time,delete p.h,p!=h&&p.close();null==h||1!=h.readyState?(c.innerHTML="Failed connecting",Ka()):Ua(h)},1E3)}}function Va(){sa=ta;ua=va;for(let b of w)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2);for(let b of x)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2)}
function Ua(b){c.innerHTML="Enter your name<br>";ba.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";k.style.display="block";let f=window.localStorage.getItem("name");f&&(k.value=f);k.onkeypress=k.onblur=k.onpaste=function(e){let h=e.target.value+e.key;4<(new TextEncoder).encode(h).byteLength?e.target.value=e.target.u||"":(e.target.value=h,e.target.u=h);e.preventDefault();return!1};b.onclose=function(){window.onbeforeunload=function(){};
l.parentElement.removeChild(l);c.innerHTML="Disconnected";ba.innerHTML="";k.style.display="none";Ka()};window.onkeydown=function(e){13==(e.keyCode||e.which)&&(window.localStorage.setItem("name",k.value),c.innerHTML="Spawning...",ba.innerHTML="",k.style.display="none",e=(e=window.localStorage.getItem("token"))?e.split(",").map(h=>+h):[],b.send(new Uint8Array([...(new TextEncoder).encode(k.value),0,...e])),Wa(b))}}
function Wa(b){function f({data:a}){u.set(new Uint8Array(a));oa=a.byteLength;a=u[0]|u[1]<<8|u[2]<<16|u[3]<<24;if(0!=la&&4!=a-la)throw b.onmessage=function(){},Error(`tick - last_tick = ${a-la}`);la=a;a=4;B[0]=B[1];B[1]=performance.now();Va();if(a!=oa){if(0==u[a]){++a;xa=1;x=[];pa=u[a++];a+=2;Da=u[a]|u[a+1]<<8;a+=2;Ea=u[a]|u[a+1]<<8;a+=2;N=u[a++];O=Array(256);P=Array(256);for(var n=0;n<Da;++n)for(var m=0;m<Ea;++m)null==O[u[a]]&&(O[u[a]]=new Path2D,P[u[a]]=new Path2D),O[u[a]].rect((1.5+n*N)*R.fov.max,
(1.5+m*N)*R.fov.max,(N-3)*R.fov.max,(N-3)*R.fov.max),P[u[a]].rect(n*N*R.fov.max,m*N*R.fov.max,N*R.fov.max,N*R.fov.max),++a;r.width=N*Da*R.fov.max;r.height=N*Ea*R.fov.max;da.width=N*Da*R.fov.max;da.height=N*Ea*R.fov.max;for(n=0;256>n;++n)O[n]&&(ca.fillStyle=ha[n]+"b0",ca.fill(P[n]),ca.fillStyle=ha[n],ca.fill(O[n]),ea.fillStyle=ha[n],ea.fill(P[n]));fa||(requestAnimationFrame(Qa),fa=1)}if(a!=oa){if(1==u[a])for(++a,n=u[a++],m=0;m<n;++m){var d=u[a++];if(w[d]){var g=u[a++];if(g)for(;g;){switch(g){case 1:w[d].g.x2=
v.getFloat32(a,!0);a+=4;pa==d&&(ta=w[d].g.x2);break;case 2:w[d].g.y2=v.getFloat32(a,!0);a+=4;pa==d&&(va=w[d].g.y2);break;case 3:w[d].g.r2=v.getFloat32(a,!0);a+=4;break;case 4:w[d].j=u[a++],w[d].j&&(w[d].l=u[a++])}g=u[a++]}else w[d]=void 0}else{g=v.getFloat32(a,!0);a+=4;var U=v.getFloat32(a,!0);a+=4;var Z=v.getFloat32(a,!0);a+=4;var aa=u[a++],ma=(new TextDecoder).decode(u.subarray(a,a+aa));a+=aa;aa=u[a++];let Ra=0;aa&&(Ra=u[a++]);w[d]={x:0,y:0,r:0,g:{x1:g,x2:g,y1:U,y2:U,r1:Z,r2:Z},name:ma,j:aa,l:Ra};
pa==d&&(ta=g,va=U)}}if(a!=oa&&2==u[a])for(++a,n=u[a]|u[a+1]<<8,a+=2,m=0;m<n;++m)if(d=u[a]|u[a+1]<<8,a+=2,x[d])if(g=u[a++])for(;g;){switch(g){case 1:x[d].g.x2=v.getFloat32(a,!0);a+=4;break;case 2:x[d].g.y2=v.getFloat32(a,!0);a+=4;break;case 3:x[d].g.r2=v.getFloat32(a,!0);if(1>x[d].g.r2||60<x[d].g.r2)throw console.log(`update ball id ${d} r ${x[d].g.r2}`),b.onmessage=function(){},Error();a+=4}g=u[a++]}else x[d]=void 0;else if(g=u[a++],0!=g&&(--g,U=v.getFloat32(a,!0),a+=4,Z=v.getFloat32(a,!0),a+=4,ma=
v.getFloat32(a,!0),a+=4,x[d]={type:g,x:0,y:0,r:0,g:{x1:U,x2:U,y1:Z,y2:Z,r1:ma,r2:ma}},1>x[d].g.r2||60<x[d].g.r2))throw console.log(`create ball id ${d} r ${x[d].g.r2}`),b.onmessage=function(){},Error();}}}function e(){if(window.innerWidth!=ja||window.innerHeight!=ka||t!=window.devicePixelRatio)t=window.devicePixelRatio,ja=window.innerWidth,l.width=ja*t,ka=window.innerHeight,l.height=ka*t}function h(a,n,m){return a+(n-a)*m}function p(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,
"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function y(){Ca||(0==J-G&&0==I-H?M=L=0:(L=Math.atan2(J-G,I-H),M=160*t));D?b.send(new Uint8Array([0,0,0,0,0])):(v.setFloat32(0,L,!0),M>=160*t?v.setUint8(4,255*K>>>0):v.setUint8(4,1.59375*M/t*K>>>0),b.send(u.subarray(0,5)))}function Qa(a){if(0!=B[0]){A?A<B[0]?A=B[0]:A>B[1]&&(A=B[1]):A=B[0];var n=S;S=h(S,T,.1);S!=n&&(M=Math.hypot(z[0]-l.width/2,z[1]-
l.height/2)/S,y());n=B[0]==B[1]?0:(A-B[0])/(B[1]-B[0]);A+=a-wa;wa=a;qa=h(sa,ta,n);ra=h(ua,va,n);q.resetTransform();q.fillStyle="#333";q.fillRect(0,0,l.width,l.height);q.translate(l.width/2,l.height/2);q.scale(S,S);q.translate(-qa,-ra);q.drawImage(r,0,0,r.width/R.fov.max,r.height/R.fov.max);1>S&&(q.globalAlpha=1-S*S,q.drawImage(da,0,0,r.width/R.fov.max,r.height/R.fov.max),q.globalAlpha=1);a=[];if(R.draw_player_fill||R.draw_player_stroke)for(var m of w)m&&(m.x=h(m.g.x1,m.g.x2,n),m.y=h(m.g.y1,m.g.y2,
n),m.r=h(m.g.r1,m.g.r2,n),a[a.length]={o:m});if(R.draw_ball_fill||R.draw_ball_stroke)for(let d of x)d&&(d.x=h(d.g.x1,d.g.x2,n),d.y=h(d.g.y1,d.g.y2,n),d.r=h(d.g.r1,d.g.r2,n),a[a.length]={m:d});a.sort((d,g)=>d.r-g.r);for(let {m:d,o:g}of a)q.beginPath(),g?(m=R.player_stroke.value/200*g.r,q.moveTo(g.x+g.r-m,g.y),q.arc(g.x,g.y,g.r-m,0,2*Math.PI),R.draw_player_fill&&(q.fillStyle="#ebecf0",q.fill()),R.draw_player_stroke&&(!R.draw_player_fill&&R.draw_player_stroke_bright?q.strokeStyle="#ebecf0":q.strokeStyle=
p("#ebecf0"),q.lineWidth=2*m,q.stroke()),R.draw_player_name&&0!=g.name.length&&(q.font=`700 ${g.r/S}px Ubuntu`,q.textAlign="center",q.textBaseline="middle",q.fillStyle="#00000080",za=1<S?.5*g.r:.5*g.r+2/(S*S),ya=h(ya,za,.1),q.fillText(g.name,g.x,g.y-g.r-ya)),g.j&&(q.font=`700 ${g.r/Math.min(S,1)}px Ubuntu`,q.textAlign="center",q.textBaseline="middle",q.fillStyle="#f00",q.fillText(g.l,g.x,g.y))):(m=R.ball_stroke.value/200*d.r,q.moveTo(d.x+d.r-m,d.y),q.arc(d.x,d.y,d.r-m,0,2*Math.PI),R.draw_ball_fill&&
(q.fillStyle=ia[d.type],q.fill()),R.draw_ball_stroke&&(q.strokeStyle=!R.draw_ball_fill&&R.draw_ball_stroke_bright?ia[d.type]:p(ia[d.type]),q.lineWidth=2*m,q.stroke()))}requestAnimationFrame(Qa)}let la=0;b.onmessage=function(a){xa=0;f(a);xa&&(c.innerHTML="",Va())};e();window.onresize=e;window.onwheel=function(a){D||(a=.05*-Math.sign(a.deltaY),T=1<T?T+3*a:T+a,T=Math.min(Math.max(T,R.fov.min),R.fov.max))};window.onmousemove=function(a){z=[a.clientX*t,a.clientY*t];L=Math.atan2(z[1]-l.height/2,z[0]-l.width/
2);M=Math.hypot(z[0]-l.width/2,z[1]-l.height/2)/S;y()};window.onmousedown=function(){D||(Ca=!Ca);L=Math.atan2(z[1]-l.height/2,z[0]-l.width/2);M=Math.hypot(z[0]-l.width/2,z[1]-l.height/2)/S;y()};window.onkeydown=function(a){if(!a.repeat)if(D)Ga?(a.preventDefault(),Ha=a.code,Ia()):a.code==F.settings&&(D=!1,Aa.style.display="none");else switch(a.code){case F.slowwalk:1==K&&(K=.5,y());break;case F.up:G||(G=1,y());break;case F.left:H||(H=1,y());break;case F.right:I||(I=1,y());break;case F.down:J||(J=1,
y());break;case F.settings:D=!D,Aa.style.display=D?"block":"none"}};window.onkeyup=function(a){if(!a.repeat&&!D)switch(a.code){case F.slowwalk:.5==K&&(K=1,y());break;case F.up:G&&(G=0,y());break;case F.left:H&&(H=0,y());break;case F.right:I&&(I=0,y());break;case F.down:J&&(J=0,y())}};window.onbeforeunload=function(a){a.preventDefault();a.returnValue="Are you sure you want to quit?";window.localStorage.setItem("settings",JSON.stringify(R));return"Are you sure you want to quit?"};l.oncontextmenu=function(a){a.preventDefault();
return!1}};
