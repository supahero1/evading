const g=window.localStorage,l=g.getItem.bind(g),aa=g.setItem.bind(g),ba=g.removeItem.bind(g),m=Math.sin,n=Math.cos,ca=Math.max,p=Math.min,da=l("keybinds"),ea={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft",spec_prev:"KeyA",spec_next:"KeyD"};let r=null!=da?JSON.parse(da):ea;for(const a in ea)a in r||(r[a]=ea[a]);for(const a in r)a in ea||delete r[a];function ha(){aa("keybinds",JSON.stringify(r))}
const ia=l("settings"),t={fov:{min:.25,max:40,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},chat_text_scale:{min:1,max:2,value:1,step:.05},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!0,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!0,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1},show_tutorial:!0,
show_ping:!1};let u=null!=ia?JSON.parse(ia):JSON.parse(JSON.stringify(t));for(const a in t)a in u||(u[a]=t[a]);for(const a in u)a in t?(u[a].min&&u[a].min!=t[a].min&&(u[a].min=t[a].min),u[a].max&&u[a].max!=t[a].max&&(u[a].max=t[a].max),u[a].step&&u[a].step!=t[a].step&&(u[a].step=t[a].step),u[a].value=ca(p(u[a].value,u[a].max),u[a].min)):delete u[a];function ja(){aa("settings",JSON.stringify(u))}
const v=document.getElementById.bind(document),w=document.createElement.bind(document),x=v("ID_status"),ka=l("token");let la=[];"string"==typeof ka&&(la=ka.split(",").map(a=>+a));function ma(){setTimeout(location.reload.bind(location),1E3)}function na(a){const b=a.match(/\/\/(.*?)\.shadam\.xyz/),c=a.match(/\/\/(.*?)[\/:]/);return b?b[1]:c?c[1]:a}WebSocket.prototype.send=new Proxy(WebSocket.prototype.send,{apply:function(a,b,c){if(b.readyState==WebSocket.OPEN)return a.apply(b,c)},configurable:!0,enumerable:!0});
WebSocket.prototype.close=new Proxy(WebSocket.prototype.close,{apply:function(a,b,c){if(b.readyState==WebSocket.CONNECTING||b.readyState==WebSocket.OPEN)return a.apply(b,c)},configurable:!0,enumerable:!0});
function oa(a){return function(b){const c=b instanceof ClipboardEvent;if(!c||"paste"==b.type){var d=b.target.value+(c?b.clipboardData.getData("text"):b.key);if((new TextEncoder).encode(d).byteLength-b.target.selectionEnd+b.target.selectionStart>a){if(""==b.target.value&&c){const e=b.target.placeholder;b.target.placeholder="Text too long to paste!";setTimeout(function(){b.target.placeholder=e},1E3)}b.preventDefault()}}}}function z(a,b,c){return a+(b-a)*c}
if(0==window.s.length)throw x.innerHTML="No servers found",ma(),Error(x.innerHTML);x.innerHTML="Connecting";const pa=new Uint32Array([14540253,11184810,3355443,16703352]),va=Array.from(pa).map(a=>"#"+a.toString(16)),wa=new Uint32Array([2155905279,4232489727,8421631,4287497983,1021313023,1715110655]);Array.from(wa).map(a=>"#"+a.toString(16));const xa=new ArrayBuffer(1048560),C=new DataView(xa);
function ya(a,b){const c=a[0],d=a[1],e=a[2],f=a[3],k=a[4],q=a[5],h=a[6],y=a[7],B=a[8],A=b[0],M=b[1],fa=b[2],qa=b[3],ra=b[4],sa=b[5],ta=b[6],ua=b[7];b=b[8];a[0]=A*c+M*f+fa*h;a[1]=A*d+M*k+fa*y;a[2]=A*e+M*q+fa*B;a[3]=qa*c+ra*f+sa*h;a[4]=qa*d+ra*k+sa*y;a[5]=qa*e+ra*q+sa*B;a[6]=ta*c+ua*f+b*h;a[7]=ta*d+ua*k+b*y;a[8]=ta*e+ua*q+b*B;return a}
class za extends Float32Array{constructor(){super([2/D.width,0,0,0,-2/D.height,0,-1,1,1])}translate(a,b){return ya(this,new Float32Array([1,0,0,0,1,0,a,b,1]))}rotate(a){const b=n(a);a=m(a);return ya(this,new Float32Array([b,-a,0,a,b,0,0,0,1]))}}const E=WebGL2RenderingContext.prototype;
function Aa(a){a=(a?v(a):w("canvas")).getContext("webgl2",{premultipliedAlpha:!1,failIfMajorPerformanceCaveat:!1});if(!a)throw x.innerHTML="Your browser/device does not support WebGL2.",Error("Your browser/device does not support WebGL2.");return a}function Ba(a,b,c){b=a.g.createShader(b);a.g.shaderSource(b,c);a.g.compileShader(b);if(a.g.getShaderParameter(b,E.COMPILE_STATUS))return b;throw Error(a.g.getShaderInfoLog(b));}
function Ca(a){a.g.useProgram(a.j);a.g.bindVertexArray(a.u);a.g.uniformMatrix3fv(a.B,!1,a.matrix)}
class Da{constructor(a,b,c){a instanceof WebGL2RenderingContext?this.g=a:this.g=Aa(a);a=this.g.createProgram();this.g.attachShader(a,Ba(this,E.VERTEX_SHADER,b));this.g.attachShader(a,Ba(this,E.FRAGMENT_SHADER,c));this.g.linkProgram(a);if(this.g.getProgramParameter(a,E.LINK_STATUS))b=a;else throw Error(this.g.getProgramInfoLog(a));this.j=b;this.u=this.g.createVertexArray();this.g.bindVertexArray(this.u);this.h=null;this.B=this.g.getUniformLocation(this.j,"u_matrix");this.matrix=null;this.i=0}set(a,
b){this.g.bindBuffer(E.ARRAY_BUFFER,this.h);this.g.bufferData(E.ARRAY_BUFFER,a,E.DYNAMIC_DRAW);this.i=b}}
class Ea extends Da{constructor(){super(F.A,"#version 300 es\n\n\n      layout(location = 0) in vec2 a_position;\n      layout(location = 1) in vec2 a_offset;\n      layout(location = 2) in float a_scale;\n      layout(location = 3) in vec3 a_color;\n\n      uniform mat3 u_matrix;\n\n      out vec3 v_color;\n\n      void main() {\n        gl_Position = vec4((u_matrix * vec3(a_position * a_scale + a_offset, 1)).xy, 0.5, 1.0);\n        v_color = a_color;\n      }\n      ","#version 300 es\n\n\n      precision mediump float;\n\n      uniform float u_light;\n\n      in vec3 v_color;\n\n      out vec4 fragColor;\n\n      void main() {\n        fragColor = vec4(v_color.xyz * u_light, 1.0);\n      }\n    ");
this.A=new Float32Array([0,1,.0375,.9625,1,1,.9625,.9625,1,0,.9625,.0375,0,0,.0375,.0375,0,1,.0375,.9625]);this.model=new Float32Array([.0375,.0375,.9625,.0375,.0375,.9625,.9625,.9625]);this.o=this.g.getUniformLocation(this.j,"u_light");this.l=this.g.createBuffer();this.g.bindBuffer(E.ARRAY_BUFFER,this.l);this.g.vertexAttribPointer(0,2,E.FLOAT,!1,0,0);this.g.enableVertexAttribArray(0);this.h=this.g.createBuffer();this.g.bindBuffer(E.ARRAY_BUFFER,this.h);this.g.vertexAttribPointer(1,2,E.SHORT,!1,8,
0);this.g.vertexAttribPointer(2,1,E.UNSIGNED_BYTE,!1,8,4);this.g.vertexAttribPointer(3,3,E.UNSIGNED_BYTE,!0,8,5);this.g.vertexAttribDivisor(1,1);this.g.vertexAttribDivisor(2,1);this.g.vertexAttribDivisor(3,1);this.g.enableVertexAttribArray(1);this.g.enableVertexAttribArray(2);this.g.enableVertexAttribArray(3)}}
function Fa(a,b,c,d,e){if(b||c){Ca(a);c||(d=0);var f=new Float32Array(252*b+4+512*c),k=Math.PI/64,q=0;if(b){var h=m(k),y=n(k),B=1-d,A=0;f[0]=B;f[1]=A;q=2;for(let M=1;64>M;++M){let fa=B*y-A*h;A=B*h+A*y;B=fa;f[q++]=B;f[q++]=A;f[q++]=B;f[q++]=-A}f[q++]=-1+d;f[q++]=0}if(c){b||(c=m(-k),h=n(-k),y=-1+d,B=0,A=y*h-B*c,f[q++]=A,f[q++]=-(y*c+B*h),f[q++]=-1+d,f[q++]=0);c=Math.PI;for(h=0;127>h;++h)f[q++]=n(c),f[q++]=m(c),c-=k,f[q++]=n(c)*(1-d),f[q++]=m(c)*(1-d);f[q++]=n(c);f[q++]=m(c);c-=k;f[q++]=n(c);f[q++]=
m(c)}a.g.bindBuffer(E.ARRAY_BUFFER,a.l);a.g.bufferData(E.ARRAY_BUFFER,f,E.DYNAMIC_DRAW);a.g.uniform1i(a.o,b?128:e?258:0);a.g.drawArraysInstanced(E.TRIANGLE_STRIP,0,f.length>>1,a.i)}}
class Ga extends Da{constructor(a){super(a,"#version 300 es\n\n\n      layout(location = 0) in vec2 a_position;\n      layout(location = 1) in vec2 a_offset;\n      layout(location = 2) in float a_scale;\n      layout(location = 3) in vec4 a_color;\n\n      uniform mat3 u_matrix;\n      uniform int u_precision;\n\n      flat out vec4 v_color;\n\n      void main() {\n        gl_Position = vec4((u_matrix * vec3(a_position * a_scale + a_offset, 1)).xy, -1.0 / a_scale, 1.0);\n        if(gl_VertexID < u_precision) {\n          v_color = a_color;\n        } else {\n          v_color = vec4(a_color.xyz * 0.8, a_color.w);\n        }\n      }\n      ","#version 300 es\n\n\n      precision mediump float;\n\n      flat in vec4 v_color;\n\n      out vec4 fragColor;\n\n      void main() {\n        fragColor = v_color;\n      }\n    ");
this.o=this.g.getUniformLocation(this.j,"u_precision");this.l=this.g.createBuffer();this.g.bindBuffer(E.ARRAY_BUFFER,this.l);this.g.vertexAttribPointer(0,2,E.FLOAT,!1,0,0);this.g.enableVertexAttribArray(0);this.h=this.g.createBuffer();this.g.bindBuffer(E.ARRAY_BUFFER,this.h);this.g.vertexAttribPointer(1,2,E.FLOAT,!1,16,0);this.g.vertexAttribPointer(2,1,E.FLOAT,!1,16,8);this.g.vertexAttribPointer(3,4,E.UNSIGNED_BYTE,!0,16,12);this.g.vertexAttribDivisor(1,1);this.g.vertexAttribDivisor(2,1);this.g.vertexAttribDivisor(3,
1);this.g.enableVertexAttribArray(1);this.g.enableVertexAttribArray(2);this.g.enableVertexAttribArray(3)}}
function Ha(a){a.h.innerHTML="";for(const b of a.o){const c=w("option");c.value=b[2];b[2]==G.v.url&&(c.selected=!0,c.disabled=!0,a.g=c);b[0]>=b[1]&&(c.disabled=1);const d=na(b[2]);c.innerHTML=d[0].toUpperCase()+d.substring(1)+` (${b[0]}/${b[1]})`;a.h.appendChild(c)}a.h.onfocus=function(){aa("psfy_tooltip","");this.J.style.display="none"}.bind(a);a.h.onchange=async function(){this.g.disabled=!1;const b=this.g;this.g=this.h.selectedOptions[0];this.g.disabled=!0;Ia();let c;const d=new Promise(function(f){c=
f}),e=new Ja(this.g.value,c,1);setTimeout(c,2E3);await d;0==e.K||e.v.readyState!=WebSocket.OPEN?(e.stop(),x.innerHTML="Couldn't connect, returning to previous server",this.g.disabled=!1,this.g=b,this.g.disabled=!0,setTimeout(H.l.bind(H),1E3)):Ka(e)}.bind(a);La(a)}function Ma(){var a=I;Ha(a);a.I=setInterval(function(){fetch("servers.json").then(b=>b.json()).then(function(b){I.o=b;Ha(I)})},5E3)}function Na(){I.j.style.display="block"}
function Oa(){var a=I;const b=w("h5");b.id="ID_spec_help";b.innerHTML=a.R;setTimeout(function(){b.style.opacity=0},3E3);b.addEventListener("transitionend",a.G.bind(a));document.body.insertBefore(b,I.j);a.i=b}function La(a){void 0==l("psfy_tooltip")&&(a.S.innerHTML="We picked a server<br>for you automatically.<br><br>You can change it here.",a.J.style.display="table")}
class Pa{constructor(){this.j=v("ID_menu");this.name=v("ID_name");this.h=v("ID_select_serv");this.g=null;this.o=window.s;this.J=v("ID_picked_server_for_you");this.S=v("ID_picked_server_for_you_tooltip");this.A=v("ID_ping");this.P();this.B=v("ID_play");this.u=v("ID_spec");this.i=null;this.R="";this.l();this.F=v("ID_spectating");this.C=v("ID_refresh");var a=v("ID_spec_help");a.parentElement.removeChild(a);this.C.onclick=location.reload.bind(location);this.name.onkeypress=this.name.onpaste=oa(16);this.name.onchange=
function(){H.i=!1;aa("name",this.value)};this.I=-1;a=l("name");"string"==typeof a&&16>=(new TextEncoder).encode(a).length&&(this.name.value=a);this.B.onclick=function(){var b=J;Qa(b);b.g[0]=0;b.h=1;K(G)};this.u.onclick=function(){Ra(0);K(G)}}l(){this.R=`Press ${r.spec_prev} or ${r.spec_next} to switch between players<br><br>Type "/menu" in chat to return to the main menu`}G(){null!=this.i&&(this.i.parentElement.removeChild(this.i),this.i=null)}P(){this.A.style.display=u.show_ping?"block":"none"}}
function K(a){a.v.send(J.g.subarray(0,J.h))}function Ka(a){var b=G;null!=b.v&&(b.stop(),b.once=!1,b.i=!1,b.g=[0,0]);b.H=a.H;b.L=a.L;b.D=a.D;b.m=a.m;b.v=a.v;b.v.onmessage=function({data:c}){try{this.message({data:c})}catch(d){console.log(d),console.log(Array.from(new Uint8Array(c)).map(e=>e.toString(16).padStart(2,"0")).join(" "))}}.bind(b);b.v.onclose=b.close.bind(b);Sa();K(b);b.h()}
function Ta(a){a.H[a.m]=(new Date).getTime()-a.L;a.D=0;let b=a.m,c=0;for(let d=0;10>d;++d)0!=a.H[b]&&(a.D+=(10-c)/11*a.H[b],++c),b=(b+1)%10;0!=c&&(a.D/=.5*c);a.m=(a.m+1)%10;setTimeout(a.j.bind(a),10)}
class Ua{constructor(){this.v=null;this.i=this.once=!1;this.H=Array(10).fill(0);this.m=this.D=this.L=0;this.g=[0,0]}h(){this.once=!0;L.clear();N.g=!1;O.clear();P.clear();F.clear();Q.clear();R.clear();H.clear()}message({data:a}){J.set(new Uint8Array(a));if(0==J.h)Ta(this);else{var b=S()-1;a=!1;b!=H.id&&(H.id=b,a=!0);b=S();var c=b&1;c&&!H.h?(H.h=!0,I.j.style.display="none",Oa(),I.F.style.display="block"):!c&&H.h&&(H.h=!1,Na(),I.G(),I.F.style.display="none",R.o=!1);(c=b&2)&&!H.g?(H.g=!0,I.j.style.display=
"none"):!c&&H.g&&(H.g=!1,Na(),R.o=!1);I.u.disabled=b&4;this.g[0]=this.g[1];this.g[1]=performance.now();b=O;c=b.h;for(var d=0;c;++d)void 0!=b.g[d]&&(b.g[d].x1=b.g[d].x2,b.g[d].y1=b.g[d].y2,b.g[d].r1=b.g[d].r2,--c);b=P;c=b.h;for(d=0;c;++d)void 0!=b.g[d]&&(b.g[d].x1=b.g[d].x2,b.g[d].y1=b.g[d].y2,b.g[d].r1=b.g[d].r2,--c);Va(N);for(b=!1;J.m<J.h;)switch(S()){case 0:b=!0;P.clear();c=Q;c.j=S();d=S();var e=S(),f=S();c.i=Array(S());for(var k=0;k<c.i.length;++k)c.i[k]=[(S()+.5)*f,(S()+.5)*f,S()];var q=k=0;for(var h=
0;h<d;++h){var y=0;for(var B=0;B<e;++B){var A=J.g[J.m];2!=A&&(C.setInt16(k,q,!0),k+=2,C.setInt16(k,y,!0),k+=2,C.setUint8(k++,f),C.setUint8(k++,pa[A]>>16),C.setUint8(k++,pa[A]>>8),C.setUint8(k++,pa[A]));++J.m;y+=f}q+=f}c.h.set(xa.slice(0,k),k>>3);c.width=d*f;c.height=e*f;c.g=f;break;case 1:c=O;d=S();for(e=0;e<d;++e)if(f=S(),void 0==c.g[f]){k=T();q=T();h=T();y=S();y=Wa(y);B=S();A=0;B&&(A=S());const M=S();0<M&&U(L,y,Wa(M));c.g[f]={x:0,y:0,r:0,x1:k,x2:k,y1:q,y2:q,r1:h,r2:h,name:y,M:B,N:A,O:0,T:!0};H.id==
f&&(f=N,f.g||(f.x2=k,f.y2=q));++c.h}else if(k=S(),0==k)delete c.g[f]&&--c.h;else{do{switch(k){case 1:c.g[f].x2=T();H.id==f&&(k=N,k.g||(k.x2=c.g[f].x2));break;case 2:c.g[f].y2=T();H.id==f&&(k=N,k.g||(k.y2=c.g[f].y2));break;case 3:c.g[f].r2=T();break;case 4:c.g[f].M=S();c.g[f].M&&(c.g[f].N=S());break;case 5:k=S();U(L,c.g[f].name,Wa(k));break;default:throw Error();}k=S()}while(k)}break;case 2:c=P;d=Xa();for(e=0;e<d;++e)if(f=Xa(),void 0==c.g[f])k=S()-1,q=T(),h=T(),y=T(),c.g[f]={type:k,x:0,y:0,r:0,x1:q,
x2:q,y1:h,y2:h,r1:y,r2:y,T:!1},++c.h;else if(k=S(),0==k)delete c.g[f]&&--c.h;else{do{switch(k){case 1:c.g[f].x2=T();break;case 2:c.g[f].y2=T();break;case 3:c.g[f].r2=T();break;default:throw Error();}k=S()}while(k)}break;case 3:c=L;d=S();for(e=0;e<d;++e)k=S(),f=(new TextDecoder).decode(J.g.subarray(J.m,J.m+k)),J.m+=k,k=S(),U(c,f,(new TextDecoder).decode(J.g.subarray(J.m,J.m+k))),J.m+=k;break;default:throw Error();}if(J.m>J.h)throw Error();if(-1==H.id)a=N,b=.5*Q.height,a.g||(a.x2=.5*Q.width,a.y2=b),
Va(a);else if(a||b)a=N,c=O.g[H.id].y2,a.g||(a.x2=O.g[H.id].x2,a.y2=c),b&&Va(N);0==this.g[0]||this.i||(this.i=!0,a=F,a.u=window.requestAnimationFrame(a.C.bind(a)),H.l())}}close(a){4E3==a?(Ya(),x.innerHTML="Server is full"):Ya()}j(){this.L=(new Date).getTime();this.v.send(new Uint8Array(0))}stop(){this.v.onopen=this.v.onmessage=this.v.onclose=null;this.v.close()}}
function Za(a){a.v=new WebSocket(a.l);a.v.binaryType="arraybuffer";a.v.onopen=a.h.bind(a);a.v.onmessage=a.message.bind(a);a.v.onclose=a.close.bind(a)}class Ja extends Ua{constructor(a,b,c=8){super();this.K=0;this.o=c;this.u=b;this.l=a;Za(this)}h(){this.j()}message(){Ta(this);++this.K==this.o&&this.u(this.v.url)}close(){Za(this)}}function Ra(a){var b=J;b.g[0]=4;b.g[1]=a;b.h=2}function Sa(){var a=J;0==la.length?a.h=1:(a.g.set(la),a.h=la.length)}function S(){var a=J;return a.g[a.m++]}
function Xa(){var a=J;const b=a.g[a.m]|a.g[a.m+1]<<8;a.m+=2;return b}function T(){var a=J;const b=a.view.getFloat32(a.m,!0);a.m+=4;return b}function Wa(a){var b=J;const c=(new TextDecoder).decode(b.g.subarray(b.m,b.m+a));b.m+=a;return c}function Qa(a){if(!H.i){H.i=!0;a.g[0]=3;var b=I;b=(new TextEncoder).encode(b.name.value);a.g.set(b,1);a.h=b.length+1;K(G)}}
class $a{constructor(){this.i=new ArrayBuffer(1048576);this.g=new Uint8Array(this.i);this.view=new DataView(this.i);this.m=this.h=0}set(a){this.g.set(a);this.h=a.length;this.m=0}clear(){this.m=this.h=0}}
class ab{constructor(){this.canvas=w("canvas");this.g=this.canvas.getContext("2d");this.size=0;this.h()}h(){this.size=u.death_arrow_size.value;this.canvas.width=this.canvas.height=this.size;const a=.5*this.canvas.width,b=this.canvas.width;this.g.beginPath();this.g.moveTo(a+.45*b,a);this.g.lineTo(a-.225*b,a-.675*b/Math.sqrt(3));this.g.lineTo(a-.225*b,a+.675*b/Math.sqrt(3));this.g.closePath();this.g.fillStyle="#bbbbbbb0";this.g.fill();this.g.lineWidth=.1*a;this.g.strokeStyle="#f00";this.g.stroke()}}
function bb(a){void 0==l("tth_tooltip")&&(a.J.innerHTML='Try "/help"',a.C.style.display="inline-block")}function U(a,b,c,d=!1){const e=w("p");e.appendChild(document.createTextNode((d?"":b+": ")+c));a.h.insertBefore(e,a.h.firstChild);++a.i>u.max_chat_messages.value&&a.h.removeChild(a.h.lastChild)}function cb(a){a.g.value="";a.g.blur();F.j.focus()}function db(a,b){a.A=a.g.placeholder;a.g.placeholder=b;a.g.disabled=!0;a.g.value="";F.j.focus()}
function eb(){var a=L;!a.u&&u.chat_on&&(a.B.style.display="block")}
class fb{constructor(){this.o=Array(5).fill(0);this.j=0;this.B=v("ID_chat");this.h=v("ID_messages");this.g=v("ID_sendmsg");this.C=v("ID_try_typing_help");this.J=v("ID_try_typing_help_tooltip");bb(this);this.I=oa(128);this.i=0;this.u=!1;this.A="";this.l=-1;this.g.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=this.g.value.trim();switch(a){case "/help":U(this,null,">",!0);U(this,null,"Available commands:",!0);U(this,null,"/clear /c => clear the chat",!0);U(this,null,"/respawn /r => tp to the first area",
!0);U(this,null,"/die /d => become downed",!0);U(this,null,"/menu /m => quit the game and open the menu",!0);U(this,null,"/spectate /s => start/stop spectating",!0);U(this,null,">",!0);cb(this);aa("tth_tooltip","");this.C.style.display="none";return;case "/c":case "/clear":this.h.innerHTML="";this.i=0;cb(this);return}a=(new TextEncoder).encode(a);if(0<a.length){var b=J;Qa(b);b.g[0]=2;b.g.set(a,1);b.h=a.length+1;K(G);this.o[this.j]=(new Date).getTime();a=(this.j+1)%5;b=5E3-this.o[this.j]+this.o[a];
this.j=a;0<b?(db(this,"You are on cooldown for sending too many messages too quickly"),this.l=setTimeout(this.enable.bind(this),b)):cb(this)}}}.bind(this);this.g.onkeyup=function(a){a.stopPropagation()};this.g.onkeypress=this.g.onpaste=this.I}clear(){this.o=Array(5).fill(0);this.j=0;this.h.innerHTML="";this.i=0;this.u=!1;this.A="Press enter to chat";this.enable()}enable(){-1!=this.l&&(clearTimeout(this.l),this.l=-1);this.g.disabled=!1;this.g.placeholder=this.A}focus(){this.g.focus()}F(){for(;this.i>
u.max_chat_messages.value;)this.h.removeChild(this.h.lastChild),--this.i}G(){this.h.style["font-size"]=u.chat_text_scale.value+"em"}}function Va(a){a.x1=a.x2;a.y1=a.y2}function V(a,b,c){var d=N;d.x2=z(d.x2,a,c);d.y2=z(d.y2,b,c)}class gb{constructor(){this.y2=this.x2=this.y1=this.x1=this.y=this.x=0;this.g=!1}block(){this.g=!0}}class hb{constructor(){this.g=Array(100);this.h=0}clear(){this.g=Array(100);this.h=0}}
class ib{constructor(){this.g=Array(65535);this.h=0}clear(){this.g=Array(65535);this.h=0}}function jb(){var a=kb;a.g=!0;return new Promise(function(b){a.h=function(c){a.g=!1;b(c)}})}class lb{constructor(){this.h=null;this.g=!1}}class mb{constructor(){this.i=this.g=0;this.h=null}progress(){0==this.g?u.show_tutorial&&H.g&&(this.g=1,this.i=F.i,F.i=1.75,N.block(),nb(),R.stop(),R.block()):7==++this.g&&(this.h.click(),this.g=0,F.i=this.i,N.g=!1,W.g=!1,R.g=!1,R.start())}}
function nb(){var a=W;a.i&&(a.g=!1,ob(a));a.g=!0}
function pb(a){a.l.innerHTML="";qb(a,"CHAT");a.add(a.text("Show chat"),X("chat_on",function(b){b?eb():(b=L,b.u||(b.B.style.display="none"))}));a.add(a.text("Max number of chat messages"),rb(a,"max_chat_messages","",L.F.bind(L)));a.add(a.text("Chat text scale"),rb(a,"chat_text_scale","",L.G.bind(L)));qb(a,"MENU");a.add(a.text("Show latency"),X("show_ping",I.P.bind(I)));qb(a,"GAME");sb.h=X("show_tutorial");a.add(a.text("Enable tutorial"),sb.h);qb(a,"VISUALS");a.add(a.text("Default FOV"),rb(a,"fov"));
a.add(a.text("Draw balls' fill"),X("draw_ball_fill"));a.add(a.text("Draw balls' stroke"),X("draw_ball_stroke"));a.add(a.text("Draw stroke-only balls with brighter color"),X("draw_ball_stroke_bright"));a.add(a.text("Balls' stroke radius percentage"),rb(a,"ball_stroke","%"));a.add(a.text("Draw players' fill"),X("draw_player_fill"));a.add(a.text("Draw players' stroke"),X("draw_player_stroke"));a.add(a.text("Draw stroke-only players with brighter color"),X("draw_player_stroke_bright"));a.add(a.text("Players' stroke radius percentage"),
rb(a,"player_stroke","%"));a.add(a.text("Draw players' name"),X("draw_player_name"));a.add(a.text("Draw an arrow towards dead players"),X("draw_death_arrow"));a.add(a.text("Death arrow size"),rb(a,"death_arrow_size","px",tb.h.bind(tb)));qb(a,"KEYBINDS");ub(a,vb("h5","To change, click a button on the right side and then press the key you want to assign to it."));a.add(a.text("Settings"),Y("settings"));a.add(a.text("Move up"),Y("up"));a.add(a.text("Move left"),Y("left"));a.add(a.text("Move down"),Y("down"));
a.add(a.text("Move right"),Y("right"));a.add(a.text("Move slowly"),Y("slowwalk"));a.add(a.text("Spectate the previous player"),Y("spec_prev",I.l.bind(I)));a.add(a.text("Spectate the next player"),Y("spec_next",I.l.bind(I)));qb(a,"RESET");a.add(a.text("Reset settings"),a.button("RESET",function(){u=JSON.parse(JSON.stringify(t));ja();pb(this)}.bind(a)));a.add(a.text("Reset keybinds"),a.button("RESET",function(){r=JSON.parse(JSON.stringify(ea));ha();pb(this)}.bind(a)));a.add(a.text("Reset all tooltips"),
a.button("RESET",function(){ba("psfy_tooltip");La(I);ba("tth_tooltip");bb(L)}));a.end()}function ob(a){a.g||(a.i=!1,a.j.style.display="none",R.g=!1,R.start())}function ub(a,b){a.l.appendChild(b)}function qb(a,b){a.end();ub(a,vb("h1",b));a.h=w("table")}function vb(a,b){a=w(a);a.innerHTML=b;return a}
function X(a,b=function(){}){const c=w("button");u[a]=!u[a];let d=!0;c.onclick=function(){u[a]=!u[a];1==u[a]?(c.innerHTML="ON",c.style["background-color"]="#23c552"):(c.innerHTML="OFF",c.style["background-color"]="#f84f31");ja();d?d=!1:b(u[a])};c.onclick();return c}function Y(a,b=function(){}){const c=w("button");c.innerHTML=r[a];c.onclick=async function(){c.innerHTML="...";const d=await jb();c.innerHTML=d;r[a]=d;ha();b()};c.style.color="#000";return c}
function rb(a,b,c="",d=function(){}){const e=w("div");e.className="input";const f=w("input");f.type="range";f.min=u[b].min;f.max=u[b].max;f.step=u[b].step;f.value=u[b].value;f.oninput=function(){f.nextElementSibling.innerHTML=f.value+c;u[b].value=f.valueAsNumber;d()};f.onchange=ja;e.appendChild(f);e.appendChild(a.text(f.value+c));return e}
class wb{constructor(){this.j=v("ID_settings_container");this.l=v("ID_settings");this.g=this.i=!1;this.h=null;pb(this)}add(a,b){const c=w("tr");let d=w("td");d.appendChild(a);c.appendChild(d);d=w("td");d.appendChild(b);b.onchange=ja;c.appendChild(d);this.h.appendChild(c)}end(){null!=this.h&&(ub(this,this.h),this.h=null)}text(a){return vb("h3",a)}button(a,b){const c=w("button");c.innerHTML=a;c.onclick=b;return c}}
class xb{constructor(){this.A=Aa("ID_canvas");this.j=v("ID_text");this.g=this.j.getContext("2d");this.o=new Ga(this.A);this.i=this.h=u.fov.value;this.u=-1;this.B=this.l=0;this.j.onwheel=this.G.bind(this);this.j.onmousedown=this.F.bind(this)}clear(){this.i=this.h=u.fov.value;cancelAnimationFrame(this.u);this.u=-1;this.B=this.l=0}G(a){a=.05*-Math.sign(a.deltaY);this.i=1<this.i?this.i+3*a:this.i+a;this.i=p(ca(this.i,u.fov.min),u.fov.max)}F(){R.o=!R.o;Z(R)}text(a,b,c){this.g.font="700 20px Ubuntu";this.g.textAlign=
"center";this.g.textBaseline="middle";this.g.fillStyle="#fff";this.g.strokeStyle="#333";this.g.lineWidth=1;this.g.fillText(a,b,c);this.g.strokeText(a,b,c)}C(a){this.l=p(ca(this.l,G.g[0]),G.g[1]);var b=this.h;this.h=z(this.h,this.i,.1);this.h!=b&&Z(R);b=G.g[0]==G.g[1]?1:(this.l-G.g[0])/(G.g[1]-G.g[0]);this.l+=a-this.B;this.B=a;u.show_ping&&(I.A.innerHTML=G.D.toFixed(1)+"ms");N.x=z(N.x1,N.x2,b);N.y=z(N.y1,N.y2,b);a=new DOMMatrix;this.g.setTransform(a);this.g.clearRect(0,0,this.j.width,this.j.height);
a=a.translate(.5*D.width,.5*D.height).scale(this.h,this.h).translate(-N.x,-N.y);this.g.setTransform(a);a=this.A;a.canvas.width!=D.width&&(a.canvas.width=D.width);a.canvas.height!=D.height&&(a.canvas.height=D.height);a.viewport(0,0,a.canvas.width,a.canvas.height);a.clearColor(.2,.2,.2,1);a.clear(E.COLOR_BUFFER_BIT|E.DEPTH_BUFFER_BIT);a.enable(E.DEPTH_TEST);a.enable(E.BLEND);a.blendFunc(E.SRC_ALPHA,E.ONE_MINUS_SRC_ALPHA);a=Q;a.h.matrix=new za;var c=a.h.matrix.translate(.5*D.width,.5*D.height),d=F.h;
ya(c,new Float32Array([d,0,0,0,d,0,0,0,1])).translate(-N.x,-N.y);c=a.h;Ca(c);c.g.uniform1f(c.o,.8);c.g.bindBuffer(E.ARRAY_BUFFER,c.l);c.g.bufferData(E.ARRAY_BUFFER,c.A,E.DYNAMIC_DRAW);c.g.drawArraysInstanced(E.TRIANGLE_STRIP,0,10,c.i);c.g.uniform1f(c.o,1);c.g.bindBuffer(E.ARRAY_BUFFER,c.l);c.g.bufferData(E.ARRAY_BUFFER,c.model,E.DYNAMIC_DRAW);c.g.drawArraysInstanced(E.TRIANGLE_STRIP,0,4,c.i);F.g.font=`700 ${a.g/1.75|0}px Ubuntu`;F.g.textAlign="center";F.g.textBaseline="middle";c=F.g;d=va[3];d="#"+
(.8*parseInt(d.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(d.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(d.substring(5,7),16)>>0).toString(16).padStart(2,"0")+d.substring(7);c.fillStyle=d;for(var e of a.i)F.g.fillText(e[2],e[0],e[1]);this.o.matrix=Q.h.matrix;e=0;a=P.h;for(c=0;a;++c)d=P.g[c],void 0!=d&&(--a,d.x=z(d.x1,d.x2,b),C.setFloat32(e,d.x,!0),e+=4,d.y=z(d.y1,d.y2,b),C.setFloat32(e,d.y,!0),e+=4,d.r=z(d.r1,d.r2,b),C.setFloat32(e,d.r,!0),e+=4,C.setUint32(e,
wa[d.type]),e+=4);this.o.set(xa.slice(0,e),e>>4);Fa(this.o,u.draw_ball_fill,u.draw_ball_stroke,u.ball_stroke.value/100,u.draw_ball_stroke_bright);e=0;a=O.h;for(c=0;a;++c)if(d=O.g[c],void 0!=d&&(--a,d.x=z(d.x1,d.x2,b),C.setFloat32(e,d.x,!0),e+=4,d.y=z(d.y1,d.y2,b),C.setFloat32(e,d.y,!0),e+=4,d.r=z(d.r1,d.r2,b),C.setFloat32(e,d.r,!0),e+=4,C.setUint32(e,3958108415),e+=4,u.draw_player_name&&0!=d.name.length&&(this.g.font=`700 ${d.r/this.h}px Ubuntu`,this.g.textAlign="center",this.g.textBaseline="middle",
this.g.fillStyle="#00000080",d.O=z(d.O,1<this.h?.5*d.r:.5*d.r+2/(this.h*this.h),.1),this.g.fillText(d.name,d.x,d.y-d.r-d.O)),d.M&&(this.g.font=`700 ${d.r/p(this.h,1)}px Ubuntu`,this.g.textAlign="center",this.g.textBaseline="middle",this.g.fillStyle="#f00",this.g.fillText(d.N,d.x,d.y),u.draw_death_arrow))){var f=void 0,k=void 0;f=.75*tb.size;f*=F.h;k=.5*D.width+(d.x-N.x)*F.h;const y=.5*D.height+(d.y-N.y)*F.h;var q=!1;if(0>k||k>D.width-0)q=!0,k=ca(p(k,D.width-f),f);0>y||y>D.height-0?(q=!0,f=ca(p(y,
D.height-f),f)):f=y;const [B,A,M]=[(k-.5*D.width)/F.h+N.x,(f-.5*D.height)/F.h+N.y,q];M&&(this.g.translate(B,A),f=Math.atan2(d.y-A,d.x-B),this.g.rotate(f),q=tb,this.g.drawImage(q.canvas,.5*-q.size,.5*-q.size),this.g.rotate(-f),this.g.font=`700 ${.3*tb.size}px Ubuntu`,this.g.fillText(d.N,0,0),this.g.translate(-B,-A))}this.o.set(xa.slice(0,e),e>>4);Fa(this.o,u.draw_player_fill,u.draw_player_stroke,u.player_stroke.value/100,u.draw_player_stroke_bright);switch(sb.g){case 0:u.show_tutorial&&0==Q.j&&F.text("Need help? Press KeyT for a tutorial.",
.5*Q.width,2.5*Q.g);break;case 1:V(O.g[H.id].x2,O.g[H.id].y2,.2*b);F.text("<-- Your character",N.x+110,N.y);F.text("Your character --\x3e",N.x-110,N.y);F.text("This is your character. You can control it with these keys:",N.x,N.y-220);F.text(`${r.up}: up`,N.x,N.y-170);F.text(`${r.left}: left`,N.x,N.y-130);F.text(`${r.down}: down`,N.x,N.y-90);F.text(`${r.right}: right`,N.x,N.y-50);F.text("You can also control it with mouse. Just",N.x,N.y+50);F.text("press any mouse button to start or stop moving.",
N.x,N.y+70);F.text("Scroll to change your field of view.",N.x,N.y+110);F.text("Note that you won't be able to perform some",N.x,N.y+150);F.text("of the above actions until the tutorial ends.",N.x,N.y+170);F.text("Press KeyT to continue",N.x,N.y+220);break;case 2:var h=.5*Q.width-6*Q.g;e=.5*Q.height;V(h,e,.2*b);F.text("--\x3e",h+2*Q.g,e-1*Q.g);F.text("--\x3e",h+2*Q.g,e);F.text("--\x3e",h+2*Q.g,e+1*Q.g);F.text("<--",h-2*Q.g,e-2*Q.g);F.text("<--",h-3*Q.g,e-1*Q.g);F.text("<--",h-4*Q.g,e);F.text("<--",
h-3*Q.g,e+1*Q.g);F.text("<--",h-2*Q.g,e+2*Q.g);F.text("These are safezones. Enemies can't",h,e-130);F.text("reach you inside of these tiles.",h,e-110);F.text("Press KeyT to continue",h,e+110);break;case 3:h=.5*Q.width+6*Q.g;e=.5*Q.height;V(h,e,.2*b);F.text("<--",h-2*Q.g,e-2*Q.g);F.text("<--",h-1*Q.g,e-3*Q.g);F.text("<--",h,e-4*Q.g);F.text("<--",h-2*Q.g,e+2*Q.g);F.text("<--",h-1*Q.g,e+3*Q.g);F.text("<--",h,e+4*Q.g);F.text("--\x3e",h+2*Q.g,e-3*Q.g);F.text("--\x3e",h+2*Q.g,e+3*Q.g);F.text("<--",h+5*
Q.g,e-2*Q.g);F.text("<--",h+6*Q.g,e-1*Q.g);F.text("<--",h+7*Q.g,e);F.text("<--",h+6*Q.g,e+1*Q.g);F.text("<--",h+5*Q.g,e+2*Q.g);F.text("These are walls. Players can't walk over them.",h,e-40);F.text("However, some types (colors) of enemies can.",h,e-10);F.text("Press KeyT to continue",h,e+40);break;case 4:h=.5*Q.g;e=.5*Q.height;V(h,e,.2*b);F.text("--\x3e",h,e);F.text("This is a teleport tile. If you walk on it,",h,e-130);F.text("you will be teleported to the area it points to.",h,e-110);F.text("Minimap is not yet implemented, but once it is, you",
h,e-70);F.text("will be able to see where any area is located at.",h,e-50);F.text("If a teleport doesn't have a number on it, it doesn't point",h,e+50);F.text("anywhere (perhaps because the next area is under construction).",h,e+70);F.text("Press KeyT to continue",h,e+120);break;case 5:for(e=0;65535>e;++e)if(P.g[e]){h=P.g[e];break}e=h.x2;h=h.y2;V(e,h,.2*b);F.text("Enemy ball --\x3e",e-110,h);F.text("<-- Enemy ball",e+110,h);F.text("This is an enemy, also simply called a ball. A grey ball",e,h-110);
F.text("doesn't do a lot - it simply moves in one direction. However,",e,h-90);F.text("as you are about to find out when you start exploring the game,",e,h-70);F.text("there are lots of types of enemies, each having their own color.",e,h-50);F.text("Coming in contact with an enemy downs you. While downed, you can't move,",e,h+50);F.text("and after a while, you die, unless other players revive you by touching you.",e,h+70);F.text("Press KeyT to continue",e,h+120);break;case 6:h=O.g[H.id].x2,e=O.g[H.id].y2,
V(h,e,.2*b),F.text(`You can press ${r.settings} to open settings.`,h,e-80),F.text("There are a lot of cool options to change. Try it out later.",h,e-60),F.text("That's it for this tutorial. See how far you can go!",h,e+60),F.text("GLHF!",h,e+80),F.text("Press KeyT to end the tutorial",h,e+130)}this.u=window.requestAnimationFrame(this.C.bind(this))}}class yb{constructor(){this.h=new Ea;this.g=this.height=this.width=0;this.i=[];this.j=-1}clear(){this.j=-1}}
class zb{constructor(){this.height=this.width=this.h=this.i=this.g=0;this.j=[0,0];window.onresize=this.l.bind(this);window.onkeyup=this.A.bind(this);window.onkeydown=this.u.bind(this);window.onmousemove=this.B.bind(this);window.onbeforeunload=this.o.bind(this)}l(){if(window.devicePixelRatio!=this.g||window.innerWidth!=this.i||window.innerHeight!=this.h){this.g=window.devicePixelRatio;this.i=window.innerWidth;this.h=window.innerHeight;this.width=this.i*this.g;this.height=this.h*this.g;var a=F;a.j.width!=
D.width&&(a.j.width=D.width);a.j.height!=D.height&&(a.j.height=D.height)}}u(a){if(!a.repeat)if(kb.g)a.preventDefault(),kb.h(a.code);else if(a.code==r.settings)W.i?ob(W):(a=W,a.g||(a.i=!0,a.j.style.display="block",R.stop(),R.block()));else{if(H.h)switch(a.code){case r.spec_prev:Ra(-1);K(G);break;case r.spec_next:Ra(1),K(G)}switch(a.code){case "Enter":L.focus(a);break;case r.up:R.A||(R.A=1,Z(R));break;case r.down:R.l||(R.l=1,Z(R));break;case r.left:R.i||(R.i=1,Z(R));break;case r.right:R.j||(R.j=1,Z(R));
break;case r.slowwalk:1==R.u&&(Ab(.5),Z(R));break;case "KeyT":sb.progress()}}}A(a){if(!a.repeat)switch(a.code){case r.up:R.A&&(R.A=0,Z(R));break;case r.down:R.l&&(R.l=0,Z(R));break;case r.left:R.i&&(R.i=0,Z(R));break;case r.right:R.j&&(R.j=0,Z(R));break;case r.slowwalk:.5==R.u&&(Ab(1),Z(R))}}B(a){this.j=[a.clientX*this.g,a.clientY*this.g];Z(R)}o(a){if(H.g)return a.preventDefault(),a.returnValue="Are you sure you want to quit?"}}
function Z(a){if(H.g&&!a.g){a=J;let c=0;var b=0;if(R.o){b=D.j[0]-.5*D.width;const d=D.j[1]-.5*D.height;c=Math.atan2(d,b);b=Math.hypot(b,d)/F.h}else if(R.A!=R.l||R.i!=R.j)c=Math.atan2(R.l-R.A,R.j-R.i),b=160*D.g;a.g[0]=1;a.view.setFloat32(1,c,!0);a.g[5]=b>=160*D.g?255*R.h:1.59375*b/D.g*R.h;a.h=6;K(G)}}function Ab(a){var b=R;b.g||(b.h=a);b.u=a}
class Bb{constructor(){this.o=!1;this.h=this.u=1;this.g=!1;this.j=this.i=this.l=this.A=0}clear(){this.o=this.g=!1;this.h=this.u=1}block(){this.g=!0}stop(){this.g||(this.u=this.h,this.h=0,Z(this))}start(){this.g||(this.h=this.u,Z(this))}}function Ia(){var a=H;x.innerHTML="Connecting";a.j?(Na(),I.name.style.display="none",eb(),db(L,"Waiting for connection..."),nb()):a.j=!0}
function Ya(){H.g=!1;x.innerHTML="Disconnected";Na();var a=I;G.once||ma();a.name.style.display="none";a.B.style.display="none";a.u.style.display="none";a.C.style.display="block";clearInterval(a.I);nb()}class Cb{constructor(){this.i=this.h=this.g=!1;this.id=-1;this.j=!1}clear(){this.i=this.h=this.g=!1;this.id=-1}l(){Na();I.name.style.display="block";x.innerHTML="";eb();L.enable();W.g=!1}}
const I=new Pa,G=new Ua,J=new $a,tb=new ab,L=new fb,N=new gb,O=new hb,P=new ib,kb=new lb,sb=new mb,W=new wb,F=new xb,Q=new yb,D=new zb,R=new Bb,H=new Cb;D.l();
(async function(){Ia();let a;var b=new Promise(function(e){a=e});const c=[];for(const [,,e]of I.o)c[c.length]=new Ja(e,a);setTimeout(a,2E3,"");b=await b;let d;if(0==b.length){b=0;for(const e of c)e.v.readyState==WebSocket.OPEN&&e.K>b&&(b=e.K,d=e.v.url)}else d=b;if(void 0==d)throw x.innerHTML="Couldn't connect to any server",ma(),Error(x.innerHTML);for(const e of c)e.v.url!=d?e.stop():Ka(e);Ma()})();
