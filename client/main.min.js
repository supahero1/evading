let c=document.getElementById("loading");c.innerHTML="Fetching servers...";
let ca=document.getElementById("sub"),d=document.getElementById("name"),n=document.getElementById("canvas"),p=n.getContext("2d"),q=document.createElement("canvas"),r=q.getContext("2d"),u=document.createElement("canvas"),da=u.getContext("2d"),ea=0,fa=["#dddddd","#aaaaaa","#333333","#fedf78"],ha=["#808080","#fc46aa","#008080","#ff8e06","#d2b48c"],v=Array(ha.length),ia=0,ja=0,w=0,ka=new ArrayBuffer(524288),x=new Uint8Array(ka),y=new DataView(x.buffer),z=0,A=0,B=Array(256),C=[];
var la=0,ma=0,na=0,D=0,oa=0,E=0;let F=[0,0],H=null,pa=0,qa=0,ra=0,sa=0;var I=0,J=0,K=0,L=0,M=1,O=0,ta=0,P=0,S=0,T=0,U=0,V=[],W=[];let X=1,Y=X,Z=[0,0];window.s.then(f=>f.json()).then(f=>ua(f));function xa(){setTimeout(location.reload.bind(location),1E3)}
function ua(f){if(0==f.length)c.innerHTML="No servers found",xa();else{c.innerHTML="Connecting...";var G=f.map(function(k){k=new WebSocket(k[1]);k.binaryType="arraybuffer";k.i=[];k.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};k.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return k});setTimeout(function(){let k=999999,m=null;for(let l of G){l.h=0;for(let t of l.i)l.h+=t;0<l.i.length?l.h/=l.i.length:
l.h=999999;l.h<k&&(k=l.h,m=l)}for(let l of G)l.onopen=function(){},l.onmessage=function(){},delete l.i,delete l.time,delete l.h,l!=m&&l.close();null==m||1!=m.readyState?(c.innerHTML="Failed connecting",xa()):ya(m)},1E3)}}function za(){na=D;oa=E;for(let f of B)f&&(f.g.x1=f.g.x2,f.g.y1=f.g.y2,f.g.r1=f.g.r2);for(let f of C)f&&(f.g.x1=f.g.x2,f.g.y1=f.g.y2,f.g.r1=f.g.r2)}
function ya(f){c.innerHTML="Enter your name<br>";ca.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";d.style.display="block";let G=window.localStorage.getItem("name");G&&(d.value=G);d.onkeypress=d.onblur=d.onpaste=function(k){let m=k.target.value+k.key;4<(new TextEncoder).encode(m).byteLength?k.target.value=k.target.m||"":(k.target.value=m,k.target.m=m);k.preventDefault();return!1};f.onclose=function(){window.onbeforeunload=function(){};
n.parentElement.removeChild(n);c.innerHTML="Disconnected";ca.innerHTML="";d.style.display="none";xa()};window.onkeydown=function(k){13==(k.keyCode||k.which)&&(window.localStorage.setItem("name",d.value),c.innerHTML="Spawning...",ca.innerHTML="",d.style.display="none",k=(k=window.localStorage.getItem("token"))?k.split(",").map(m=>+m):[],f.send(new Uint8Array([...(new TextEncoder).encode(d.value),0,...k])),Aa(f))}}
function Aa(f){function G({data:a}){x.set(new Uint8Array(a));z=a.byteLength;a=x[0]|x[1]<<8|x[2]<<16|x[3]<<24;if(0!=aa&&4!=a-aa)throw f.onmessage=function(){},Error(`tick - last_tick = ${a-aa}`);aa=a;a=4;Z[0]=Z[1];Z[1]=performance.now();za();if(a!=z){if(0==x[a]){++a;pa=1;C=[];A=x[a++];a+=2;S=x[a]|x[a+1]<<8;a+=2;T=x[a]|x[a+1]<<8;a+=2;U=x[a++];V=Array(256);W=Array(256);for(var g=0;g<S;++g)for(var e=0;e<T;++e)null==V[x[a]]&&(V[x[a]]=new Path2D,W[x[a]]=new Path2D),V[x[a]].rect(4*(1.5+g*U),4*(1.5+e*U),
4*(U-3),4*(U-3)),W[x[a]].rect(g*U*4,e*U*4,4*U,4*U),++a;q.width=U*S*4;q.height=U*T*4;u.width=U*S*4;u.height=U*T*4;for(g=0;256>g;++g)V[g]&&(r.fillStyle=fa[g]+"b0",r.fill(W[g]),r.fillStyle=fa[g],r.fill(V[g]),da.fillStyle=fa[g],da.fill(W[g]));ea||(requestAnimationFrame(va),ea=1)}if(a!=z){if(1==x[a])for(++a,g=x[a++],e=0;e<g;++e){var b=x[a++];if(B[b]){var h=x[a++];if(h)for(;h;){switch(h){case 1:B[b].g.x2=y.getFloat32(a,!0);a+=4;A==b&&(D=B[b].g.x2);break;case 2:B[b].g.y2=y.getFloat32(a,!0);a+=4;A==b&&(E=
B[b].g.y2);break;case 3:B[b].g.r2=y.getFloat32(a,!0);a+=4;break;case 4:B[b].j=x[a++],B[b].j&&(B[b].l=x[a++])}h=x[a++]}else B[b]=void 0}else{h=y.getFloat32(a,!0);a+=4;var N=y.getFloat32(a,!0);a+=4;var Q=y.getFloat32(a,!0);a+=4;var R=x[a++],ba=(new TextDecoder).decode(x.subarray(a,a+R));a+=R;R=x[a++];let wa=0;R&&(wa=x[a++]);B[b]={x:0,y:0,r:0,g:{x1:h,x2:h,y1:N,y2:N,r1:Q,r2:Q},name:ba,j:R,l:wa};A==b&&(D=h,E=N)}}if(a!=z&&2==x[a])for(++a,g=x[a]|x[a+1]<<8,a+=2,e=0;e<g;++e)if(b=x[a]|x[a+1]<<8,a+=2,C[b])if(h=
x[a++])for(;h;){switch(h){case 1:C[b].g.x2=y.getFloat32(a,!0);a+=4;break;case 2:C[b].g.y2=y.getFloat32(a,!0);a+=4;break;case 3:C[b].g.r2=y.getFloat32(a,!0);if(1>C[b].g.r2||60<C[b].g.r2)throw console.log(`update ball id ${b} r ${C[b].g.r2}`),f.onmessage=function(){},Error();a+=4}h=x[a++]}else C[b]=void 0;else if(h=x[a++],0!=h&&(--h,N=y.getFloat32(a,!0),a+=4,Q=y.getFloat32(a,!0),a+=4,ba=y.getFloat32(a,!0),a+=4,C[b]={type:h,x:0,y:0,r:0,g:{x1:N,x2:N,y1:Q,y2:Q,r1:ba,r2:ba}},1>C[b].g.r2||60<C[b].g.r2))throw console.log(`create ball id ${b} r ${C[b].g.r2}`),
f.onmessage=function(){},Error();}}}function k(){if(window.innerWidth!=ia||window.innerHeight!=ja||w!=window.devicePixelRatio)w=window.devicePixelRatio,ia=window.innerWidth,n.width=ia*w,ja=window.innerHeight,n.height=ja*w}function m(a,g,e){return a+(g-a)*e}function l(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function t(){ta||
(I||J||K||L?(O=Math.atan2(L-I,K-J),P=160*w):P=O=0);y.setFloat32(0,O,!0);P>=160*w?y.setUint8(4,255*M>>>0):y.setUint8(4,1.59375*P/w*M>>>0);f.send(x.subarray(0,5))}function va(a){if(0!=Z[0]){H?H<Z[0]?H=Z[0]:H>Z[1]&&(H=Z[1]):H=Z[0];var g=X;X=m(X,Y,.1);X!=g&&(P=Math.hypot(F[0]-n.width/2,F[1]-n.height/2)/X,t());g=Z[0]==Z[1]?0:(H-Z[0])/(Z[1]-Z[0]);H+=a-sa;sa=a;la=m(na,D,g);ma=m(oa,E,g);p.resetTransform();p.fillStyle="#333";p.fillRect(0,0,n.width,n.height);p.translate(n.width/2,n.height/2);p.scale(X,X);p.translate(-la,
-ma);p.drawImage(q,0,0,q.width/4,q.height/4);1>X&&(p.globalAlpha=1-X*X,p.drawImage(u,0,0,q.width/4,q.height/4),p.globalAlpha=1);a=new Path2D;for(var e of B)e&&(e.x=m(e.g.x1,e.g.x2,g),e.y=m(e.g.y1,e.g.y2,g),e.r=m(e.g.r1,e.g.r2,g),a.moveTo(e.x+e.r-2,e.y),a.arc(e.x,e.y,e.r-2,0,2*Math.PI));p.beginPath();p.fillStyle="#ebecf0";p.strokeStyle=l("#ebecf0");p.lineWidth=4;p.stroke(a);p.fill(a);for(e=0;e<v.length;++e)v[e]=new Path2D;for(var b of C)b&&(b.x=m(b.g.x1,b.g.x2,g),b.y=m(b.g.y1,b.g.y2,g),b.r=m(b.g.r1,
b.g.r2,g),v[b.type].moveTo(b.x+b.r-2,b.y),v[b.type].arc(b.x,b.y,b.r-2,0,2*Math.PI));p.beginPath();p.lineWidth=4;for(b=0;b<v.length;++b)p.fillStyle=ha[b],p.strokeStyle=l(ha[b]),p.stroke(v[b]),p.fill(v[b]);for(let h of B)h&&(p.beginPath(),0!=h.name.length&&(p.font=`700 ${h.r/X}px Ubuntu`,p.textAlign="center",p.textBaseline="middle",p.fillStyle="#00000080",ra=1<X?.5*h.r:.5*h.r+2/(X*X),qa=m(qa,ra,.1),p.fillText(h.name,h.x,h.y-h.r-qa)),h.j&&(p.font=`700 ${h.r/Math.min(X,1)}px Ubuntu`,p.textAlign="center",
p.textBaseline="middle",p.fillStyle="#f00",p.fillText(h.l,h.x,h.y)))}requestAnimationFrame(va)}let aa=0;f.onmessage=function(a){pa=0;G(a);pa&&(c.innerHTML="",za())};k();window.onresize=k;window.onwheel=function(a){a=.05*-Math.sign(a.deltaY);Y=1<Y?Y+3*a:Y+a;Y=Math.min(Math.max(Y,.25),4)};window.onmousemove=function(a){F=[a.clientX*w,a.clientY*w];O=Math.atan2(F[1]-n.height/2,F[0]-n.width/2);P=Math.hypot(F[0]-n.width/2,F[1]-n.height/2)/X;t()};window.onmousedown=function(){ta=!ta;O=Math.atan2(F[1]-n.height/
2,F[0]-n.width/2);P=Math.hypot(F[0]-n.width/2,F[1]-n.height/2)/X;t()};window.onkeydown=function(a){switch(a.keyCode||a.which){case 16:1==M&&(M=.5,t());break;case 87:case 38:I||(I=1,t());break;case 65:case 37:J||(J=1,t());break;case 68:case 39:K||(K=1,t());break;case 83:case 40:L||(L=1,t())}};window.onkeyup=function(a){switch(a.keyCode||a.which){case 16:.5==M&&(M=1,t());break;case 87:case 38:I&&(I=0,t());break;case 65:case 37:J&&(J=0,t());break;case 68:case 39:K&&(K=0,t());break;case 83:case 40:L&&
(L=0,t())}};window.onbeforeunload=function(a){a.preventDefault();return a.returnValue="Are you sure you want to quit?"};n.oncontextmenu=function(a){a.preventDefault();return!1}};
