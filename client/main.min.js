let e=document.getElementById("loading");e.innerHTML="Fetching servers...";
let ba=document.getElementById("sub"),g=document.getElementById("name"),k=document.getElementById("canvas"),n=k.getContext("2d"),q=document.createElement("canvas"),r=q.getContext("2d"),t=document.createElement("canvas"),ca=t.getContext("2d"),da=0,ea=["#dddddd","#aaaaaa","#333333","#fedf78"],fa=["#808080","#fc46aa","#008080","#ff8e06","#d2b48c"],u=Array(fa.length),ha=0,ia=0,w=0,ja=new ArrayBuffer(524288),y=new Uint8Array(ja),z=new DataView(y.buffer),A=0,B=0,C=Array(256),D=[];
var ka=0,la=0,ma=0,E=0,na=0,F=0;let G=[0,0],H=null,oa=0,pa=0,qa=0;var I=0,J=0,K=0,L=0,M=1,N=0,ra=0,O=0,R=0,S=0,T=0,U=[],V=[];let W=1,X=W,Y=[0,0];window.s.then(h=>h.json()).then(h=>sa(h));function ua(){setTimeout(location.reload.bind(location),1E3)}
function sa(h){if(0==h.length)e.innerHTML="No servers found",ua();else{e.innerHTML="Connecting...";var m=h.map(function(l){l=new WebSocket(l[1]);l.binaryType="arraybuffer";l.i=[];l.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};l.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return l});setTimeout(function(){let l=999999,p=null;for(let f of m){f.h=0;for(let Z of f.i)f.h+=Z;0<f.i.length?f.h/=f.i.length:
f.h=999999;f.h<l&&(l=f.h,p=f)}for(let f of m)f.onopen=function(){},f.onmessage=function(){},delete f.i,delete f.time,delete f.h,f!=p&&f.close();null==p||1!=p.readyState?(e.innerHTML="Failed connecting",ua()):va(p)},1E3)}}function wa(){ma=E;na=F;for(let h of C)h&&(h.g.x1=h.g.x2,h.g.y1=h.g.y2,h.g.r1=h.g.r2);for(let h of D)h&&(h.g.x1=h.g.x2,h.g.y1=h.g.y2,h.g.r1=h.g.r2)}
function va(h){e.innerHTML="Enter your name<br>";ba.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";g.style.display="block";g.onkeypress=g.onblur=g.onpaste=function(m){let l=m.target.value+m.key;4<(new TextEncoder).encode(l).byteLength?m.target.value=m.target.m||"":(m.target.value=l,m.target.m=l);m.preventDefault();return!1};h.onclose=function(){window.onbeforeunload=function(){};k.parentElement.removeChild(k);e.innerHTML="Disconnected";
ba.innerHTML="";g.style.display="none";ua()};window.onkeydown=function(m){13==(m.keyCode||m.which)&&(e.innerHTML="Spawning...",ba.innerHTML="",g.style.display="none",m=(m=window.localStorage.getItem("token"))?m.split(",").map(l=>+l):[],h.send(new Uint8Array([0,...(new TextEncoder).encode(g.value),0,...m,0])),xa(h))}}
function xa(h){function m({data:a}){y.set(new Uint8Array(a));A=a.byteLength;a=1;Y[0]=Y[1];Y[1]+=40;wa();if(a!=A){if(0==y[a]){++a;oa=1;D=[];B=y[a++];a+=2;R=y[a]|y[a+1]<<8;a+=2;S=y[a]|y[a+1]<<8;a+=2;T=y[a++];U=Array(256);V=Array(256);for(var b=0;b<R;++b)for(var c=0;c<S;++c)null==U[y[a]]&&(U[y[a]]=new Path2D,V[y[a]]=new Path2D),U[y[a]].rect(4*(1.5+b*T),4*(1.5+c*T),4*(T-3),4*(T-3)),V[y[a]].rect(b*T*4,c*T*4,4*T,4*T),++a;q.width=T*R*4;q.height=T*S*4;t.width=T*R*4;t.height=T*S*4;for(b=0;256>b;++b)U[b]&&
(r.fillStyle=ea[b]+"b0",r.fill(V[b]),r.fillStyle=ea[b],r.fill(U[b]),ca.fillStyle=ea[b],ca.fill(V[b]));da||(requestAnimationFrame(Z),da=1)}if(a!=A){if(1==y[a])for(++a,b=y[a++],c=0;c<b;++c){var d=y[a++];if(C[d]){for(var v=y[a++],x=a;v;){switch(v){case 1:C[d].g.x2=z.getFloat32(a,!0);a+=4;B==d&&(E=C[d].g.x2);break;case 2:C[d].g.y2=z.getFloat32(a,!0);a+=4;B==d&&(F=C[d].g.y2);break;case 3:C[d].g.r2=z.getFloat32(a,!0);a+=4;break;case 4:C[d].j=y[a++],C[d].j&&(C[d].l=y[a++])}v=y[a++]}x==a&&(C[d]=void 0)}else{v=
z.getFloat32(a,!0);a+=4;x=z.getFloat32(a,!0);a+=4;var P=z.getFloat32(a,!0);a+=4;var Q=y[a++],aa=(new TextDecoder).decode(y.subarray(a,a+Q));a+=Q;Q=y[a++];let ta=0;Q&&(ta=y[a++]);C[d]={x:0,y:0,r:0,g:{x1:v,x2:v,y1:x,y2:x,r1:P,r2:P},name:aa,j:Q,l:ta};B==d&&(E=v,F=x)}}if(a!=A&&2==y[a])for(++a,b=y[a]|y[a+1]<<8,a+=2,c=0;c<b;++c)if(d=y[a]|y[a+1]<<8,a+=2,D[d]){v=y[a++];for(x=a;v;){switch(v){case 1:D[d].g.x2=z.getFloat32(a,!0);a+=4;break;case 2:D[d].g.y2=z.getFloat32(a,!0);a+=4;break;case 3:D[d].g.r2=z.getFloat32(a,
!0),a+=4}v=y[a++]}x==a&&(D[d]=void 0)}else v=y[a++],x=z.getFloat32(a,!0),a+=4,P=z.getFloat32(a,!0),a+=4,aa=z.getFloat32(a,!0),a+=4,D[d]={type:v,x:0,y:0,r:0,g:{x1:x,x2:x,y1:P,y2:P,r1:aa,r2:aa}}}}}function l(){if(window.innerWidth!=ha||window.innerHeight!=ia||w!=window.devicePixelRatio)w=window.devicePixelRatio,ha=window.innerWidth,k.width=ha*w,ia=window.innerHeight,k.height=ia*w}function p(a,b,c){return a+(b-a)*c}function f(){ra||(I||J||K||L?(N=Math.atan2(L-I,K-J),O=160*w):O=N=0);z.setFloat32(0,N,
!0);O>=160*w?z.setUint8(4,255*M>>>0):z.setUint8(4,1.59375*O/w*M>>>0);h.send(y.subarray(0,5))}function Z(){if(0!=Y[0]){H?H<Y[0]?H=Y[0]:H>Y[1]&&(H=Y[1]):H=Y[0];var a=W;W=p(W,X,.1);W!=a&&(O=Math.hypot(G[0]-k.width/2,G[1]-k.height/2)/W,f());a=Y[0]==Y[1]?0:(H-Y[0])/(Y[1]-Y[0]);H+=16.66666;ka=p(ma,E,a);la=p(na,F,a);n.resetTransform();n.fillStyle="#333";n.fillRect(0,0,k.width,k.height);n.translate(k.width/2,k.height/2);n.scale(W,W);n.translate(-ka,-la);n.drawImage(q,0,0,q.width/4,q.height/4);1>W&&(n.globalAlpha=
1-W*W,n.drawImage(t,0,0,q.width/4,q.height/4),n.globalAlpha=1);for(var b of C)b&&(b.x=p(b.g.x1,b.g.x2,a),b.y=p(b.g.y1,b.g.y2,a),b.r=p(b.g.r1,b.g.r2,a),n.beginPath(),n.fillStyle="#4f4faf",n.arc(b.x,b.y,b.r,0,2*Math.PI),n.fill());for(b=0;b<u.length;++b)u[b]=new Path2D;for(var c of D)c&&(c.x=p(c.g.x1,c.g.x2,a),c.y=p(c.g.y1,c.g.y2,a),c.r=p(c.g.r1,c.g.r2,a),u[c.type].moveTo(c.x+c.r-2,c.y),u[c.type].arc(c.x,c.y,c.r-2,0,2*Math.PI));n.lineWidth=4;n.beginPath();for(c=0;c<u.length;++c)a=fa[c],a="#"+(.8*parseInt(a.substring(1,
3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0"),n.strokeStyle=a,n.stroke(u[c]),n.fillStyle=fa[c],n.fill(u[c]);for(let d of C)d&&(0!=d.name.length&&(n.font=`700 ${d.r/W}px Ubuntu`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#00000080",qa=1<W?.5*d.r:.5*d.r+2/(W*W),pa=p(pa,qa,.1),n.fillText(d.name,d.x,d.y-d.r-pa)),d.j&&(n.font=`700 ${d.r/Math.min(W,1)}px Ubuntu`,
n.textAlign="center",n.textBaseline="middle",n.fillStyle="#f00",n.fillText(d.l,d.x,d.y)))}requestAnimationFrame(Z)}h.onmessage=function(a){oa=0;m(a);oa&&(e.innerHTML="",wa())};l();window.onresize=l;window.onwheel=function(a){a=.05*-Math.sign(a.deltaY);X=1<X?X+3*a:X+a;X=Math.min(Math.max(X,.25),4)};window.onmousemove=function(a){G=[a.clientX*w,a.clientY*w];N=Math.atan2(G[1]-k.height/2,G[0]-k.width/2);O=Math.hypot(G[0]-k.width/2,G[1]-k.height/2)/W;f()};window.onmousedown=function(){ra=!ra;N=Math.atan2(G[1]-
k.height/2,G[0]-k.width/2);O=Math.hypot(G[0]-k.width/2,G[1]-k.height/2)/W;f()};window.onkeydown=function(a){switch(a.keyCode||a.which){case 16:1==M&&(M=.5,f());break;case 87:case 38:I||(I=1,f());break;case 65:case 37:J||(J=1,f());break;case 68:case 39:K||(K=1,f());break;case 83:case 40:L||(L=1,f())}};window.onkeyup=function(a){switch(a.keyCode||a.which){case 16:.5==M&&(M=1,f());break;case 87:case 38:I&&(I=0,f());break;case 65:case 37:J&&(J=0,f());break;case 68:case 39:K&&(K=0,f());break;case 83:case 40:L&&
(L=0,f())}};window.onbeforeunload=function(a){a.preventDefault();return a.returnValue="Are you sure you want to quit?"}};
