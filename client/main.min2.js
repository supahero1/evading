const d=document.getElementById.bind(document),g=document.createElement.bind(document),h=window.localStorage;let k=d("loading");k.innerHTML="Fetching servers...";let aa=d("sub"),p=d("name"),r=d("canvas"),w=r.getContext("2d"),x=g("canvas"),y=x.getContext("2d"),ba=g("canvas"),ca=ba.getContext("2d"),z=g("canvas"),A=z.getContext("2d");g("canvas").getContext("2d");let da=0,ea=["#dddddd","#aaaaaa","#333333","#fedf78"],fa="#808080 #fc46aa #008080 #ff8e06 #3cdfff #663a82".split(" "),ha=0,ia=0,B=0,ja=new ArrayBuffer(1048576),C=new Uint8Array(ja),D=new DataView(C.buffer),ka=0,la=0,F=[],G=[];var I=0,J=0,ma=0,na=0,oa=0,pa=0;let L=[0,0],M=0,qa=0,N=[0,0],ra=0,sa=0,ta=0,ua=d("settings"),va=d("ss"),wa=!1,xa=Array(5).fill(0),ya=h.getItem("tutorial")?1:0,za=0,Aa=0,Ba=0,Ca=h.getItem("keybinds"),Da={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft",minimap:"KeyM"},O=null!=Ca?JSON.parse(Ca):Da;for(let b in Da)void 0==O[b]&&(O[b]=Da[b]);for(let b in O)void 0==Da[b]&&delete O[b];var Ea=0,Fa=0,Ia=0,Ja=0,Ka=1,La=0,Ma=0,Na=0,Oa=0,Pa=0,Qa=0,Ra=0,Sa=0,P=0,Ta=[],Ua=[],Va=[];let Wa=h.getItem("settings"),Q={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},chat_text_scale:{min:1,max:2,value:1,step:.05},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!1,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!1,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1}},R=null!=Wa?JSON.parse(Wa):JSON.parse(JSON.stringify(Q));for(let b in Q)void 0==R[b]&&(R[b]=Q[b]);for(let b in R)void 0==Q[b]&&delete R[b],R[b].min&&R[b].min!=Q[b].min&&(R[b].min=Q[b].min),R[b].max&&R[b].max!=Q[b].max&&(R[b].max=Q[b].max),R[b].step&&R[b].step!=Q[b].step&&(R[b].step=Q[b].step),R[b].value=Math.max(Math.min(R[b].value,R[b].max),R[b].min);h.setItem("settings",JSON.stringify(R));let Xa=!1,Ya="",Za,S=R.fov.value,T=S,ab=d("chat"),bb=d("messages"),U=d("sendmsg"),cb=R.chat_on,db=0;window.s.then(b=>b.json()).then(b=>eb(b));function fb(){setTimeout(location.reload.bind(location),1E3)}function gb(){h.setItem("settings",JSON.stringify(R))}function hb(){h.setItem("keybinds",JSON.stringify(O))}function V(b){va.appendChild(b)}function ib(b){let m=g("h1");m.innerHTML=b;return m}function W(b){let m=g("h3");m.innerHTML=b;return m}function jb(){let b=g("h5");b.innerHTML="To change, click a button on the right side and then press the key you want to asign to it.";return b}function X(b,m,t){let q=g("tr"),n=g("td");n.appendChild(m);q.appendChild(n);n=g("td");n.appendChild(t);q.appendChild(n);b.appendChild(q)}function Y(b){let m=g("button");R[b]=!R[b];m.onclick=function(){R[b]=!R[b];1==R[b]?(m.innerHTML="ON",m.style["background-color"]="#23c552"):(m.innerHTML="OFF",m.style["background-color"]="#f84f31");gb()};m.onclick();return m}function kb(b){let m=g("button");m.innerHTML=O[b];m.onclick=async function(){m.innerHTML="...";Xa=1;await new Promise(function(t){Za=t});Xa=0;m.innerHTML=Ya;O[b]=Ya;hb()};return m}function lb(b,m="",t=function(){}){let q=g("div");q.className="input";let n=g("input");n.type="range";n.min=R[b].min;n.max=R[b].max;n.step=R[b].step;n.value=R[b].value;n.oninput=function(){n.nextElementSibling.innerHTML=n.value+m;R[b].value=n.valueAsNumber;t()};n.onchange=gb;q.appendChild(n);q.appendChild(W(n.value+m));return q}function mb(b){let m=g("button");m.innerHTML="RESET";m.onclick=b;return m}function nb(){va.innerHTML="";V(ib("CHAT"));let b=g("table");X(b,W("Show chat"),Y("chat_on"));X(b,W("Max number of chat messages"),lb("max_chat_messages","",function(){for(;db>R.max_chat_messages.value;)bb.removeChild(bb.lastChild),--db}));X(b,W("Chat text scale"),lb("chat_text_scale","",function(){bb.style["font-size"]=R.chat_text_scale.value+"em"}));V(b);V(ib("VISUALS"));b=g("table");X(b,W("Default FOV"),lb("fov"));X(b,W("Draw balls' fill"),Y("draw_ball_fill"));X(b,W("Draw balls' stroke"),Y("draw_ball_stroke"));X(b,W("Draw stroke-only balls with brighter color"),Y("draw_ball_stroke_bright"));X(b,W("Balls' stroke radius percentage"),lb("ball_stroke","%"));X(b,W("Draw players' fill"),Y("draw_player_fill"));X(b,W("Draw players' stroke"),Y("draw_player_stroke"));X(b,W("Draw stroke-only players with brighter color"),Y("draw_player_stroke_bright"));X(b,W("Players' stroke radius percentage"),lb("player_stroke","%"));X(b,W("Draw players' name"),Y("draw_player_name"));X(b,W("Draw an arrow towards dead players"),Y("draw_death_arrow"));X(b,W("Death arrow size"),lb("death_arrow_size","px",ob));V(b);V(ib("KEYBINDS"));V(jb());b=g("table");X(b,W("Settings"),kb("settings"));X(b,W("Move up"),kb("up"));X(b,W("Move left"),kb("left"));X(b,W("Move down"),kb("down"));X(b,W("Move right"),kb("right"));X(b,W("Move slowly"),kb("slowwalk"));X(b,W("Big minimap"),kb("minimap"));V(b);V(ib("RESET"));b=g("table");X(b,W("Reset settings"),mb(function(){R=Q;gb();nb()}));X(b,W("Reset keybinds"),mb(function(){O=Da;hb();nb()}));V(b)}nb();function pb(b,m){let t=g("p");t.appendChild(document.createTextNode(b+": "+m));bb.insertBefore(t,bb.firstChild);++db>R.max_chat_messages.value&&bb.removeChild(bb.lastChild)}function ob(){z.width=z.height=R.death_arrow_size.value;let b=.5*z.width,m=z.width;A.beginPath();A.moveTo(b+.45*m,b);A.lineTo(b-.225*m,b-.675*m/Math.sqrt(3));A.lineTo(b-.225*m,b+.675*m/Math.sqrt(3));A.closePath();A.fillStyle="#bbbbbbb0";A.fill();A.lineWidth=.05*z.width;A.strokeStyle="#f00";A.stroke()}ob();function eb(b){if(0==b.length)k.innerHTML="No servers found",fb();else{k.innerHTML="Connecting...";var m=b.map(function(t){t=new WebSocket(t[2]);t.binaryType="arraybuffer";t.i=[];t.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};t.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return t});setTimeout(function(){let t=999999,q=null;for(let n of m){n.h=0;for(let Ga of n.i)n.h+=Ga;0<n.i.length?n.h/=n.i.length:n.h=999999;n.h<t&&(t=n.h,q=n)}for(let n of m)n.onopen=function(){},n.onmessage=function(){},delete n.i,delete n.time,delete n.h,n!=q&&n.close();null==q||1!=q.readyState?(k.innerHTML="Failed connecting",fb()):qb(q)},1E3)}}function rb(){ma=na;oa=pa;for(let b of F)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2);for(let b of G)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2)}function sb(b){return function(m){let t=m instanceof ClipboardEvent;if(t&&"paste"!=m.type)return!0;let q=m.target.value+(t?m.clipboardData.getData("text"):m.key);if((new TextEncoder).encode(q).byteLength>b){if(""==m.target.value&&t){const n=m.target.placeholder;m.target.placeholder="Text too long to paste!";setTimeout(function(){m.target.placeholder=n},1E3)}m.preventDefault();return!1}return!0}}function Z(b,m,t){w.font="700 20px Ubuntu";w.textAlign="center";w.textBaseline="middle";w.fillStyle="#fff";w.strokeStyle="#333";w.lineWidth=1;w.fillText(b,m,t);w.strokeText(b,m,t)}function tb(b){return"#"+(.8*parseInt(b.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(b.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(b.substring(5,7),16)>>0).toString(16).padStart(2,"0")+b.substring(7)}function qb(b){k.innerHTML="Enter your name<br>";aa.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";p.style.display="block";p.focus();let m=h.getItem("name");m&&(p.value=m);p.onkeypress=p.onpaste=sb(4);b.onclose=function(){window.onbeforeunload=function(){};r.parentElement.removeChild(r);ua.parentElement.removeChild(ua);ab.parentElement.removeChild(ab);k.innerHTML="Disconnected";aa.innerHTML="";p.style.display="none";fb()};window.onkeydown=function(t){if("Enter"==t.code){var q=p.value.trim();h.setItem("name",q);k.innerHTML="Spawning...";aa.innerHTML="";p.style.display="none";t=(t=h.getItem("token"))?t.split(",").map(n=>+n):[];q=(new TextEncoder).encode(q);b.send(new Uint8Array([...q,...t]));ub(b)}}}function ub(b){function m({data:a}){C.set(new Uint8Array(a));ka=a.byteLength;a=C[0]|C[1]<<8|C[2]<<16|C[3]<<24;if(0!=Ha&&4!=a-Ha)throw b.onmessage=function(){},Error(`tick - last_tick = ${a-Ha}`);Ha=a;a=4;N[0]=N[1];N[1]=performance.now();rb();if(a!=ka){if(0==C[a]){++a;ra=1;G=[];la=C[a++];Oa=C[a++];Pa=C[a++];Qa=C[a++];P=C[a++];Ra=Pa*P;Sa=Qa*P;Ta=Array(C[a++]);for(var l=0;l<Ta.length;++l)Ta[l]=[(C[a++]+.5)*P,(C[a++]+.5)*P,C[a++]];Ua=Array(256);Va=Array(256);for(l=0;l<Pa;++l)for(var e=0;e<Qa;++e)null==Ua[C[a]]&&(Ua[C[a]]=new Path2D,Va[C[a]]=new Path2D),Ua[C[a]].rect((1.5+l*P)*R.fov.max,(1.5+e*P)*R.fov.max,(P-3)*R.fov.max,(P-3)*R.fov.max),Va[C[a]].rect(l*P*R.fov.max,e*P*R.fov.max,P*R.fov.max,P*R.fov.max),++a;x.width=P*Pa*R.fov.max;x.height=P*Qa*R.fov.max;ba.width=P*Pa*R.fov.max;ba.height=P*Qa*R.fov.max;for(l=0;256>l;++l)Ua[l]&&(y.fillStyle=ea[l]+"b0",y.fill(Va[l]),y.fillStyle=ea[l],y.fill(Ua[l]),ca.fillStyle=ea[l],ca.fill(Va[l]));y.font=`700 ${P}px Ubuntu`;y.textAlign="center";y.textBaseline="middle";y.fillStyle=tb(ea[3]);for(var v of Ta)y.fillText(v[2],v[0],v[1]);da||(requestAnimationFrame(Ga),da=1)}if(a!=ka){if(1==C[a])for(++a,v=C[a++],l=0;l<v;++l)if(e=C[a++],F[e]){var c=C[a++];if(c)for(;c;){switch(c){case 1:F[e].g.x2=D.getFloat32(a,!0);a+=4;la==e&&(na=F[e].g.x2);break;case 2:F[e].g.y2=D.getFloat32(a,!0);a+=4;la==e&&(pa=F[e].g.y2);break;case 3:F[e].g.r2=D.getFloat32(a,!0);a+=4;break;case 4:F[e].j=C[a++];F[e].j&&(F[e].l=C[a++]);break;case 5:c=C[a++],pb(F[e].name,(new TextDecoder).decode(C.subarray(a,a+c))),a+=c}c=C[a++]}else F[e]=void 0}else{c=D.getFloat32(a,!0);a+=4;var f=D.getFloat32(a,!0);a+=4;var E=D.getFloat32(a,!0);a+=4;var u=C[a++],K=(new TextDecoder).decode(C.subarray(a,a+u));a+=u;u=C[a++];let H=0;u&&(H=C[a++]);let $a=C[a++];0<$a&&(pb(K,(new TextDecoder).decode(C.subarray(a,a+$a))),a+=$a);F[e]={x:0,y:0,r:0,g:{x1:c,x2:c,y1:f,y2:f,r1:E,r2:E},name:K,j:u,l:H};la==e&&(na=c,pa=f)}if(a!=ka){if(2==C[a])for(++a,v=C[a]|C[a+1]<<8,a+=2,l=0;l<v;++l)if(e=C[a]|C[a+1]<<8,a+=2,G[e])if(c=C[a++])for(;c;){switch(c){case 1:G[e].g.x2=D.getFloat32(a,!0);a+=4;break;case 2:G[e].g.y2=D.getFloat32(a,!0);a+=4;break;case 3:G[e].g.r2=D.getFloat32(a,!0);if(1>G[e].g.r2||60<G[e].g.r2)throw console.log(`update ball id ${e} r ${G[e].g.r2}`),b.onmessage=function(){},Error();a+=4}c=C[a++]}else G[e]=void 0;else if(c=C[a++],0!=c&&(--c,f=D.getFloat32(a,!0),a+=4,E=D.getFloat32(a,!0),a+=4,K=D.getFloat32(a,!0),a+=4,G[e]={type:c,x:0,y:0,r:0,g:{x1:f,x2:f,y1:E,y2:E,r1:K,r2:K}},1>G[e].g.r2||60<G[e].g.r2))throw console.log(`create ball id ${e} r ${G[e].g.r2}`),b.onmessage=function(){},Error();if(a!=ka){if(3==C[a])for(++a,v=C[a++],l=0;l<v;++l)c=C[a++],e=(new TextDecoder).decode(C.subarray(a,a+c)),a+=c,c=C[a++],pb(e,(new TextDecoder).decode(C.subarray(a,a+c))),a+=c;if(a!=ka&&4==C[a])for(++a,v=C[a++],l=Array(v),e=0;e<v;++e)c=C[a++],l[e]={v:c,A:0,top:0,left:0,right:0,bottom:0,x:0,y:0},c&1&&(l[e].top=C[a++]),c&2&&(l[e].left=C[a++]),c&4&&(l[e].right=C[a++]),c&8&&(l[e].bottom=C[a++])}}}}}function t(){if(window.innerWidth!=ha||window.innerHeight!=ia||B!=window.devicePixelRatio)B=window.devicePixelRatio,ha=window.innerWidth,r.width=ha*B,ia=window.innerHeight,r.height=ia*B}function q(a,l,e){return a+(l-a)*e}function n(){Ma||(0==Ja-Ea&&0==Ia-Fa?Na=La=0:(La=Math.atan2(Ja-Ea,Ia-Fa),Na=160*B));wa||za?b.send(new Uint8Array([0,0,0,0,0,0])):(C[0]=0,D.setFloat32(1,La,!0),Na>=160*B?D.setUint8(5,255*Ka>>>0):D.setUint8(5,1.59375*Na/B*Ka>>>0),b.send(C.subarray(0,6)))}function Ga(a){if(0!=N[0]){R.chat_on==!cb&&(cb=R.chat_on,ab.style.display=cb?"block":"none");M?M<N[0]?M=N[0]:M>N[1]&&(M=N[1]):M=N[0];var l=S;S=q(S,T,.1);S!=l&&(Na=Math.hypot(L[0]-.5*r.width,L[1]-.5*r.height)/S,n());l=N[0]==N[1]?0:(M-N[0])/(N[1]-N[0]);M+=a-qa;qa=a;za&&0!=Aa||(I=q(ma,na,l),J=q(oa,pa,l));w.resetTransform();w.fillStyle="#333";w.fillRect(0,0,r.width,r.height);w.translate(.5*r.width,.5*r.height);w.scale(S,S);w.translate(-I,-J);w.drawImage(x,0,0,x.width/R.fov.max,x.height/R.fov.max);1>S&&(console.log(1-4*(S-R.fov.min)/3),w.globalAlpha=1-4*(S-R.fov.min)/3,w.drawImage(ba,0,0,x.width/R.fov.max,x.height/R.fov.max),w.globalAlpha=1);a=[];if(R.draw_player_fill||R.draw_player_stroke)for(var e of F)e&&(e.x=q(e.g.x1,e.g.x2,l),e.y=q(e.g.y1,e.g.y2,l),e.r=q(e.g.r1,e.g.r2,l),a[a.length]={u:e});if(R.draw_ball_fill||R.draw_ball_stroke)for(var v of G)v&&(v.x=q(v.g.x1,v.g.x2,l),v.y=q(v.g.y1,v.g.y2,l),v.r=q(v.g.r1,v.g.r2,l),a[a.length]={o:v});a.sort((E,u)=>E.r-u.r);for(let {o:E,u}of a)if(w.beginPath(),u){if(e=R.player_stroke.value/200*u.r,w.moveTo(u.x+u.r-e,u.y),w.arc(u.x,u.y,u.r-e,0,2*Math.PI),R.draw_player_fill&&(w.fillStyle="#ebecf0",w.fill()),R.draw_player_stroke&&(!R.draw_player_fill&&R.draw_player_stroke_bright?w.strokeStyle="#ebecf0":w.strokeStyle=tb("#ebecf0"),w.lineWidth=2*e,w.stroke()),R.draw_player_name&&0!=u.name.length&&(w.font=`700 ${u.r/S}px Ubuntu`,w.textAlign="center",w.textBaseline="middle",w.fillStyle="#00000080",ta=1<S?.5*u.r:.5*u.r+2/(S*S),sa=q(sa,ta,.1),w.fillText(u.name,u.x,u.y-u.r-sa)),u.j&&(w.font=`700 ${u.r/Math.min(S,1)}px Ubuntu`,w.textAlign="center",w.textBaseline="middle",w.fillStyle="#f00",w.fillText(u.l,u.x,u.y),R.draw_death_arrow)){a=.5*r.width+(u.x-I)*S;let K=.5*r.height+(u.y-J)*S,H=.75*z.width*S;if(0>a||a>r.width||0>K||K>r.height)v=Math.max(Math.min(a,r.width-H),H),e=Math.max(Math.min(K,r.height-H),H),a=(a<H||a>r.width-H)&&(K<H||K>r.height-H)?Math.atan2(K-e,a-v):Math.atan2(K<H?-1:K>r.height-H?1:0,a<H?-1:a>r.width-H?1:0),v=(v-.5*r.width)/S+I,e=(e-.5*r.height)/S+J,w.translate(v,e),w.rotate(a),w.drawImage(z,.5*-z.width,.5*-z.width),w.rotate(-a),w.font=`700 ${.3*z.width}px Ubuntu`,w.textAlign="center",w.textBaseline="middle",w.fillStyle="#f00",w.fillText(u.l,0,0),w.translate(-v,-e)}}else e=R.ball_stroke.value/200*E.r,w.moveTo(E.x+E.r-e,E.y),w.arc(E.x,E.y,E.r-e,0,2*Math.PI),R.draw_ball_fill&&(w.fillStyle=fa[E.type],w.fill()),R.draw_ball_stroke&&(w.strokeStyle=!R.draw_ball_fill&&R.draw_ball_stroke_bright?fa[E.type]:tb(fa[E.type]),w.lineWidth=2*e,w.stroke());if(za)switch(Aa){case 0:Z("<-- Your character",I+110,J);Z("Your character --\x3e",I-110,J);Z("This is your character. You can control it with these keys:",I,J-220);Z(`${O.up}: up`,I,J-170);Z(`${O.left}: left`,I,J-130);Z(`${O.down}: down`,I,J-90);Z(`${O.right}: right`,I,J-50);Z("You can also control it with mouse. Just",I,J+50);Z("press any mouse button to start or stop moving.",I,J+70);Z("Scroll to change your field of view.",I,J+110);Z("Note that you won't be able to perform some",I,J+150);Z("of the above actions until the tutorial ends.",I,J+170);Z("Press T to continue",I,J+220);break;case 1:var c=.5*Ra-6*P,f=.5*Sa;I=q(I,c,.2*l);J=q(J,f,.2*l);Z("--\x3e",c+2*P,f-P);Z("--\x3e",c+2*P,f);Z("--\x3e",c+2*P,f+P);Z("<--",c-2*P,f-2*P);Z("<--",c-3*P,f-P);Z("<--",c-4*P,f);Z("<--",c-3*P,f+P);Z("<--",c-2*P,f+2*P);Z("These are safezones. Enemies can't",c,f-130);Z("reach you inside of these tiles.",c,f-110);Z("Press T to continue",c,f+110);break;case 2:c=.5*Ra+6*P;f=.5*Sa;I=q(I,c,.2*l);J=q(J,f,.2*l);Z("<--",c-2*P,f-2*P);Z("<--",c-P,f-3*P);Z("<--",c,f-4*P);Z("<--",c-2*P,f+2*P);Z("<--",c-P,f+3*P);Z("<--",c,f+4*P);Z("--\x3e",c+2*P,f-3*P);Z("--\x3e",c+2*P,f+3*P);Z("<--",c+5*P,f-2*P);Z("<--",c+6*P,f-P);Z("<--",c+7*P,f);Z("<--",c+6*P,f+P);Z("<--",c+5*P,f+2*P);Z("These are walls. Players can't walk over them.",c,f-40);Z("However, some types (colors) of enemies can.",c,f-10);Z("Press T to continue",c,f+40);break;case 3:c=.5*P;f=.5*Sa;I=q(I,c,.2*l);J=q(J,f,.2*l);Z("--\x3e",c,f);Z("This is a teleport tile. If you walk on it, it will teleport you",c,f-90);Z("to an area it points to. Using the number on the tile, you can",c,f-70);Z("look at the minimap in the top left corner to see where that area is.",c,f-50);Z("Press T to continue",c,f+50);break;case 4:for(f of G)if(f){c=f;break}f=c.x;c=c.y;I=q(I,f,.2*l);J=q(J,c,.2*l);Z("Enemy ball --\x3e",f-110,c);Z("<-- Enemy ball",f+110,c);Z("This is an enemy, also called simply a ball. A grey ball",f,c-110);Z("doesn't do a lot - it simply moves in one direction. However,",f,c-90);Z("as you are about to find out when you start exploring the game,",f,c-70);Z("there are lots of types of enemies, each having their own color.",f,c-50);Z("Coming in contact with an enemy downs you. While downed, you can't move,",f,c+50);Z("and after a while, you die, unless other players revive you by touching you.",f,c+70);Z("Press T to continue",f,c+120);break;case 5:c=na;f=pa;I=q(I,c,.2*l);J=q(J,f,.2*l);Z(`You can press ${O.settings} to open settings.`,c,f-80);Z("There are a lot of cool options to change. Try it out later.",c,f-60);Z("That's it for this tutorial. See how far you can go!",c,f+60);Z("GLHF!",c,f+80);Z("Press T to end the tutorial",c,f+130);break;case 6:T=Ba,za=0,h.setItem("tutorial","1"),ya=1}else 0!=Oa||ya||Z("Need help? Press T for a tutorial.",.5*Ra,2.5*P)}requestAnimationFrame(Ga)}cb=!R.chat_on;let Ha=0;b.onmessage=function(a){ra=0;m(a);ra&&(k.innerHTML="",rb())};U.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=(new TextEncoder).encode(U.value.trim());if(0<a.length){C[0]=1;C[1]=a.length;C.set(a,2);b.send(C.subarray(0,C[1]+2));xa.pop();xa.unshift((new Date).getTime());a=Math.abs(xa[xa.length-1]-xa[0]);const l=1E3*xa.length;if(a<l){const e=U.placeholder;U.placeholder="You are on cooldown for sending too many messages too fast";U.m=1;U.onkeypress=U.onpaste=null;setTimeout(function(){U.onkeypress=U.onpaste=sb(128);U.m=0;U.placeholder=e},l-a)}}U.value="";U.blur();r.focus()}};U.onkeyup=function(a){a.stopPropagation()};U.onkeypress=U.onpaste=sb(128);t();window.onresize=t;r.onwheel=function(a){a=.05*-Math.sign(a.deltaY);T=1<T?T+3*a:T+a;T=Math.min(Math.max(T,R.fov.min),R.fov.max)};window.onmousemove=function(a){L=[a.clientX*B,a.clientY*B];La=Math.atan2(L[1]-.5*r.height,L[0]-.5*r.width);Na=Math.hypot(L[0]-.5*r.width,L[1]-.5*r.height)/S;n()};r.onmousedown=function(){za||(Ma=!Ma);La=Math.atan2(L[1]-.5*r.height,L[0]-.5*r.width);Na=Math.hypot(L[0]-.5*r.width,L[1]-.5*r.height)/S;n()};window.onkeydown=function(a){if(!a.repeat)if(wa)Xa?(a.preventDefault(),Ya=a.code,Za()):a.code==O.settings&&(wa=!1,ua.style.display="none");else switch(a.code){case "Enter":U.m||U.focus();a.preventDefault();break;case O.slowwalk:1==Ka&&(Ka=.5,n());break;case O.up:Ea||(Ea=1,n());break;case O.left:Fa||(Fa=1,n());break;case O.right:Ia||(Ia=1,n());break;case O.down:Ja||(Ja=1,n());break;case O.settings:za||(wa=!wa,ua.style.display=wa?"block":"none",n());break;case "KeyT":za?++Aa:0==Oa&&(za=1,Aa=0,Ba=T,T=R.fov.max)}};window.onkeyup=function(a){if(!a.repeat&&!wa)switch(a.code){case O.slowwalk:.5==Ka&&(Ka=1,n());break;case O.up:Ea&&(Ea=0,n());break;case O.left:Fa&&(Fa=0,n());break;case O.right:Ia&&(Ia=0,n());break;case O.down:Ja&&(Ja=0,n())}};window.onbeforeunload=function(a){a.preventDefault();a.returnValue="Are you sure you want to quit?";h.setItem("settings",JSON.stringify(R));return"Are you sure you want to quit?"};r.oncontextmenu=function(a){a.preventDefault();return!1}};