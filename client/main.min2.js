const e=document.getElementById.bind(document),h=document.createElement.bind(document),k=window.localStorage;let l=e("loading");l.innerHTML="Fetching servers...";let aa=e("sub"),p=e("name"),t=e("canvas"),x=t.getContext("2d"),y=h("canvas"),z=y.getContext("2d"),ba=h("canvas"),ca=ba.getContext("2d"),A=h("canvas"),B=A.getContext("2d"),da=h("canvas"),C=da.getContext("2d"),ea=0,fa=["#dddddd","#aaaaaa","#333333","#fedf78"],ha="#808080 #fc46aa #008080 #ff8e06 #3cdfff #663a82".split(" "),ia=0,ja=0,D=0,ka=new ArrayBuffer(1048576),E=new Uint8Array(ka),G=new DataView(E.buffer),la=0,ma=0,H=[],I=[];var J=0,L=0,na=0,oa=0,pa=0,qa=0;let M=[0,0],ra=null,sa=0,N=[0,0],ta=0,ua=0,va=0,wa=e("settings"),xa=e("ss"),ya=!1,za=Array(5).fill(0),Aa=k.getItem("tutorial")?1:0,Ba=0,Ca=0,Da=0,Ea=k.getItem("keybinds"),Fa={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft",minimap:"KeyM"},O=null!=Ea?JSON.parse(Ea):Fa;for(let b in Fa)void 0==O[b]&&(O[b]=Fa[b]);for(let b in O)void 0==Fa[b]&&delete O[b];var Ga=0,Ha=0,Ia=0,Ja=0,Ma=1,Na=0,Oa=0,Pa=0,Qa=0,Ra=0,Sa=0,Ta=0,Ua=0,P=0,Va=[],Wa=[],Xa=[];let Ya=k.getItem("settings"),Q={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},chat_text_scale:{min:1,max:2,value:1,step:.05},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!1,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!1,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1}},R=null!=Ya?JSON.parse(Ya):JSON.parse(JSON.stringify(Q));for(let b in Q)void 0==R[b]&&(R[b]=Q[b]);for(let b in R)void 0==Q[b]&&delete R[b],R[b].min&&R[b].min!=Q[b].min&&(R[b].min=Q[b].min),R[b].max&&R[b].max!=Q[b].max&&(R[b].max=Q[b].max),R[b].step&&R[b].step!=Q[b].step&&(R[b].step=Q[b].step),R[b].value=Math.max(Math.min(R[b].value,R[b].max),R[b].min);k.setItem("settings",JSON.stringify(R));let Za=160*R.fov.max,$a=Za>>1,ab=!1,bb="",cb,S=R.fov.value,T=S,eb=e("chat"),fb=e("messages"),U=e("sendmsg"),gb=R.chat_on,hb=0;window.s.then(b=>b.json()).then(b=>ib(b));function jb(){setTimeout(location.reload.bind(location),1E3)}function kb(){k.setItem("settings",JSON.stringify(R))}function lb(){k.setItem("keybinds",JSON.stringify(O))}function V(b){xa.appendChild(b)}function mb(b){let m=h("h1");m.innerHTML=b;return m}function W(b){let m=h("h3");m.innerHTML=b;return m}function nb(){let b=h("h5");b.innerHTML="To change, click a button on the right side and then press the key you want to asign to it.";return b}function X(b,m,u){let r=h("tr"),n=h("td");n.appendChild(m);r.appendChild(n);n=h("td");n.appendChild(u);r.appendChild(n);b.appendChild(r)}function Y(b){let m=h("button");R[b]=!R[b];m.onclick=function(){R[b]=!R[b];1==R[b]?(m.innerHTML="ON",m.style["background-color"]="#23c552"):(m.innerHTML="OFF",m.style["background-color"]="#f84f31");kb()};m.onclick();return m}function ob(b){let m=h("button");m.innerHTML=O[b];m.onclick=async function(){m.innerHTML="...";ab=1;await new Promise(function(u){cb=u});ab=0;m.innerHTML=bb;O[b]=bb;lb()};return m}function pb(b,m="",u=function(){}){let r=h("div");r.className="input";let n=h("input");n.type="range";n.min=R[b].min;n.max=R[b].max;n.step=R[b].step;n.value=R[b].value;n.oninput=function(){n.nextElementSibling.innerHTML=n.value+m;R[b].value=n.valueAsNumber;u()};n.onchange=kb;r.appendChild(n);r.appendChild(W(n.value+m));return r}function qb(b){let m=h("button");m.innerHTML="RESET";m.onclick=b;return m}function rb(){xa.innerHTML="";V(mb("CHAT"));let b=h("table");X(b,W("Show chat"),Y("chat_on"));X(b,W("Max number of chat messages"),pb("max_chat_messages","",function(){for(;hb>R.max_chat_messages.value;)fb.removeChild(fb.lastChild),--hb}));X(b,W("Chat text scale"),pb("chat_text_scale","",function(){fb.style["font-size"]=R.chat_text_scale.value+"em"}));V(b);V(mb("VISUALS"));b=h("table");X(b,W("Default FOV"),pb("fov"));X(b,W("Draw balls' fill"),Y("draw_ball_fill"));X(b,W("Draw balls' stroke"),Y("draw_ball_stroke"));X(b,W("Draw stroke-only balls with brighter color"),Y("draw_ball_stroke_bright"));X(b,W("Balls' stroke radius percentage"),pb("ball_stroke","%"));X(b,W("Draw players' fill"),Y("draw_player_fill"));X(b,W("Draw players' stroke"),Y("draw_player_stroke"));X(b,W("Draw stroke-only players with brighter color"),Y("draw_player_stroke_bright"));X(b,W("Players' stroke radius percentage"),pb("player_stroke","%"));X(b,W("Draw players' name"),Y("draw_player_name"));X(b,W("Draw an arrow towards dead players"),Y("draw_death_arrow"));X(b,W("Death arrow size"),pb("death_arrow_size","px",sb));V(b);V(mb("KEYBINDS"));V(nb());b=h("table");X(b,W("Settings"),ob("settings"));X(b,W("Move up"),ob("up"));X(b,W("Move left"),ob("left"));X(b,W("Move down"),ob("down"));X(b,W("Move right"),ob("right"));X(b,W("Move slowly"),ob("slowwalk"));X(b,W("Big minimap"),ob("minimap"));V(b);V(mb("RESET"));b=h("table");X(b,W("Reset settings"),qb(function(){R=Q;kb();rb()}));X(b,W("Reset keybinds"),qb(function(){O=Fa;lb();rb()}));V(b)}rb();function tb(b,m){let u=h("p");u.appendChild(document.createTextNode(b+": "+m));fb.insertBefore(u,fb.firstChild);++hb>R.max_chat_messages.value&&fb.removeChild(fb.lastChild)}function sb(){A.width=A.height=R.death_arrow_size.value;let b=.5*A.width,m=A.width;B.beginPath();B.moveTo(b+.45*m,b);B.lineTo(b-.225*m,b-.675*m/Math.sqrt(3));B.lineTo(b-.225*m,b+.675*m/Math.sqrt(3));B.closePath();B.fillStyle="#bbbbbbb0";B.fill();B.lineWidth=.05*A.width;B.strokeStyle="#f00";B.stroke()}sb();function ib(b){if(0==b.length)l.innerHTML="No servers found",jb();else{l.innerHTML="Connecting...";var m=b.map(function(u){u=new WebSocket(u[2]);u.binaryType="arraybuffer";u.i=[];u.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};u.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return u});setTimeout(function(){let u=999999,r=null;for(let n of m){n.h=0;for(let Ka of n.i)n.h+=Ka;0<n.i.length?n.h/=n.i.length:n.h=999999;n.h<u&&(u=n.h,r=n)}for(let n of m)n.onopen=function(){},n.onmessage=function(){},delete n.i,delete n.time,delete n.h,n!=r&&n.close();null==r||1!=r.readyState?(l.innerHTML="Failed connecting",jb()):ub(r)},1E3)}}function vb(){na=oa;pa=qa;for(let b of H)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2);for(let b of I)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2)}function wb(b){return function(m){let u=m instanceof ClipboardEvent;if(u&&"paste"!=m.type)return!0;let r=m.target.value+(u?m.clipboardData.getData("text"):m.key);if((new TextEncoder).encode(r).byteLength>b){if(""==m.target.value&&u){const n=m.target.placeholder;m.target.placeholder="Text too long to paste!";setTimeout(function(){m.target.placeholder=n},1E3)}m.preventDefault();return!1}return!0}}function Z(b,m,u){x.font="700 20px Ubuntu";x.textAlign="center";x.textBaseline="middle";x.fillStyle="#fff";x.strokeStyle="#333";x.lineWidth=1;x.fillText(b,m,u);x.strokeText(b,m,u)}function xb(b){return"#"+(.8*parseInt(b.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(b.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(b.substring(5,7),16)>>0).toString(16).padStart(2,"0")+b.substring(7)}function ub(b){l.innerHTML="Enter your name<br>";aa.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";p.style.display="block";p.focus();let m=k.getItem("name");m&&(p.value=m);p.onkeypress=p.onpaste=wb(4);b.onclose=function(){window.onbeforeunload=function(){};t.parentElement.removeChild(t);wa.parentElement.removeChild(wa);eb.parentElement.removeChild(eb);l.innerHTML="Disconnected";aa.innerHTML="";p.style.display="none";jb()};window.onkeydown=function(u){if("Enter"==u.code){var r=p.value.trim();k.setItem("name",r);l.innerHTML="Spawning...";aa.innerHTML="";p.style.display="none";u=(u=k.getItem("token"))?u.split(",").map(n=>+n):[];r=(new TextEncoder).encode(r);b.send(new Uint8Array([...r,...u]));yb(b)}}}function yb(b){function m({data:a}){E.set(new Uint8Array(a));la=a.byteLength;a=E[0]|E[1]<<8|E[2]<<16|E[3]<<24;if(0!=La&&4!=a-La)throw b.onmessage=function(){},Error(`tick - last_tick = ${a-La}`);La=a;a=4;N[0]=N[1];N[1]=performance.now();vb();if(a!=la){if(0==E[a]){++a;ta=1;I=[];ma=E[a++];Qa=E[a++];Ra=E[a++];Sa=E[a++];P=E[a++];Ta=Ra*P;Ua=Sa*P;Va=Array(E[a++]);for(var c=0;c<Va.length;++c)Va[c]=[(E[a++]+.5)*P*R.fov.max,(E[a++]+.5)*P*R.fov.max,E[a++]];Wa=Array(256);Xa=Array(256);for(c=0;c<Ra;++c)for(var f=0;f<Sa;++f)null==Wa[E[a]]&&(Wa[E[a]]=new Path2D,Xa[E[a]]=new Path2D),Wa[E[a]].rect((1.5+c*P)*R.fov.max,(1.5+f*P)*R.fov.max,(P-3)*R.fov.max,(P-3)*R.fov.max),Xa[E[a]].rect(c*P*R.fov.max,f*P*R.fov.max,P*R.fov.max,P*R.fov.max),++a;y.width=P*Ra*R.fov.max;y.height=P*Sa*R.fov.max;ba.width=P*Ra*R.fov.max;ba.height=P*Sa*R.fov.max;for(c=0;256>c;++c)Wa[c]&&(z.fillStyle=fa[c]+"b0",z.fill(Xa[c]),z.fillStyle=fa[c],z.fill(Wa[c]),ca.fillStyle=fa[c],ca.fill(Xa[c]));z.font=`700 ${P}px Ubuntu`;z.textAlign="center";z.textBaseline="middle";z.fillStyle=xb(fa[3]);for(var w of Va)z.fillText(w[2],w[0],w[1]);ea||(requestAnimationFrame(Ka),ea=1)}if(a!=la){if(1==E[a])for(++a,w=E[a++],c=0;c<w;++c)if(f=E[a++],H[f]){var d=E[a++];if(d)for(;d;){switch(d){case 1:H[f].g.x2=G.getFloat32(a,!0);a+=4;ma==f&&(oa=H[f].g.x2);break;case 2:H[f].g.y2=G.getFloat32(a,!0);a+=4;ma==f&&(qa=H[f].g.y2);break;case 3:H[f].g.r2=G.getFloat32(a,!0);a+=4;break;case 4:H[f].m=E[a++];H[f].m&&(H[f].o=E[a++]);break;case 5:d=E[a++],tb(H[f].name,(new TextDecoder).decode(E.subarray(a,a+d))),a+=d}d=E[a++]}else H[f]=void 0}else{d=G.getFloat32(a,!0);a+=4;var g=G.getFloat32(a,!0);a+=4;var F=G.getFloat32(a,!0);a+=4;var v=E[a++],K=(new TextDecoder).decode(E.subarray(a,a+v));a+=v;v=E[a++];let q=0;v&&(q=E[a++]);let db=E[a++];0<db&&(tb(K,(new TextDecoder).decode(E.subarray(a,a+db))),a+=db);H[f]={x:0,y:0,r:0,g:{x1:d,x2:d,y1:g,y2:g,r1:F,r2:F},name:K,m:v,o:q};ma==f&&(oa=d,qa=g)}if(a!=la){if(2==E[a])for(++a,w=E[a]|E[a+1]<<8,a+=2,c=0;c<w;++c)if(f=E[a]|E[a+1]<<8,a+=2,I[f])if(d=E[a++])for(;d;){switch(d){case 1:I[f].g.x2=G.getFloat32(a,!0);a+=4;break;case 2:I[f].g.y2=G.getFloat32(a,!0);a+=4;break;case 3:I[f].g.r2=G.getFloat32(a,!0);if(1>I[f].g.r2||60<I[f].g.r2)throw console.log(`update ball id ${f} r ${I[f].g.r2}`),b.onmessage=function(){},Error();a+=4}d=E[a++]}else I[f]=void 0;else if(d=E[a++],0!=d&&(--d,g=G.getFloat32(a,!0),a+=4,F=G.getFloat32(a,!0),a+=4,K=G.getFloat32(a,!0),a+=4,I[f]={type:d,x:0,y:0,r:0,g:{x1:g,x2:g,y1:F,y2:F,r1:K,r2:K}},1>I[f].g.r2||60<I[f].g.r2))throw console.log(`create ball id ${f} r ${I[f].g.r2}`),b.onmessage=function(){},Error();if(a!=la){if(3==E[a])for(++a,w=E[a++],c=0;c<w;++c)d=E[a++],f=(new TextDecoder).decode(E.subarray(a,a+d)),a+=d,d=E[a++],tb(f,(new TextDecoder).decode(E.subarray(a,a+d))),a+=d;if(a!=la&&4==E[a]){++a;w=E[a++];c=Array(w);for(f=0;f<w;++f)d=E[a++],c[f]={l:d,j:0,top:0,left:0,right:0,bottom:0,x:0,y:0},d&1&&(c[f].top=E[a++]),d&2&&(c[f].left=E[a++]),d&4&&(c[f].right=E[a++]),d&8&&(c[f].bottom=E[a++]);da.width=16384;da.height=da.width;a=[];f=new Path2D;c[0].x=.5*da.width-$a;c[0].y=.5*da.height-$a;d=[0];C.strokeStyle="#fff";C.fillStyle="#fff";C.font=`700 ${50*R.fov.max}px Ubuntu`;C.lineWidth=R.fov.max;C.textAlign="center";C.textBaseline="middle";console.log(w,c);do{a=d;d=[];for(const q of a)c[q].j=1,f.rect(c[q].x,c[q].y,Za,Za),C.fillText(q,c[q].x+$a,c[q].y+$a),c[q].l&1&&!c[c[q].top].j&&(d[d.length]=c[q].top,c[c[q].top].x=c[q].x,c[c[q].top].y=c[q].y-1.3*Za),c[q].l&2&&!c[c[q].left].j&&(d[d.length]=c[q].left,c[c[q].left].x=c[q].x-1.3*Za,c[c[q].left].y=c[q].y),c[q].l&4&&!c[c[q].right].j&&(d[d.length]=c[q].right,c[c[q].right].x=c[q].x+1.3*Za,c[c[q].right].y=c[q].y),c[q].l&8&&!c[c[q].bottom].j&&(d[d.length]=c[q].bottom,c[c[q].bottom].x=c[q].x,c[c[q].bottom].y=c[q].y+1.3*Za)}while(0!=d.length);C.stroke(f)}}}}}}function u(){if(window.innerWidth!=ia||window.innerHeight!=ja||D!=window.devicePixelRatio)D=window.devicePixelRatio,ia=window.innerWidth,t.width=ia*D,ja=window.innerHeight,t.height=ja*D}function r(a,c,f){return a+(c-a)*f}function n(){Oa||(0==Ja-Ga&&0==Ia-Ha?Pa=Na=0:(Na=Math.atan2(Ja-Ga,Ia-Ha),Pa=160*D));ya||Ba?b.send(new Uint8Array([0,0,0,0,0,0])):(E[0]=0,G.setFloat32(1,Na,!0),Pa>=160*D?G.setUint8(5,255*Ma>>>0):G.setUint8(5,1.59375*Pa/D*Ma>>>0),b.send(E.subarray(0,6)))}function Ka(a){if(0!=N[0]){R.chat_on==!gb&&(gb=R.chat_on,eb.style.display=gb?"block":"none");ra?ra<N[0]?ra=N[0]:ra>N[1]&&(ra=N[1]):ra=N[0];var c=S;S=r(S,T,.1);S!=c&&(Pa=Math.hypot(M[0]-.5*t.width,M[1]-.5*t.height)/S,n());c=N[0]==N[1]?0:(ra-N[0])/(N[1]-N[0]);ra+=a-sa;sa=a;Ba&&0!=Ca||(J=r(na,oa,c),L=r(pa,qa,c));x.resetTransform();x.fillStyle="#333";x.fillRect(0,0,t.width,t.height);x.translate(.5*t.width,.5*t.height);x.scale(S,S);x.translate(-J,-L);x.drawImage(y,0,0,y.width/R.fov.max,y.height/R.fov.max);1>S&&(x.globalAlpha=1-S*S,x.drawImage(ba,0,0,y.width/R.fov.max,y.height/R.fov.max),x.globalAlpha=1);a=[];if(R.draw_player_fill||R.draw_player_stroke)for(var f of H)f&&(f.x=r(f.g.x1,f.g.x2,c),f.y=r(f.g.y1,f.g.y2,c),f.r=r(f.g.r1,f.g.r2,c),a[a.length]={A:f});if(R.draw_ball_fill||R.draw_ball_stroke)for(var w of I)w&&(w.x=r(w.g.x1,w.g.x2,c),w.y=r(w.g.y1,w.g.y2,c),w.r=r(w.g.r1,w.g.r2,c),a[a.length]={v:w});a.sort((F,v)=>F.r-v.r);for(let {v:F,A:v}of a)if(x.beginPath(),v){if(f=R.player_stroke.value/200*v.r,x.moveTo(v.x+v.r-f,v.y),x.arc(v.x,v.y,v.r-f,0,2*Math.PI),R.draw_player_fill&&(x.fillStyle="#ebecf0",x.fill()),R.draw_player_stroke&&(!R.draw_player_fill&&R.draw_player_stroke_bright?x.strokeStyle="#ebecf0":x.strokeStyle=xb("#ebecf0"),x.lineWidth=2*f,x.stroke()),R.draw_player_name&&0!=v.name.length&&(x.font=`700 ${v.r/S}px Ubuntu`,x.textAlign="center",x.textBaseline="middle",x.fillStyle="#00000080",va=1<S?.5*v.r:.5*v.r+2/(S*S),ua=r(ua,va,.1),x.fillText(v.name,v.x,v.y-v.r-ua)),v.m&&(x.font=`700 ${v.r/Math.min(S,1)}px Ubuntu`,x.textAlign="center",x.textBaseline="middle",x.fillStyle="#f00",x.fillText(v.o,v.x,v.y),R.draw_death_arrow)){a=.5*t.width+(v.x-J)*S;let K=.5*t.height+(v.y-L)*S,q=.75*A.width*S;if(0>a||a>t.width||0>K||K>t.height)w=Math.max(Math.min(a,t.width-q),q),f=Math.max(Math.min(K,t.height-q),q),a=(a<q||a>t.width-q)&&(K<q||K>t.height-q)?Math.atan2(K-f,a-w):Math.atan2(K<q?-1:K>t.height-q?1:0,a<q?-1:a>t.width-q?1:0),w=(w-.5*t.width)/S+J,f=(f-.5*t.height)/S+L,x.translate(w,f),x.rotate(a),x.drawImage(A,.5*-A.width,.5*-A.width),x.rotate(-a),x.font=`700 ${.3*A.width}px Ubuntu`,x.textAlign="center",x.textBaseline="middle",x.fillStyle="#f00",x.fillText(v.o,0,0),x.translate(-w,-f)}}else f=R.ball_stroke.value/200*F.r,x.moveTo(F.x+F.r-f,F.y),x.arc(F.x,F.y,F.r-f,0,2*Math.PI),R.draw_ball_fill&&(x.fillStyle=ha[F.type],x.fill()),R.draw_ball_stroke&&(x.strokeStyle=!R.draw_ball_fill&&R.draw_ball_stroke_bright?ha[F.type]:xb(ha[F.type]),x.lineWidth=2*f,x.stroke());if(Ba)switch(Ca){case 0:Z("<-- Your character",J+110,L);Z("Your character --\x3e",J-110,L);Z("This is your character. You can control it with these keys:",J,L-220);Z(`${O.up}: up`,J,L-170);Z(`${O.left}: left`,J,L-130);Z(`${O.down}: down`,J,L-90);Z(`${O.right}: right`,J,L-50);Z("You can also control it with mouse. Just",J,L+50);Z("press any mouse button to start or stop moving.",J,L+70);Z("Scroll to change your field of view.",J,L+110);Z("Note that you won't be able to perform some",J,L+150);Z("of the above actions until the tutorial ends.",J,L+170);Z("Press T to continue",J,L+220);break;case 1:var d=.5*Ta-6*P,g=.5*Ua;J=r(J,d,.2*c);L=r(L,g,.2*c);Z("--\x3e",d+2*P,g-P);Z("--\x3e",d+2*P,g);Z("--\x3e",d+2*P,g+P);Z("<--",d-2*P,g-2*P);Z("<--",d-3*P,g-P);Z("<--",d-4*P,g);Z("<--",d-3*P,g+P);Z("<--",d-2*P,g+2*P);Z("These are safezones. Enemies can't",d,g-130);Z("reach you inside of these tiles.",d,g-110);Z("Press T to continue",d,g+110);break;case 2:d=.5*Ta+6*P;g=.5*Ua;J=r(J,d,.2*c);L=r(L,g,.2*c);Z("<--",d-2*P,g-2*P);Z("<--",d-P,g-3*P);Z("<--",d,g-4*P);Z("<--",d-2*P,g+2*P);Z("<--",d-P,g+3*P);Z("<--",d,g+4*P);Z("--\x3e",d+2*P,g-3*P);Z("--\x3e",d+2*P,g+3*P);Z("<--",d+5*P,g-2*P);Z("<--",d+6*P,g-P);Z("<--",d+7*P,g);Z("<--",d+6*P,g+P);Z("<--",d+5*P,g+2*P);Z("These are walls. Players can't walk over them.",d,g-40);Z("However, some types (colors) of enemies can.",d,g-10);Z("Press T to continue",d,g+40);break;case 3:d=.5*P;g=.5*Ua;J=r(J,d,.2*c);L=r(L,g,.2*c);Z("--\x3e",d,g);Z("This is a teleport tile. If you walk on it, it will teleport you",d,g-90);Z("to an area it points to. Using the number on the tile, you can",d,g-70);Z("look at the minimap in the top left corner to see where that area is.",d,g-50);Z("Press T to continue",d,g+50);break;case 4:for(g of I)if(g){d=g;break}g=d.x;d=d.y;J=r(J,g,.2*c);L=r(L,d,.2*c);Z("Enemy ball --\x3e",g-110,d);Z("<-- Enemy ball",g+110,d);Z("This is an enemy, also called simply a ball. A grey ball",g,d-110);Z("doesn't do a lot - it simply moves in one direction. However,",g,d-90);Z("as you are about to find out when you start exploring the game,",g,d-70);Z("there are lots of types of enemies, each having their own color.",g,d-50);Z("Coming in contact with an enemy downs you. While downed, you can't move,",g,d+50);Z("and after a while, you die, unless other players revive you by touching you.",g,d+70);Z("Press T to continue",g,d+120);break;case 5:d=oa;g=qa;J=r(J,d,.2*c);L=r(L,g,.2*c);Z(`You can press ${O.settings} to open settings.`,d,g-80);Z("There are a lot of cool options to change. Try it out later.",d,g-60);Z("That's it for this tutorial. See how far you can go!",d,g+60);Z("GLHF!",d,g+80);Z("Press T to end the tutorial",d,g+130);break;case 6:T=Da,Ba=0,k.setItem("tutorial","1"),Aa=1}else 0!=Qa||Aa||Z("Need help? Press T for a tutorial.",.5*Ta,2.5*P)}requestAnimationFrame(Ka)}gb=!R.chat_on;let La=0;b.onmessage=function(a){ta=0;m(a);ta&&(l.innerHTML="",vb())};U.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=(new TextEncoder).encode(U.value.trim());if(0<a.length){E[0]=1;E[1]=a.length;E.set(a,2);b.send(E.subarray(0,E[1]+2));za.pop();za.unshift((new Date).getTime());a=Math.abs(za[za.length-1]-za[0]);const c=1E3*za.length;if(a<c){const f=U.placeholder;U.placeholder="You are on cooldown for sending too many messages too fast";U.u=1;U.onkeypress=U.onpaste=null;setTimeout(function(){U.onkeypress=U.onpaste=wb(128);U.u=0;U.placeholder=f},c-a)}}U.value="";U.blur();t.focus()}};U.onkeyup=function(a){a.stopPropagation()};U.onkeypress=U.onpaste=wb(128);u();window.onresize=u;t.onwheel=function(a){a=.05*-Math.sign(a.deltaY);T=1<T?T+3*a:T+a;T=Math.min(Math.max(T,R.fov.min),R.fov.max)};window.onmousemove=function(a){M=[a.clientX*D,a.clientY*D];Na=Math.atan2(M[1]-.5*t.height,M[0]-.5*t.width);Pa=Math.hypot(M[0]-.5*t.width,M[1]-.5*t.height)/S;n()};t.onmousedown=function(){Ba||(Oa=!Oa);Na=Math.atan2(M[1]-.5*t.height,M[0]-.5*t.width);Pa=Math.hypot(M[0]-.5*t.width,M[1]-.5*t.height)/S;n()};window.onkeydown=function(a){if(!a.repeat)if(ya)ab?(a.preventDefault(),bb=a.code,cb()):a.code==O.settings&&(ya=!1,wa.style.display="none");else switch(a.code){case "Enter":U.u||U.focus();a.preventDefault();break;case O.slowwalk:1==Ma&&(Ma=.5,n());break;case O.up:Ga||(Ga=1,n());break;case O.left:Ha||(Ha=1,n());break;case O.right:Ia||(Ia=1,n());break;case O.down:Ja||(Ja=1,n());break;case O.settings:Ba||(ya=!ya,wa.style.display=ya?"block":"none",n());break;case "KeyT":Ba?++Ca:0==Qa&&(Ba=1,Ca=0,Da=T,T=R.fov.max)}};window.onkeyup=function(a){if(!a.repeat&&!ya)switch(a.code){case O.slowwalk:.5==Ma&&(Ma=1,n());break;case O.up:Ga&&(Ga=0,n());break;case O.left:Ha&&(Ha=0,n());break;case O.right:Ia&&(Ia=0,n());break;case O.down:Ja&&(Ja=0,n())}};window.onbeforeunload=function(a){a.preventDefault();a.returnValue="Are you sure you want to quit?";k.setItem("settings",JSON.stringify(R));return"Are you sure you want to quit?"};t.oncontextmenu=function(a){a.preventDefault();return!1}};