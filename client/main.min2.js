const d=document.getElementById.bind(document),g=document.createElement.bind(document),h=window.localStorage;let k=d("loading");k.innerHTML="Fetching servers...";let aa=d("sub"),l=d("name"),t=d("canvas"),w=t.getContext("2d"),x=g("canvas"),ba=x.getContext("2d"),ca=g("canvas"),da=ca.getContext("2d"),y=g("canvas"),z=y.getContext("2d"),ea=0,fa=["#dddddd","#aaaaaa","#333333","#fedf78"],ha="#808080 #fc46aa #008080 #ff8e06 #3cdfff #663a82".split(" "),ia=0,ja=0,A=0,ka=new ArrayBuffer(1048576),B=new Uint8Array(ka),C=new DataView(B.buffer),la=0,ma=0,D=[],F=[];var G=0,J=0,na=0,oa=0,pa=0,qa=0;let K=[0,0],M=null,ra=0,N=[0,0],sa=0,ta=0,ua=0,va=d("settings"),wa=d("ss"),xa=!1,ya=Array(5).fill(0),za=h.getItem("tutorial")?1:0,Aa=0,Ba=0,Ca=0,Da=h.getItem("keybinds"),Fa={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft"},O=null!=Da?JSON.parse(Da):Fa;for(let b in Fa)void 0==O[b]&&(O[b]=Fa[b]);for(let b in O)void 0==Fa[b]&&delete O[b];var Ga=0,Ha=0,Ia=0,Ja=0,Ka=1,La=0,Ma=0,Na=0,Oa=0,Pa=0,Qa=0,Ra=0,Sa=0,P=0,Ta=[],Ua=[];let Va=h.getItem("settings"),Q={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},chat_text_scale:{min:1,max:2,value:1,step:.05},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!1,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!1,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1}},R=null!=Va?JSON.parse(Va):JSON.parse(JSON.stringify(Q));for(let b in Q)void 0==R[b]&&(R[b]=Q[b]);for(let b in R)void 0==Q[b]&&delete R[b],R[b].min&&R[b].min!=Q[b].min&&(R[b].min=Q[b].min),R[b].max&&R[b].max!=Q[b].max&&(R[b].max=Q[b].max),R[b].value=Math.max(Math.min(R[b].value,R[b].max),R[b].min);h.setItem("settings",JSON.stringify(R));let Wa=!1,Xa="",Za,S=R.fov.value,T=S,$a=d("chat"),ab=d("messages"),U=d("sendmsg"),bb=R.chat_on,cb=0;window.s.then(b=>b.json()).then(b=>db(b));function eb(){setTimeout(location.reload.bind(location),1E3)}function fb(){h.setItem("settings",JSON.stringify(R))}function gb(){h.setItem("keybinds",JSON.stringify(O))}function V(b){wa.appendChild(b)}function hb(b){let f=g("h1");f.innerHTML=b;return f}function W(b){let f=g("h3");f.innerHTML=b;return f}function ib(){let b=g("h5");b.innerHTML="To change, click a button on the right side and then press the key you want to asign to it.";return b}function X(b,f,u){let r=g("tr"),n=g("td");n.appendChild(f);r.appendChild(n);n=g("td");n.appendChild(u);r.appendChild(n);b.appendChild(r)}function Y(b){let f=g("button");R[b]=!R[b];f.onclick=function(){R[b]=!R[b];1==R[b]?(f.innerHTML="ON",f.style["background-color"]="#23c552"):(f.innerHTML="OFF",f.style["background-color"]="#f84f31");fb()};f.onclick();return f}function jb(b){let f=g("button");f.innerHTML=O[b];f.onclick=async function(){f.innerHTML="...";Wa=1;await new Promise(function(u){Za=u});Wa=0;f.innerHTML=Xa;O[b]=Xa;gb()};return f}function kb(b,f="",u=function(){}){let r=g("div");r.className="input";let n=g("input");n.type="range";n.min=R[b].min;n.max=R[b].max;n.step=R[b].step;n.value=R[b].value;n.oninput=function(){n.nextElementSibling.innerHTML=n.value+f;R[b].value=n.valueAsNumber;u()};n.onchange=fb;r.appendChild(n);r.appendChild(W(n.value+f));return r}function lb(b){let f=g("button");f.innerHTML="RESET";f.onclick=b;return f}function mb(){wa.innerHTML="";V(hb("CHAT"));let b=g("table");X(b,W("Show chat"),Y("chat_on"));X(b,W("Max number of chat messages"),kb("max_chat_messages","",function(){for(;cb>R.max_chat_messages.value;)ab.removeChild(ab.lastChild),--cb}));X(b,W("Chat text scale"),kb("chat_text_scale","",function(){ab.style["font-size"]=R.chat_text_scale.value+"em"}));V(b);V(hb("VISUALS"));b=g("table");X(b,W("Default FOV"),kb("fov"));X(b,W("Draw balls' fill"),Y("draw_ball_fill"));X(b,W("Draw balls' stroke"),Y("draw_ball_stroke"));X(b,W("Draw stroke-only balls with brighter color"),Y("draw_ball_stroke_bright"));X(b,W("Balls' stroke radius percentage"),kb("ball_stroke"," %"));X(b,W("Draw players' fill"),Y("draw_player_fill"));X(b,W("Draw players' stroke"),Y("draw_player_stroke"));X(b,W("Draw stroke-only players with brighter color"),Y("draw_player_stroke_bright"));X(b,W("Players' stroke radius percentage"),kb("player_stroke"," %"));X(b,W("Draw players' name"),Y("draw_player_name"));X(b,W("Draw an arrow towards dead players"),Y("draw_death_arrow"));X(b,W("Death arrow size"),kb("death_arrow_size","px",nb));V(b);V(hb("KEYBINDS"));V(ib());b=g("table");X(b,W("Settings"),jb("settings"));X(b,W("Move up"),jb("up"));X(b,W("Move left"),jb("left"));X(b,W("Move down"),jb("down"));X(b,W("Move right"),jb("right"));X(b,W("Move slowly"),jb("slowwalk"));V(b);V(hb("RESET"));b=g("table");X(b,W("Reset settings"),lb(function(){R=Q;fb();mb()}));X(b,W("Reset keybinds"),lb(function(){O=Fa;gb();mb()}));V(b)}mb();function pb(b,f){let u=g("p");u.appendChild(document.createTextNode(b+": "+f));ab.insertBefore(u,ab.firstChild);++cb>R.max_chat_messages.value&&ab.removeChild(ab.lastChild)}function nb(){y.width=y.height=R.death_arrow_size.value;let b=.5*y.width,f=y.width;z.beginPath();z.moveTo(b+.45*f,b);z.lineTo(b-.225*f,b-.675*f/Math.sqrt(3));z.lineTo(b-.225*f,b+.675*f/Math.sqrt(3));z.closePath();z.fillStyle="#bbbbbbb0";z.fill();z.lineWidth=.05*y.width;z.strokeStyle="#f00";z.stroke()}nb();function db(b){if(0==b.length)k.innerHTML="No servers found",eb();else{k.innerHTML="Connecting...";var f=b.map(function(u){u=new WebSocket(u[1]);u.binaryType="arraybuffer";u.i=[];u.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};u.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return u});setTimeout(function(){let u=999999,r=null;for(let n of f){n.h=0;for(let H of n.i)n.h+=H;0<n.i.length?n.h/=n.i.length:n.h=999999;n.h<u&&(u=n.h,r=n)}for(let n of f)n.onopen=function(){},n.onmessage=function(){},delete n.i,delete n.time,delete n.h,n!=r&&n.close();null==r||1!=r.readyState?(k.innerHTML="Failed connecting",eb()):qb(r)},1E3)}}function rb(){na=oa;pa=qa;for(let b of D)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2);for(let b of F)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2)}function sb(b){return function(f){let u=f instanceof ClipboardEvent;if(u&&"paste"!=f.type)return!0;let r=f.target.value+(u?f.clipboardData.getData("text"):f.key);if((new TextEncoder).encode(r).byteLength>b){if(""==f.target.value&&u){const n=f.target.placeholder;f.target.placeholder="Text too long to paste!";setTimeout(function(){f.target.placeholder=n},1E3)}f.preventDefault();return!1}return!0}}function Z(b,f,u){w.translate(f,u);w.font="700 20px Ubuntu";w.textAlign="center";w.textBaseline="middle";w.fillStyle="#fff";w.strokeStyle="#333";w.lineWidth=1;w.fillText(b,0,0);w.strokeText(b,0,0);w.translate(-f,-u)}function qb(b){k.innerHTML="Enter your name<br>";aa.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";l.style.display="block";l.focus();let f=h.getItem("name");f&&(l.value=f);l.onkeypress=l.onpaste=sb(4);b.onclose=function(){window.onbeforeunload=function(){};t.parentElement.removeChild(t);va.parentElement.removeChild(va);$a.parentElement.removeChild($a);k.innerHTML="Disconnected";aa.innerHTML="";l.style.display="none";eb()};window.onkeydown=function(u){if("Enter"==u.code){h.setItem("name",l.value);k.innerHTML="Spawning...";aa.innerHTML="";l.style.display="none";u=(u=h.getItem("token"))?u.split(",").map(n=>+n):[];let r=(new TextEncoder).encode(l.value);b.send(new Uint8Array([...r,...u]));tb(b)}}}function tb(b){function f({data:a}){B.set(new Uint8Array(a));la=a.byteLength;a=B[0]|B[1]<<8|B[2]<<16|B[3]<<24;if(0!=Ea&&4!=a-Ea)throw b.onmessage=function(){},Error(`tick - last_tick = ${a-Ea}`);Ea=a;a=4;N[0]=N[1];N[1]=performance.now();rb();if(a!=la){if(0==B[a]){++a;sa=1;F=[];ma=B[a++];Oa=B[a]|B[a+1]<<8;a+=2;Pa=B[a]|B[a+1]<<8;a+=2;Qa=B[a]|B[a+1]<<8;a+=2;P=B[a++];Ra=Pa*P;Sa=Qa*P;Ta=Array(256);Ua=Array(256);for(var p=0;p<Pa;++p)for(var q=0;q<Qa;++q)null==Ta[B[a]]&&(Ta[B[a]]=new Path2D,Ua[B[a]]=new Path2D),Ta[B[a]].rect((1.5+p*P)*R.fov.max,(1.5+q*P)*R.fov.max,(P-3)*R.fov.max,(P-3)*R.fov.max),Ua[B[a]].rect(p*P*R.fov.max,q*P*R.fov.max,P*R.fov.max,P*R.fov.max),++a;x.width=P*Pa*R.fov.max;x.height=P*Qa*R.fov.max;ca.width=P*Pa*R.fov.max;ca.height=P*Qa*R.fov.max;for(p=0;256>p;++p)Ta[p]&&(ba.fillStyle=fa[p]+"b0",ba.fill(Ua[p]),ba.fillStyle=fa[p],ba.fill(Ta[p]),da.fillStyle=fa[p],da.fill(Ua[p]));ea||(requestAnimationFrame(ob),ea=1)}if(a!=la){if(1==B[a])for(++a,p=B[a++],q=0;q<p;++q){var m=B[a++];if(D[m]){var c=B[a++];if(c)for(;c;){switch(c){case 1:D[m].g.x2=C.getFloat32(a,!0);a+=4;ma==m&&(oa=D[m].g.x2);break;case 2:D[m].g.y2=C.getFloat32(a,!0);a+=4;ma==m&&(qa=D[m].g.y2);break;case 3:D[m].g.r2=C.getFloat32(a,!0);a+=4;break;case 4:D[m].j=B[a++];D[m].j&&(D[m].l=B[a++]);break;case 5:c=B[a++],pb(D[m].name,(new TextDecoder).decode(B.subarray(a,a+c))),a+=c}c=B[a++]}else D[m]=void 0}else{c=C.getFloat32(a,!0);a+=4;var e=C.getFloat32(a,!0);a+=4;var E=C.getFloat32(a,!0);a+=4;var v=B[a++],L=(new TextDecoder).decode(B.subarray(a,a+v));a+=v;v=B[a++];let I=0;v&&(I=B[a++]);let Ya=B[a++];0<Ya&&(pb(L,(new TextDecoder).decode(B.subarray(a,a+Ya))),a+=Ya);D[m]={x:0,y:0,r:0,g:{x1:c,x2:c,y1:e,y2:e,r1:E,r2:E},name:L,j:v,l:I};ma==m&&(oa=c,qa=e)}}if(a!=la){if(2==B[a])for(++a,p=B[a]|B[a+1]<<8,a+=2,q=0;q<p;++q)if(m=B[a]|B[a+1]<<8,a+=2,F[m])if(c=B[a++])for(;c;){switch(c){case 1:F[m].g.x2=C.getFloat32(a,!0);a+=4;break;case 2:F[m].g.y2=C.getFloat32(a,!0);a+=4;break;case 3:F[m].g.r2=C.getFloat32(a,!0);if(1>F[m].g.r2||60<F[m].g.r2)throw console.log(`update ball id ${m} r ${F[m].g.r2}`),b.onmessage=function(){},Error();a+=4}c=B[a++]}else F[m]=void 0;else if(c=B[a++],0!=c&&(--c,e=C.getFloat32(a,!0),a+=4,E=C.getFloat32(a,!0),a+=4,L=C.getFloat32(a,!0),a+=4,F[m]={type:c,x:0,y:0,r:0,g:{x1:e,x2:e,y1:E,y2:E,r1:L,r2:L}},1>F[m].g.r2||60<F[m].g.r2))throw console.log(`create ball id ${m} r ${F[m].g.r2}`),b.onmessage=function(){},Error();if(a!=la&&3==B[a])for(++a,p=B[a++],q=0;q<p;++q)c=B[a++],m=(new TextDecoder).decode(B.subarray(a,a+c)),a+=c,c=B[a++],pb(m,(new TextDecoder).decode(B.subarray(a,a+c))),a+=c}}}}function u(){if(window.innerWidth!=ia||window.innerHeight!=ja||A!=window.devicePixelRatio)A=window.devicePixelRatio,ia=window.innerWidth,t.width=ia*A,ja=window.innerHeight,t.height=ja*A}function r(a,p,q){return a+(p-a)*q}function n(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function H(){Ma||(0==Ja-Ga&&0==Ia-Ha?Na=La=0:(La=Math.atan2(Ja-Ga,Ia-Ha),Na=160*A));xa||Aa?b.send(new Uint8Array([0,0,0,0,0,0])):(B[0]=0,C.setFloat32(1,La,!0),Na>=160*A?C.setUint8(5,255*Ka>>>0):C.setUint8(5,1.59375*Na/A*Ka>>>0),b.send(B.subarray(0,6)))}function ob(a){if(0!=N[0]){R.chat_on==!bb&&(bb=R.chat_on,$a.style.display=bb?"block":"none");M?M<N[0]?M=N[0]:M>N[1]&&(M=N[1]):M=N[0];var p=S;S=r(S,T,.1);S!=p&&(Na=Math.hypot(K[0]-.5*t.width,K[1]-.5*t.height)/S,H());p=N[0]==N[1]?0:(M-N[0])/(N[1]-N[0]);M+=a-ra;ra=a;Aa||(G=r(na,oa,p),J=r(pa,qa,p));w.resetTransform();w.fillStyle="#333";w.fillRect(0,0,t.width,t.height);w.translate(.5*t.width,.5*t.height);w.scale(S,S);w.translate(-G,-J);w.drawImage(x,0,0,x.width/R.fov.max,x.height/R.fov.max);1>S&&(w.globalAlpha=1-S*S,w.drawImage(ca,0,0,x.width/R.fov.max,x.height/R.fov.max),w.globalAlpha=1);a=[];if(R.draw_player_fill||R.draw_player_stroke)for(var q of D)q&&(q.x=r(q.g.x1,q.g.x2,p),q.y=r(q.g.y1,q.g.y2,p),q.r=r(q.g.r1,q.g.r2,p),a[a.length]={u:q});if(R.draw_ball_fill||R.draw_ball_stroke)for(var m of F)m&&(m.x=r(m.g.x1,m.g.x2,p),m.y=r(m.g.y1,m.g.y2,p),m.r=r(m.g.r1,m.g.r2,p),a[a.length]={o:m});a.sort((E,v)=>E.r-v.r);for(let {o:E,u:v}of a)if(w.beginPath(),v){if(q=R.player_stroke.value/200*v.r,w.moveTo(v.x+v.r-q,v.y),w.arc(v.x,v.y,v.r-q,0,2*Math.PI),R.draw_player_fill&&(w.fillStyle="#ebecf0",w.fill()),R.draw_player_stroke&&(!R.draw_player_fill&&R.draw_player_stroke_bright?w.strokeStyle="#ebecf0":w.strokeStyle=n("#ebecf0"),w.lineWidth=2*q,w.stroke()),R.draw_player_name&&0!=v.name.length&&(w.font=`700 ${v.r/S}px Ubuntu`,w.textAlign="center",w.textBaseline="middle",w.fillStyle="#00000080",ua=1<S?.5*v.r:.5*v.r+2/(S*S),ta=r(ta,ua,.1),w.fillText(v.name,v.x,v.y-v.r-ta)),v.j&&(w.font=`700 ${v.r/Math.min(S,1)}px Ubuntu`,w.textAlign="center",w.textBaseline="middle",w.fillStyle="#f00",w.fillText(v.l,v.x,v.y),R.draw_death_arrow)){a=.5*t.width+(v.x-G)*S;let L=.5*t.height+(v.y-J)*S,I=.75*y.width*S;if(0>a||a>t.width||0>L||L>t.height)m=Math.max(Math.min(a,t.width-I),I),q=Math.max(Math.min(L,t.height-I),I),a=(a<I||a>t.width-I)&&(L<I||L>t.height-I)?Math.atan2(L-q,a-m):Math.atan2(L<I?-1:L>t.height-I?1:0,a<I?-1:a>t.width-I?1:0),m=(m-.5*t.width)/S+G,q=(q-.5*t.height)/S+J,w.translate(m,q),w.rotate(a),w.drawImage(y,.5*-y.width,.5*-y.width),w.rotate(-a),w.font=`700 ${.3*y.width}px Ubuntu`,w.textAlign="center",w.textBaseline="middle",w.fillStyle="#f00",w.fillText(v.l,0,0),w.translate(-m,-q)}}else q=R.ball_stroke.value/200*E.r,w.moveTo(E.x+E.r-q,E.y),w.arc(E.x,E.y,E.r-q,0,2*Math.PI),R.draw_ball_fill&&(w.fillStyle=ha[E.type],w.fill()),R.draw_ball_stroke&&(w.strokeStyle=!R.draw_ball_fill&&R.draw_ball_stroke_bright?ha[E.type]:n(ha[E.type]),w.lineWidth=2*q,w.stroke());if(Aa)switch(Ba){case 0:Z("<-- Your character",G+110,J);Z("Your character --\x3e",G-110,J);Z("This is your character. You can control it with these keys:",G,J-220);Z(`${O.up}: up`,G,J-170);Z(`${O.left}: left`,G,J-130);Z(`${O.right}: right`,G,J-90);Z(`${O.down}: down`,G,J-50);Z("You can also control it with mouse. Just",G,J+50);Z("press any mouse button to start or stop moving.",G,J+70);Z("Scroll to change your field of view.",G,J+110);Z("Note that you won't be able to perform some",G,J+150);Z("of the above actions until the tutorial ends.",G,J+170);Z("Press T to continue",G,J+220);break;case 1:var c=.5*Ra-6*P,e=.5*Sa;G=r(G,c,.2*p);J=r(J,e,.2*p);Z("--\x3e",c+2*P,e-P);Z("--\x3e",c+2*P,e);Z("--\x3e",c+2*P,e+P);Z("<--",c-2*P,e-2*P);Z("<--",c-3*P,e-P);Z("<--",c-4*P,e);Z("<--",c-3*P,e+P);Z("<--",c-2*P,e+2*P);Z("These are safezones. Enemies can't",c,e-130);Z("reach you inside of these tiles.",c,e-110);Z("Press T to continue",c,e+110);break;case 2:c=.5*Ra+6*P;e=.5*Sa;G=r(G,c,.2*p);J=r(J,e,.2*p);Z("<--",c-2*P,e-2*P);Z("<--",c-P,e-3*P);Z("<--",c,e-4*P);Z("<--",c-2*P,e+2*P);Z("<--",c-P,e+3*P);Z("<--",c,e+4*P);Z("--\x3e",c+2*P,e-3*P);Z("--\x3e",c+2*P,e+3*P);Z("<--",c+5*P,e-2*P);Z("<--",c+6*P,e-P);Z("<--",c+7*P,e);Z("<--",c+6*P,e+P);Z("<--",c+5*P,e+2*P);Z("These are walls. Players can't walk over them.",c,e-40);Z("However, some types (colors) of enemies can.",c,e-10);Z("Press T to continue",c,e+40);break;case 3:c=.5*P;e=.5*Sa;G=r(G,c,.2*p);J=r(J,e,.2*p);Z("--\x3e",c,e);Z("This is a teleport tile. If you walk on it, it will teleport you",c,e-90);Z("to an area it points to. Using the number on the tile, you can",c,e-70);Z("look at the minimap in the top left corner to see where that area is.",c,e-50);Z("Press T to continue",c,e+50);break;case 4:for(e of F)if(e){c=e;break}e=c.x;c=c.y;G=r(G,e,.2*p);J=r(J,c,.2*p);Z("This is an enemy, also called simply a ball. A grey ball",e,c-110);Z("doesn't do a lot - it simply moves in one direction. However,",e,c-90);Z("as you are about to find out when you start exploring the game,",e,c-70);Z("there are lots of types of enemies, each having their own color.",e,c-50);Z("Coming in contact with an enemy downs you. While downed, you can't move,",e,c+50);Z("and after a while, you die, unless other players revive you by touching you.",e,c+70);Z("Press T to continue",e,c+120);break;case 5:c=oa;e=qa;G=r(G,c,.2*p);J=r(J,e,.2*p);Z(`You can press ${O.settings} to open settings. There`,c,e-80);Z("are a lot of cool options there to change. Try it out later.",c,e-60);Z("That's it for this tutorial. See how far you can go!",c,e+60);Z("GLHF!",c,e+80);Z("Press T to end the tutorial",c,e+130);break;case 6:T=Ca,Aa=0,h.setItem("tutorial","1"),za=1}else 0!=Oa||za||Z("Need help? Press T for a tutorial.",.5*Ra,2.5*P)}requestAnimationFrame(ob)}bb=!R.chat_on;let Ea=0;b.onmessage=function(a){sa=0;f(a);sa&&(k.innerHTML="",rb())};U.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=(new TextEncoder).encode(U.value.trim());if(0<a.length){B[0]=1;B[1]=a.length;B.set(a,2);b.send(B.subarray(0,B[1]+2));ya.pop();ya.unshift((new Date).getTime());a=Math.abs(ya[ya.length-1]-ya[0]);const p=1E3*ya.length;if(a<p){const q=U.placeholder;U.placeholder="You are on cooldown for sending too many messages too fast";U.m=1;U.onkeypress=U.onpaste=null;setTimeout(function(){U.onkeypress=U.onpaste=sb(128);U.m=0;U.placeholder=q},p-a)}}U.value="";U.blur();t.focus()}};U.onkeyup=function(a){a.stopPropagation()};U.onkeypress=U.onpaste=sb(128);u();window.onresize=u;t.onwheel=function(a){a=.05*-Math.sign(a.deltaY);T=1<T?T+3*a:T+a;T=Math.min(Math.max(T,R.fov.min),R.fov.max)};window.onmousemove=function(a){K=[a.clientX*A,a.clientY*A];La=Math.atan2(K[1]-.5*t.height,K[0]-.5*t.width);Na=Math.hypot(K[0]-.5*t.width,K[1]-.5*t.height)/S;H()};t.onmousedown=function(){Aa||(Ma=!Ma);La=Math.atan2(K[1]-.5*t.height,K[0]-.5*t.width);Na=Math.hypot(K[0]-.5*t.width,K[1]-.5*t.height)/S;H()};window.onkeydown=function(a){if(!a.repeat)if(xa)Wa?(a.preventDefault(),Xa=a.code,Za()):a.code==O.settings&&(xa=!1,va.style.display="none");else switch(a.code){case "Enter":U.m||U.focus();a.preventDefault();break;case O.slowwalk:1==Ka&&(Ka=.5,H());break;case O.up:Ga||(Ga=1,H());break;case O.left:Ha||(Ha=1,H());break;case O.right:Ia||(Ia=1,H());break;case O.down:Ja||(Ja=1,H());break;case O.settings:Aa||(xa=!xa,va.style.display=xa?"block":"none");break;case "KeyT":Aa?++Ba:0==Oa&&(Aa=1,Ba=0,Ca=T,T=R.fov.max)}};window.onkeyup=function(a){if(!a.repeat&&!xa)switch(a.code){case O.slowwalk:.5==Ka&&(Ka=1,H());break;case O.up:Ga&&(Ga=0,H());break;case O.left:Ha&&(Ha=0,H());break;case O.right:Ia&&(Ia=0,H());break;case O.down:Ja&&(Ja=0,H())}};window.onbeforeunload=function(a){a.preventDefault();a.returnValue="Are you sure you want to quit?";h.setItem("settings",JSON.stringify(R));return"Are you sure you want to quit?"};t.oncontextmenu=function(a){a.preventDefault();return!1}};