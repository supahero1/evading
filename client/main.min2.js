const e=window.localStorage,aa=e.getItem("keybinds"),f={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft",minimap:"KeyM"};let k=null!=aa?JSON.parse(aa):f;for(const a in f)a in k||(k[a]=f[a]);for(const a in k)a in f||delete k[a];function ba(){e.setItem("keybinds",JSON.stringify(k))}const ca=e.getItem("settings"),l={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},chat_text_scale:{min:1,max:2,value:1,step:.05},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!0,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!0,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1},show_tutorial:!0};let m=null!=ca?JSON.parse(ca):JSON.parse(JSON.stringify(l));for(const a in l)a in m||(m[a]=l[a]);for(const a in m)a in l?(m[a].min&&m[a].min!=l[a].min&&(m[a].min=l[a].min),m[a].max&&m[a].max!=l[a].max&&(m[a].max=l[a].max),m[a].step&&m[a].step!=l[a].step&&(m[a].step=l[a].step),m[a].value=Math.max(Math.min(m[a].value,m[a].max),m[a].min)):delete m[a];function n(){e.setItem("settings",JSON.stringify(m))}const q=document.getElementById.bind(document),r=document.createElement.bind(document),u=q("status"),da=e.getItem("token");let v=[];"string"==typeof da&&(v=da.split(",").map(a=>+a));function ea(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}WebSocket.prototype.send=new Proxy(WebSocket.prototype.send,{apply:function(a,b,c){if(b.readyState==WebSocket.OPEN)return a.apply(b,c)},configurable:!0,enumerable:!0});WebSocket.prototype.close=new Proxy(WebSocket.prototype.close,{apply:function(a,b,c){if(b.readyState==WebSocket.CONNECTING||b.readyState==WebSocket.OPEN)return a.apply(b,c)},configurable:!0,enumerable:!0});function fa(a){return function(b){const c=b instanceof ClipboardEvent;if(!c||"paste"==b.type){var d=b.target.value+(c?b.clipboardData.getData("text"):b.key);if((new TextEncoder).encode(d).byteLength>a){if(""==b.target.value&&c){const h=b.target.placeholder;b.target.placeholder="Text too long to paste!";setTimeout(function(){b.target.placeholder=h},1E3)}b.preventDefault()}}}}function y(a,b,c){return a+(b-a)*c}if(0==window.s.length)throw u.innerHTML="No servers found",setTimeout(location.reload.bind(location),1E3),Error(u.innerHTML);u.innerHTML="Connecting";const z=["#dddddd","#aaaaaa","#333333","#fedf78"],A="#808080 #fc46aa #008080 #ff8e06 #3cdfff #663a82".split(" ");function B(){C.g.style.display="block"}function D(){C.g.style.display="none"}class ha{constructor(){this.g=q("menu");this.name=q("name");this.h=q("selected_serv");this.name.onkeypress=this.name.onpaste=fa(16);const a=e.getItem("name");"string"==typeof a&&16>=(new TextEncoder).encode(a).length&&(this.name.value=a)}}function ia(a){var b=E;b.m=a.m;b.m.onmessage=b.message.bind(b);b.m.onclose=b.close.bind(b);a=F;0==v.length?a.i=1:(a.h.set(v),a.i=v.length);b.send();b.h()}class ja{constructor(){this.m=null;this.i=this.once=!1;this.g=[0,0]}h(){u.innerHTML="";this.once=!0}message({data:a}){F.set(new Uint8Array(a));F.g=1;this.g[0]=this.g[1];this.g[1]=performance.now();a=G;for(var b=0;100>b;++b)void 0!=a.g[b]&&(a.g[b].x1=a.g[b].x2,a.g[b].y1=a.g[b].y2,a.g[b].r1=a.g[b].r2);a=H;for(b=0;65535>b;++b)void 0!=a.g[b]&&(a.g[b].x1=a.g[b].x2,a.g[b].y1=a.g[b].y2,a.g[b].r1=a.g[b].r2);for(K(L);F.g!=F.i;)switch(M()){case 0:H.g=Array(65535);K(L);a=N;M();var c=M(),d=M();b=M();var h=m.fov.max,g=b*h,w=Array(M());for(var t=0;t<w.length;++t)w[t]=[(M()+.5)*g,(M()+.5)*g,M()];t=Array(256);var x=Array(256);for(var I=0;I<c;++I)for(var J=0;J<d;++J){const Q=F.h[F.g];void 0==t[Q]&&(t[Q]=new Path2D,x[Q]=new Path2D);t[Q].rect((1.5+I*b)*h,(1.5+J*b)*h,(b-3)*h,(b-3)*h);x[Q].rect(I*g,J*g,g,g);++F.g}O.id=M()-1;(g=M())&&!O.h?(O.g&&(O.g=!1,B()),O.h=!0,D()):!g&&O.h&&(O.h=!1,B());O.g||g||O.h||-1==O.id||(O.g=!0,D());a.width=c*b;a.height=d*b;a.h.width=a.width*h;a.h.height=a.height*h;a.i.width=a.h.width;a.i.height=a.h.height;for(c=0;256>c;++c)void 0!=t[c]&&(a.g.fillStyle=z[c]+"b0",a.g.fill(x[c]),a.g.fillStyle=z[c],a.g.fill(t[c]),a.j.fillStyle=z[c],a.j.fill(x[c]));a.g.font=`700 ${b}px Ubuntu`;a.g.textAlign="center";a.g.textBaseline="middle";a.g.fillStyle=ea(z[3]);for(var p of w)a.g.fillText(p[2],p[0],p[1]);break;case 1:a=G;b=M();for(w=0;w<b;++w)if(c=M(),void 0==a.g[c])d=P(),h=P(),t=P(),x=M(),x=R(x),g=M(),I=0,g&&(I=M()),J=M(),0<J&&ka(S,x,R(J)),a.g[c]={x:0,y:0,r:0,x1:d,x2:d,y1:h,y2:h,r1:t,r2:t,name:x,F:g,K:I,G:!0},O.id==c&&(c=L,c.g||(c.x2=d,c.y2=h));else if(d=M(),0==d)delete a.g[c],c==O.id&&O.g&&(O.g=!1,B());else{do{switch(d){case 1:a.g[c].x2=P();O.id==c&&(d=L,d.g||(d.x2=a.g[c].x2));break;case 2:a.g[c].y2=P();O.id==c&&(d=L,d.g||(d.y2=a.g[c].y2));break;case 3:a.g[c].r2=P();break;case 4:a.g[c].F=M();a.g[c].F&&(a.g[c].K=M());break;case 5:d=M();ka(S,a.g[c].name,R(d));break;default:throw Error();}d=M()}while(d)}break;case 2:a=H;b=la();for(w=0;w<b;++w)if(c=la(),void 0==a.g[c])d=M()-1,h=P(),t=P(),x=P(),a.g[c]={type:d,x:0,y:0,r:0,x1:h,x2:h,y1:t,y2:t,r1:x,r2:x,G:!1};else if(d=M(),0==d)delete a.g[c];else{do{switch(d){case 1:a.g[c].x2=P();break;case 2:a.g[c].y2=P();break;case 3:a.g[c].r2=P();break;default:throw Error();}d=M()}while(d)}break;case 3:a=S;b=M();for(w=0;w<b;++w)d=M(),c=(new TextDecoder).decode(F.h.subarray(F.g,F.g+d)),F.g+=d,d=M(),ka(a,c,(new TextDecoder).decode(F.h.subarray(F.g,F.g+d))),F.g+=d;break;default:throw Error();}-1==O.id?(p=L,a=.5*N.height,p.g||(p.x2=.5*N.width,p.y2=a),K(p)):(p=L,a=G.g[O.id].y,p.g||(p.x2=G.g[O.id].x,p.y2=a),K(p));0==this.g[0]||this.i||(this.i=!0,p=T,window.requestAnimationFrame(p.u.bind(p)),B(),S.i.style.display="block")}close(){u.innerHTML="Disconnected";C.name.style.display="none";U.l=!1}send(){this.m.send(F.h.subarray(0,F.i))}}function ma(a){a.m=new WebSocket(a.j);a.m.binaryType="arraybuffer";a.m.onopen=a.h.bind(a);a.m.onmessage=a.message.bind(a);a.m.onclose=a.close.bind(a)}class na extends ja{constructor(a,b){super();this.C=0;this.l=b;this.j=a;ma(this)}h(){this.m.send(new ArrayBuffer(0))}message(){8==++this.C?this.l(this.m.url):this.m.send(new ArrayBuffer(0))}close(){ma(this)}stop(){this.m.onopen=this.m.onmessage=this.m.onclose=null;this.m.close()}}function M(){var a=F;return a.h[a.g++]}function la(){var a=F;const b=a.h[a.g]|a.h[a.g+1]<<8;a.g+=2;return b}function P(){var a=F;const b=a.view.getFloat32(a.g,!0);a.g+=4;return b}function R(a){var b=F;const c=(new TextDecoder).decode(b.h.subarray(b.g,b.g+a));b.g+=a;return c}function oa(a){var b=F;b.h[0]=2;b.h.set(a,1);b.i=a.length+1}class pa{constructor(){this.j=new ArrayBuffer(1048576);this.h=new Uint8Array(this.j);this.view=new DataView(this.j);this.g=this.i=0}set(a){this.h.set(a);this.i=a.length;this.g=0}}class qa{constructor(){this.h=r("canvas");this.g=this.h.getContext("2d");this.i()}i(){this.h.width=this.h.height=m.death_arrow_size.value;const a=.5*this.h.width,b=this.h.width;this.g.beginPath();this.g.moveTo(a+.45*b,a);this.g.lineTo(a-.225*b,a-.675*b/Math.sqrt(3));this.g.lineTo(a-.225*b,a+.675*b/Math.sqrt(3));this.g.closePath();this.g.fillStyle="#bbbbbbb0";this.g.fill();this.g.lineWidth=.1*a;this.g.strokeStyle="#f00";this.g.stroke()}}function ka(a,b,c){const d=r("p");d.appendChild(document.createTextNode(b+": "+c));a.g.insertBefore(d,a.g.firstChild);++a.j>m.max_chat_messages.value&&a.g.removeChild(a.g.lastChild)}class ra{constructor(){this.l=Array(5).fill(0);this.h=0;this.i=q("chat");this.g=q("messages");this.o=q("sendmsg");this.H=fa(128);this.j=0;this.o.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=(new TextEncoder).encode(this.o.value.trim());if(0<a.length){oa(a);E.send();this.l[this.h]=(new Date).getTime();a=(this.h+1)%5;const b=this.l[this.h]-this.l[a];this.h=a;if(5E3>b){const c=this.o.placeholder;this.o.placeholder="You are on cooldown for sending too many messages too fast";this.o.I=!0;this.o.onkeypress=this.o.onpaste=null;setTimeout(function(){this.o.onkeypress=this.o.onpaste=this.H;this.o.I=!1;this.o.placeholder=c},5E3-b)}}this.o.value="";this.o.blur();T.h.focus()}}.bind(this);this.o.onkeyup=function(a){a.stopPropagation()};this.o.onkeypress=this.o.onpaste=this.H}focus(a){this.o.I||this.o.focus();a.preventDefault()}u(){for(;this.j>m.max_chat_messages.value;)this.g.removeChild(this.g.lastChild),--this.j}v(){this.g.style["font-size"]=m.chat_text_scale.value+"em"}}function K(a){a.x1=a.x2;a.y1=a.y2}class sa{constructor(){this.y2=this.x2=this.y1=this.x1=this.y=this.x=0;this.g=!1}block(){this.g=!0}}class ta{constructor(){this.g=Array(100)}}class ua{constructor(){this.g=Array(65535);this.g=Array(65535)}}function va(){var a=wa;a.g=!0;return new Promise(function(b){a.h=function(c){a.g=!1;b(c)}})}class xa{constructor(){this.h=null;this.g=!1}}function ya(a){a.j.innerHTML="";V(a,"CHAT");a.add(a.text("Show chat"),W("chat_on",function(b){console.log(b);S.i.style.display=b?"block":"none"}));a.add(a.text("Max number of chat messages"),X(a,"max_chat_messages","",S.u));a.add(a.text("Chat text scale"),X(a,"chat_text_scale","",S.v));V(a,"HELP");a.add(a.text("Enable tutorial"),W("show_tutorial"));V(a,"VISUALS");a.add(a.text("Default FOV"),X(a,"fov"));a.add(a.text("Draw balls' fill"),W("draw_ball_fill"));a.add(a.text("Draw balls' stroke"),W("draw_ball_stroke"));a.add(a.text("Draw stroke-only balls with brighter color"),W("draw_ball_stroke_bright"));a.add(a.text("Balls' stroke radius percentage"),X(a,"ball_stroke","%"));a.add(a.text("Draw players' fill"),W("draw_player_fill"));a.add(a.text("Draw players' stroke"),W("draw_player_stroke"));a.add(a.text("Draw stroke-only players with brighter color"),W("draw_player_stroke_bright"));a.add(a.text("Players' stroke radius percentage"),X(a,"player_stroke","%"));a.add(a.text("Draw players' name"),W("draw_player_name"));a.add(a.text("Draw an arrow towards dead players"),W("draw_death_arrow"));a.add(a.text("Death arrow size"),X(a,"death_arrow_size","px",za.i));V(a,"KEYBINDS");Aa(a,Ba("h5","To change, click a button on the right side and then press the key you want to asign to it."));a.add(a.text("Settings"),Y("settings"));a.add(a.text("Move up"),Y("up"));a.add(a.text("Move left"),Y("left"));a.add(a.text("Move down"),Y("down"));a.add(a.text("Move right"),Y("right"));a.add(a.text("Move slowly"),Y("slowwalk"));a.add(a.text("Big minimap"),Y("minimap"));V(a,"RESET");a.add(a.text("Reset settings"),a.button("RESET",function(){m=l;n();ya(this)}.bind(a)));a.add(a.text("Reset keybinds"),a.button("RESET",function(){k=f;ba();ya(this)}.bind(a)));a.end()}function Aa(a,b){a.j.appendChild(b)}function V(a,b){a.end();Aa(a,Ba("h1",b));a.g=r("table")}function Ba(a,b){a=r(a);a.innerHTML=b;return a}function W(a,b=function(){}){const c=r("button");m[a]=!m[a];let d=!0;c.onclick=function(){m[a]=!m[a];1==m[a]?(c.innerHTML="ON",c.style["background-color"]="#23c552"):(c.innerHTML="OFF",c.style["background-color"]="#f84f31");n();d?d=!1:b(m[a])};c.onclick();return c}function Y(a){const b=r("button");b.innerHTML=k[a];b.onclick=async function(){b.innerHTML="...";const c=await va();b.innerHTML=c;k[a]=c;ba()};b.style.color="#000";return b}function X(a,b,c="",d=function(){}){const h=r("div");h.className="input";const g=r("input");g.type="range";g.min=m[b].min;g.max=m[b].max;g.step=m[b].step;g.value=m[b].value;g.oninput=function(){g.nextElementSibling.innerHTML=g.value+c;m[b].value=g.valueAsNumber;d()};g.onchange=n;h.appendChild(g);h.appendChild(a.text(g.value+c));return h}class Ca{constructor(){this.i=q("settings");this.j=q("ss");this.h=!1;this.g=null;ya(this)}add(a,b){const c=r("tr");let d=r("td");d.appendChild(a);c.appendChild(d);d=r("td");d.appendChild(b);b.onchange=n;c.appendChild(d);this.g.appendChild(c)}end(){null!=this.g&&Aa(this,this.g)}text(a){return Ba("h3",a)}button(a,b){const c=r("button");c.innerHTML=a;c.onclick=b;return c}}class Da{constructor(){this.h=r("canvas");this.g=this.h.getContext("2d");this.i=r("canvas");this.j=this.i.getContext("2d");this.height=this.width=0}}class Ea{constructor(){this.h=q("canvas");this.g=this.h.getContext("2d");this.height=this.width=0;this.j=this.i=m.fov.value;this.y=this.x=0;this.A=!1;this.v=this.l=0;this.h.onwheel=this.J.bind(this);this.h.onmousedown=this.B.bind(this);this.h.oncontextmenu=this.D.bind(this)}stop(){this.A=!0;this.h.parentElement.removeChild(this.h)}J(a){a=.05*-Math.sign(a.deltaY);this.j=1<this.j?this.j+3*a:this.j+a;this.j=Math.min(Math.max(this.j,m.fov.min),m.fov.max)}B(){Z.A=!Z.A;Z.send()}D(a){a.preventDefault();return!1}text(a,b,c){this.g.font="700 20px Ubuntu";this.g.textAlign="center";this.g.textBaseline="middle";this.g.fillStyle="#fff";this.g.strokeStyle="#333";this.g.lineWidth=1;this.g.fillText(a,b,c);this.g.strokeText(a,b,c)}u(a){if(!this.A){this.l=Math.min(Math.max(this.l,E.g[0]),E.g[1]);var b=this.i;this.i=y(this.i,this.j,.1);this.i!=b&&Z.send();b=E.g[0]==E.g[1]?1:(this.l-E.g[0])/(E.g[1]-E.g[0]);this.l+=a-this.v;this.v=a;L.x=y(L.x1,L.x2,b);L.y=y(L.y1,L.y2,b);this.g.resetTransform();this.g.fillStyle="#333";this.g.fillRect(0,0,this.h.width,this.h.height);this.g.translate(.5*this.h.width,.5*this.h.height);this.g.scale(this.i,this.i);this.g.translate(-L.x,-L.y);this.g.drawImage(N.h,0,0,N.width,N.height);1>this.i&&(this.g.globalAlpha=1-4*(this.i-m.fov.min)/3,this.g.drawImage(N.i,0,0,N.width,N.height),this.g.globalAlpha=1);a=Array(65635);var c=0;if(m.draw_player_fill||m.draw_player_stroke)for(var d=0;100>d;++d)void 0!=G.g[d]&&(G.g[d].x=y(G.g[d].x1,G.g[d].x2,b),G.g[d].y=y(G.g[d].y1,G.g[d].y2,b),G.g[d].r=y(G.g[d].r1,G.g[d].r2,b),a[c++]=G.g[d]);if(m.draw_ball_fill||m.draw_ball_stroke)for(d=0;65535>d;++d)void 0!=H.g[d]&&(H.g[d].x=y(H.g[d].x1,H.g[d].x2,b),H.g[d].y=y(H.g[d].y1,H.g[d].y2,b),H.g[d].r=y(H.g[d].r1,H.g[d].r2,b),a[c++]=H.g[d]);a.sort((h,g)=>g.r-h.r);for(b=0;b<a.length;++b)void 0!=a[b]&&(this.g.beginPath(),c=a[b],c.G||(d=m.ball_stroke.value/200*c.r,this.g.moveTo(c.x+c.r-d,c.y),this.g.arc(c.x,c.y,c.r-d,0,2*Math.PI),m.draw_ball_fill&&(this.g.fillStyle=A[c.type],this.g.fill()),m.draw_ball_stroke&&(this.g.strokeStyle=!m.draw_ball_fill&&m.draw_ball_stroke_bright?A[c.type]:ea(A[c.type]),this.g.lineWidth=2*d,this.g.stroke())));window.requestAnimationFrame(this.u.bind(this))}}}class Fa{constructor(){this.h=this.i=this.g=0;this.j=[0,0];this.l=!0;window.onresize=this.u.bind(this);window.onkeyup=this.D.bind(this);window.onkeydown=this.A.bind(this);window.onmousemove=this.B.bind(this);window.onbeforeunload=this.v.bind(this)}u(){if(window.devicePixelRatio!=this.g||window.innerWidth!=this.i||window.innerHeight!=this.h){this.g=window.devicePixelRatio;this.i=window.innerWidth;this.h=window.innerHeight;var a=T;a.width=U.i*U.g;a.height=U.h*U.g;a.h.width=a.width;a.h.height=a.height}}A(a){if(!a.repeat)if(wa.g)a.preventDefault(),wa.h(a.code);else if(a.code==k.settings)Ga.h?(a=Ga,a.h=!1,a.i.style.display="none",Z.h=!1,Z.start()):(a=Ga,a.h=!0,a.i.style.display="block",Z.stop(),Z.block());else switch(a.code){case "Enter":S.focus(a);break;case k.slowwalk:1==Z.g&&(Ha(.5),Z.send());break;case k.up:Z.u||(Z.u=1,Z.send());break;case k.down:Z.l||(Z.l=1,Z.send());break;case k.left:Z.i||(Z.i=1,Z.send());break;case k.right:Z.j||(Z.j=1,Z.send())}}D(a){if(!a.repeat)switch(a.code){case k.slowwalk:.5==Z.g&&(Ha(1),Z.send());break;case k.up:Z.u&&(Z.u=0,Z.send());break;case k.down:Z.l&&(Z.l=0,Z.send());break;case k.left:Z.i&&(Z.i=0,Z.send());break;case k.right:Z.j&&(Z.j=0,Z.send())}}B(a){this.j=[a.clientX*this.g,a.clientY*this.g];Z.send()}v(a){if(this.l)return a.preventDefault(),a.returnValue="Are you sure you want to quit?",n(),"Are you sure you want to quit?"}}function Ha(a){var b=Z;b.h||(b.v=a);b.g=a}class Ia{constructor(){this.A=!1;this.v=this.g=1;this.h=!1;this.j=this.i=this.l=this.u=0}block(){this.h=!0}stop(){this.h||(this.g=this.v,this.v=0,this.send())}start(){this.h||(this.v=this.g,this.send())}send(){if(-1!=O.id&&!this.h){var a=F;let c=0;var b=0;if(Z.A){b=U.j[0]-.5*T.h.width;const d=U.j[1]-.5*T.h.height;c=Math.atan2(d,b);b=Math.hypot(b,d)/T.i}else if(Z.u!=Z.l||Z.i!=Z.j)c=Math.atan2(Z.l-Z.u,Z.j-Z.i),b=160*U.g;a.h[0]=1;a.view.setFloat32(1,c,!0);a.h[5]=b>=160*U.g?255*Z.g:1.59375*b/U.g*Z.g;a.i=6;E.send()}}}class Ja{constructor(){this.h=this.g=!1;this.id=-1}}const C=new ha,E=new ja,F=new pa,za=new qa,S=new ra,L=new sa,G=new ta,H=new ua,wa=new xa,Ga=new Ca,N=new Da,T=new Ea,U=new Fa,Z=new Ia,O=new Ja;U.u();(async function(){u.innerHTML="Connecting";D();S.i.style.display="none";let a;var b=new Promise(function(g){a=g}),c=[];for(const [,,g]of window.s)c[c.length]=new na(g,a);setTimeout(a,2E3,"");b=await b;let d;if(0==b.length){b=0;for(var h of c)h.m.readyState==WebSocket.OPEN&&h.C>b&&(b=h.C,d=h.m.url)}else d=b;if(void 0==d)throw u.innerHTML="Couldn't connect to any server",U.l=!1,setTimeout(location.reload.bind(location),1E3),Error(u.innerHTML);for(const g of c)g.m.url!=d?g.stop():(ia(g),c=d.match(/\/\/(.*?)\.shadam\.xyz/),h=d.match(/\/\/(.*?)[\/:]/),C.h.innerHTML="Selected server: "+(c?c[1]:h?h[1]:d))})();