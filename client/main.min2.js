const f=window.localStorage,g=f.getItem.bind(f),h=f.setItem.bind(f),aa=f.removeItem.bind(f),ba=g("keybinds"),ca={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft",spec_prev:"KeyA",spec_next:"KeyD"};let k=null!=ba?JSON.parse(ba):ca;for(const a in ca)a in k||(k[a]=ca[a]);for(const a in k)a in ca||delete k[a];function da(){h("keybinds",JSON.stringify(k))}const ea=g("settings"),l={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},chat_text_scale:{min:1,max:2,value:1,step:.05},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!0,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!0,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1},show_tutorial:!0,show_ping:!1};let n=null!=ea?JSON.parse(ea):JSON.parse(JSON.stringify(l));for(const a in l)a in n||(n[a]=l[a]);for(const a in n)a in l?(n[a].min&&n[a].min!=l[a].min&&(n[a].min=l[a].min),n[a].max&&n[a].max!=l[a].max&&(n[a].max=l[a].max),n[a].step&&n[a].step!=l[a].step&&(n[a].step=l[a].step),n[a].value=Math.max(Math.min(n[a].value,n[a].max),n[a].min)):delete n[a];function fa(){h("settings",JSON.stringify(n))}const p=document.getElementById.bind(document),q=document.createElement.bind(document),r=p("ID_status"),ha=g("token");let ia=[];"string"==typeof ha&&(ia=ha.split(",").map(a=>+a));function ja(){setTimeout(location.reload.bind(location),1E3)}function ka(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function la(a){const b=a.match(/\/\/(.*?)\.shadam\.xyz/),c=a.match(/\/\/(.*?)[\/:]/);return b?b[1]:c?c[1]:a}WebSocket.prototype.send=new Proxy(WebSocket.prototype.send,{apply:function(a,b,c){if(b.readyState==WebSocket.OPEN)return a.apply(b,c)},configurable:!0,enumerable:!0});WebSocket.prototype.close=new Proxy(WebSocket.prototype.close,{apply:function(a,b,c){if(b.readyState==WebSocket.CONNECTING||b.readyState==WebSocket.OPEN)return a.apply(b,c)},configurable:!0,enumerable:!0});function ma(a){return function(b){const c=b instanceof ClipboardEvent;if(!c||"paste"==b.type){var d=b.target.value+(c?b.clipboardData.getData("text"):b.key);if((new TextEncoder).encode(d).byteLength-b.target.selectionEnd+b.target.selectionStart>a){if(""==b.target.value&&c){const e=b.target.placeholder;b.target.placeholder="Text too long to paste!";setTimeout(function(){b.target.placeholder=e},1E3)}b.preventDefault()}}}}function na(a,b){var c=.75*oa.size;c*=t.h;a=.5*t.width+(a-u.x)*t.h;const d=.5*t.height+(b-u.y)*t.h;b=!1;if(0>a||a>t.width-0)b=!0,a=Math.max(Math.min(a,t.width-c),c);0>d||d>t.height-0?(b=!0,c=Math.max(Math.min(d,t.height-c),c)):c=d;return[(a-.5*t.width)/t.h+u.x,(c-.5*t.height)/t.h+u.y,b]}function v(a,b,c){return a+(b-a)*c}function x(a,b,c){t.g.font="700 20px Ubuntu";t.g.textAlign="center";t.g.textBaseline="middle";t.g.fillStyle="#fff";t.g.strokeStyle="#333";t.g.lineWidth=1;t.g.fillText(a,b,c);t.g.strokeText(a,b,c)}if(0==window.s.length)throw r.innerHTML="No servers found",ja(),Error(r.innerHTML);r.innerHTML="Connecting";const pa=["#dddddd","#aaaaaa","#333333","#fedf78"],qa="#808080 #fc46aa #008080 #ff8e06 #3cdfff #663a82".split(" ");function ra(a){a.h.innerHTML="";for(const b of a.o){const c=q("option");c.value=b[2];b[2]==y.v.url&&(c.selected=!0,c.disabled=!0,a.g=c);b[0]>=b[1]&&(c.disabled=1);const d=la(b[2]);c.innerHTML=d[0].toUpperCase()+d.substring(1)+` (${b[0]}/${b[1]})`;a.h.appendChild(c)}a.h.onfocus=function(){h("psfy_tooltip","");this.J.style.display="none"}.bind(a);a.h.onchange=async function(){this.g.disabled=!1;const b=this.g;this.g=this.h.selectedOptions[0];this.g.disabled=!0;sa();let c;const d=new Promise(function(m){c=m}),e=new ta(this.g.value,c,1);setTimeout(c,2E3);await d;0==e.L||e.v.readyState!=WebSocket.OPEN?(e.stop(),r.innerHTML="Couldn't connect, returning to previous server",this.g.disabled=!1,this.g=b,this.g.disabled=!0,setTimeout(z.j.bind(z),1E3)):ua(e)}.bind(a);va(a)}function wa(){var a=B;ra(a);a.I=setInterval(function(){fetch("servers.json").then(b=>b.json()).then(function(b){B.o=b;ra(B)})},5E3)}function xa(){B.j.style.display="block"}function ya(){var a=B;const b=q("h5");b.id="ID_spec_help";b.innerHTML=a.R;setTimeout(function(){b.style.opacity=0},3E3);b.addEventListener("transitionend",a.H.bind(a));document.body.insertBefore(b,B.j);a.i=b}function va(a){void 0==g("psfy_tooltip")&&(a.T.innerHTML="We picked a server<br>for you automatically.<br><br>You can change it here.",a.J.style.display="table")}class za{constructor(){this.j=p("ID_menu");this.name=p("ID_name");this.h=p("ID_select_serv");this.g=null;this.o=window.s;this.J=p("ID_picked_server_for_you");this.T=p("ID_picked_server_for_you_tooltip");this.A=p("ID_ping");this.K();this.B=p("ID_play");this.u=p("ID_spec");this.i=null;this.R="";this.l();this.F=p("ID_spectating");this.D=p("ID_refresh");var a=p("ID_spec_help");a.parentElement.removeChild(a);this.D.onclick=location.reload.bind(location);this.name.onkeypress=this.name.onpaste=ma(16);this.name.onchange=function(){z.i=!1;h("name",this.value)};this.I=-1;a=g("name");"string"==typeof a&&16>=(new TextEncoder).encode(a).length&&(this.name.value=a);this.B.onclick=function(){var b=D;Aa(b);b.g[0]=0;b.h=1;E(y)};this.u.onclick=function(){Ba(0);E(y)}}l(){this.R=`Press ${k.spec_prev} or ${k.spec_next} to switch between players<br><br>Type "/menu" in chat to return to the main menu`}H(){null!=this.i&&(this.i.parentElement.removeChild(this.i),this.i=null)}K(){this.A.style.display=n.show_ping?"block":"none"}}function E(a){a.v.send(D.g.subarray(0,D.h))}function ua(a){var b=y;null!=b.v&&(b.stop(),b.once=!1,b.i=!1,b.g=[0,0]);b.G=a.G;b.M=a.M;b.C=a.C;b.m=a.m;b.v=a.v;b.v.onmessage=function({data:c}){try{this.message({data:c})}catch(d){console.log(d),console.log(Array.from(new Uint8Array(c)).map(e=>e.toString(16).padStart(2,"0")).join(" "))}}.bind(b);b.v.onclose=b.close.bind(b);Ca();E(b);b.h()}function Da(a){a.G[a.m]=(new Date).getTime()-a.M;a.C=0;let b=a.m,c=0;for(let d=0;10>d;++d)0!=a.G[b]&&(a.C+=(10-c)/11*a.G[b],++c),b=(b+1)%10;0!=c&&(a.C/=.5*c);a.m=(a.m+1)%10;setTimeout(a.j.bind(a),10)}class Ea{constructor(){this.v=null;this.i=this.once=!1;this.G=Array(10).fill(0);this.m=this.C=this.M=0;this.g=[0,0]}h(){this.once=!0;var a=G;a.o=Array(5).fill(0);a.j=0;a.h.innerHTML="";a.i=0;a.u=!1;a.B="Press enter to chat";a.A();u.g=!1;I.g=Array(100);J.g=Array(65535);K.l=-1;a=t;a.h=n.fov.value;a.j=a.h;cancelAnimationFrame(a.o);a.o=-1;a.A=!1;a.l=0;a.u=0;a=L;a.g=!1;a.o=!1;a.u=1;a.h=1;a=z;a.g=!1;a.h=!1;a.i=!1;a.id=-1}message({data:a}){D.set(new Uint8Array(a));if(0==D.h)Da(this);else{var b=M()-1;a=!1;b!=z.id&&(z.id=b,a=!0);b=M();var c=b&1;c&&!z.h?(z.h=!0,B.j.style.display="none",ya(),B.F.style.display="block"):!c&&z.h&&(z.h=!1,xa(),B.H(),B.F.style.display="none",L.o=!1);(c=b&2)&&!z.g?(z.g=!0,B.j.style.display="none"):!c&&z.g&&(z.g=!1,xa(),L.o=!1);B.u.disabled=b&4;this.g[0]=this.g[1];this.g[1]=performance.now();b=I;for(c=0;100>c;++c)void 0!=b.g[c]&&(b.g[c].x1=b.g[c].x2,b.g[c].y1=b.g[c].y2,b.g[c].r1=b.g[c].r2);b=J;for(c=0;65535>c;++c)void 0!=b.g[c]&&(b.g[c].x1=b.g[c].x2,b.g[c].y1=b.g[c].y2,b.g[c].r1=b.g[c].r2);Fa(u);for(b=!1;D.m<D.h;)switch(M()){case 0:b=!0;J.g=Array(65535);c=K;c.l=M();var d=M(),e=M(),m=M(),w=n.fov.max,F=m*w,H=Array(M());for(var A=0;A<H.length;++A)H[A]=[(M()+.5)*F,(M()+.5)*F,M()];A=Array(256);var Q=Array(256);for(var R=0;R<d;++R)for(var S=0;S<e;++S){const V=D.g[D.m];2!=V&&(void 0==A[V]&&(A[V]=new Path2D,Q[V]=new Path2D),A[V].rect((1.5+R*m)*w,(1.5+S*m)*w,(m-3)*w,(m-3)*w),Q[V].rect(R*F,S*F,F,F));++D.m}c.width=d*m;c.height=e*m;c.g=m;c.i.width=c.width*w;c.i.height=c.height*w;c.j.width=c.i.width;c.j.height=c.i.height;for(d=0;256>d;++d)void 0!=A[d]&&(c.h.fillStyle=pa[d]+"b0",c.h.fill(Q[d]),c.h.fillStyle=pa[d],c.h.fill(A[d]),c.o.fillStyle=pa[d],c.o.fill(Q[d]));c.h.font=`700 ${m}px Ubuntu`;c.h.textAlign="center";c.h.textBaseline="middle";c.h.fillStyle=ka(pa[3]);for(var C of H)c.h.fillText(C[2],C[0],C[1]);break;case 1:c=I;m=M();for(H=0;H<m;++H)if(d=M(),void 0==c.g[d])e=N(),w=N(),F=N(),A=M(),A=Ga(A),Q=M(),R=0,Q&&(R=M()),S=M(),0<S&&O(G,A,Ga(S)),c.g[d]={x:0,y:0,r:0,x1:e,x2:e,y1:w,y2:w,r1:F,r2:F,name:A,N:Q,O:R,P:0,S:!0},z.id==d&&(d=u,d.g||(d.x2=e,d.y2=w));else if(e=M(),0==e)delete c.g[d];else{do{switch(e){case 1:c.g[d].x2=N();z.id==d&&(e=u,e.g||(e.x2=c.g[d].x2));break;case 2:c.g[d].y2=N();z.id==d&&(e=u,e.g||(e.y2=c.g[d].y2));break;case 3:c.g[d].r2=N();break;case 4:c.g[d].N=M();c.g[d].N&&(c.g[d].O=M());break;case 5:e=M();O(G,c.g[d].name,Ga(e));break;default:throw Error();}e=M()}while(e)}break;case 2:c=J;m=Ha();for(H=0;H<m;++H)if(d=Ha(),void 0==c.g[d])e=M()-1,w=N(),F=N(),A=N(),c.g[d]={type:e,x:0,y:0,r:0,x1:w,x2:w,y1:F,y2:F,r1:A,r2:A,S:!1};else if(e=M(),0==e)delete c.g[d];else{do{switch(e){case 1:c.g[d].x2=N();break;case 2:c.g[d].y2=N();break;case 3:c.g[d].r2=N();break;default:throw Error();}e=M()}while(e)}break;case 3:c=G;m=M();for(H=0;H<m;++H)e=M(),d=(new TextDecoder).decode(D.g.subarray(D.m,D.m+e)),D.m+=e,e=M(),O(c,d,(new TextDecoder).decode(D.g.subarray(D.m,D.m+e))),D.m+=e;break;default:throw Error();}if(D.m>D.h)throw Error();-1==z.id?(C=u,a=.5*K.height,C.g||(C.x2=.5*K.width,C.y2=a),Fa(C)):a&&(C=u,a=I.g[z.id].y2,C.g||(C.x2=I.g[z.id].x2,C.y2=a),b&&Fa(u));0==this.g[0]||this.i||(this.i=!0,C=t,C.o=window.requestAnimationFrame(C.B.bind(C)),z.j())}}close(a){4E3==a?(Ia(),r.innerHTML="Server is full"):Ia()}j(){this.M=(new Date).getTime();this.v.send(new Uint8Array(0))}stop(){this.v.onopen=this.v.onmessage=this.v.onclose=null;this.v.close()}}function Ja(a){a.v=new WebSocket(a.l);a.v.binaryType="arraybuffer";a.v.onopen=a.h.bind(a);a.v.onmessage=a.message.bind(a);a.v.onclose=a.close.bind(a)}class ta extends Ea{constructor(a,b,c=8){super();this.L=0;this.o=c;this.u=b;this.l=a;Ja(this)}h(){this.j()}message(){Da(this);++this.L==this.o&&this.u(this.v.url)}close(){Ja(this)}}function Ba(a){var b=D;b.g[0]=4;b.g[1]=a;b.h=2}function Ca(){var a=D;0==ia.length?a.h=1:(a.g.set(ia),a.h=ia.length)}function M(){var a=D;return a.g[a.m++]}function Ha(){var a=D;const b=a.g[a.m]|a.g[a.m+1]<<8;a.m+=2;return b}function N(){var a=D;const b=a.view.getFloat32(a.m,!0);a.m+=4;return b}function Ga(a){var b=D;const c=(new TextDecoder).decode(b.g.subarray(b.m,b.m+a));b.m+=a;return c}function Aa(a){if(!z.i){z.i=!0;a.g[0]=3;var b=B;b=(new TextEncoder).encode(b.name.value);a.g.set(b,1);a.h=b.length+1;E(y)}}class Ka{constructor(){this.i=new ArrayBuffer(1048576);this.g=new Uint8Array(this.i);this.view=new DataView(this.i);this.m=this.h=0}set(a){this.g.set(a);this.h=a.length;this.m=0}}function La(a){var b=oa;a.drawImage(b.h,.5*-b.h.width,.5*-b.h.height)}class Ma{constructor(){this.h=q("canvas");this.g=this.h.getContext("2d");this.size=0;this.i()}i(){this.size=n.death_arrow_size.value;this.h.width=this.h.height=this.size;const a=.5*this.h.width,b=this.h.width;this.g.beginPath();this.g.moveTo(a+.45*b,a);this.g.lineTo(a-.225*b,a-.675*b/Math.sqrt(3));this.g.lineTo(a-.225*b,a+.675*b/Math.sqrt(3));this.g.closePath();this.g.fillStyle="#bbbbbbb0";this.g.fill();this.g.lineWidth=.1*a;this.g.strokeStyle="#f00";this.g.stroke()}}function Na(a){void 0==g("tth_tooltip")&&(a.K.innerHTML='Try "/help"',a.F.style.display="inline-block")}function O(a,b,c,d=!1){const e=q("p");e.appendChild(document.createTextNode((d?"":b+": ")+c));a.h.insertBefore(e,a.h.firstChild);++a.i>n.max_chat_messages.value&&a.h.removeChild(a.h.lastChild)}function Oa(a){a.g.value="";a.g.blur();t.i.focus()}function Pa(a,b){a.B=a.g.placeholder;a.g.placeholder=b;a.g.disabled=!0;a.g.value="";t.i.focus()}function Qa(){var a=G;!a.u&&n.chat_on&&(a.D.style.display="block")}class Ra{constructor(){this.o=Array(5).fill(0);this.j=0;this.D=p("ID_chat");this.h=p("ID_messages");this.g=p("ID_sendmsg");this.F=p("ID_try_typing_help");this.K=p("ID_try_typing_help_tooltip");Na(this);this.J=ma(128);this.i=0;this.u=!1;this.B="";this.l=-1;this.g.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=this.g.value.trim();switch(a){case "/help":O(this,null,">",!0);O(this,null,"Available commands:",!0);O(this,null,"/clear /c => clear the chat",!0);O(this,null,"/respawn /r => tp to the first area",!0);O(this,null,"/die /d => become downed",!0);O(this,null,"/menu /m => quit the game and open the menu",!0);O(this,null,">",!0);Oa(this);h("tth_tooltip","");this.F.style.display="none";return;case "/c":case "/clear":this.h.innerHTML="";this.i=0;Oa(this);return}a=(new TextEncoder).encode(a);if(0<a.length){var b=D;Aa(b);b.g[0]=2;b.g.set(a,1);b.h=a.length+1;E(y);this.o[this.j]=(new Date).getTime();a=(this.j+1)%5;b=5E3-this.o[this.j]+this.o[a];this.j=a;0<b?(Pa(this,"You are on cooldown for sending too many messages too quickly"),this.l=setTimeout(this.A.bind(this),b)):Oa(this)}}}.bind(this);this.g.onkeyup=function(a){a.stopPropagation()};this.g.onkeypress=this.g.onpaste=this.J}A(){-1!=this.l&&(clearTimeout(this.l),this.l=-1);this.g.disabled=!1;this.g.placeholder=this.B}focus(){this.g.focus()}H(){for(;this.i>n.max_chat_messages.value;)this.h.removeChild(this.h.lastChild),--this.i}I(){this.h.style["font-size"]=n.chat_text_scale.value+"em"}}function Fa(a){a.x1=a.x2;a.y1=a.y2}function Sa(a,b,c){var d=u;d.x2=v(d.x2,a,c);d.y2=v(d.y2,b,c)}class Ta{constructor(){this.y2=this.x2=this.y1=this.x1=this.y=this.x=0;this.g=!1}block(){this.g=!0}}class Ua{constructor(){this.g=Array(100)}}class Va{constructor(){this.g=Array(65535)}}function Wa(){var a=Xa;a.g=!0;return new Promise(function(b){a.h=function(c){a.g=!1;b(c)}})}class Ya{constructor(){this.h=null;this.g=!1}}function Za(a){switch($a.g){case 0:n.show_tutorial&&0==K.l&&x("Need help? Press KeyT for a tutorial.",.5*K.width,2.5*K.g);break;case 1:x("<-- Your character",u.x+110,u.y);x("Your character --\x3e",u.x-110,u.y);x("This is your character. You can control it with these keys:",u.x,u.y-220);x(`${k.up}: up`,u.x,u.y-170);x(`${k.left}: left`,u.x,u.y-130);x(`${k.down}: down`,u.x,u.y-90);x(`${k.right}: right`,u.x,u.y-50);x("You can also control it with mouse. Just",u.x,u.y+50);x("press any mouse button to start or stop moving.",u.x,u.y+70);x("Scroll to change your field of view.",u.x,u.y+110);x("Note that you won't be able to perform some",u.x,u.y+150);x("of the above actions until the tutorial ends.",u.x,u.y+170);x("Press KeyT to continue",u.x,u.y+220);break;case 2:var b=.5*K.width-6*K.g,c=.5*K.height;Sa(b,c,.2*a);x("--\x3e",b+2*K.g,c-1*K.g);x("--\x3e",b+2*K.g,c);x("--\x3e",b+2*K.g,c+1*K.g);x("<--",b-2*K.g,c-2*K.g);x("<--",b-3*K.g,c-1*K.g);x("<--",b-4*K.g,c);x("<--",b-3*K.g,c+1*K.g);x("<--",b-2*K.g,c+2*K.g);x("These are safezones. Enemies can't",b,c-130);x("reach you inside of these tiles.",b,c-110);x("Press KeyT to continue",b,c+110);break;case 3:b=.5*K.width+6*K.g;c=.5*K.height;Sa(b,c,.2*a);x("<--",b-2*K.g,c-2*K.g);x("<--",b-1*K.g,c-3*K.g);x("<--",b,c-4*K.g);x("<--",b-2*K.g,c+2*K.g);x("<--",b-1*K.g,c+3*K.g);x("<--",b,c+4*K.g);x("--\x3e",b+2*K.g,c-3*K.g);x("--\x3e",b+2*K.g,c+3*K.g);x("<--",b+5*K.g,c-2*K.g);x("<--",b+6*K.g,c-1*K.g);x("<--",b+7*K.g,c);x("<--",b+6*K.g,c+1*K.g);x("<--",b+5*K.g,c+2*K.g);x("These are walls. Players can't walk over them.",b,c-40);x("However, some types (colors) of enemies can.",b,c-10);x("Press KeyT to continue",b,c+40);break;case 4:b=.5*K.g;c=.5*K.height;Sa(b,c,.2*a);x("--\x3e",b,c);x("This is a teleport tile. If you walk on it,",b,c-130);x("you will be teleported to the area it points to.",b,c-110);x("Minimap is not yet implemented, but once it is, you",b,c-70);x("will be able to see where any area is located at.",b,c-50);x("If a teleport doesn't have a number on it, it doesn't point",b,c+50);x("anywhere (perhaps because the next area is under construction).",b,c+70);x("Press KeyT to continue",b,c+120);break;case 5:for(c=0;65535>c;++c)if(J.g[c]){b=J.g[c];break}c=b.x2;b=b.y2;Sa(c,b,.2*a);x("Enemy ball --\x3e",c-110,b);x("<-- Enemy ball",c+110,b);x("This is an enemy, also called simply a ball. A grey ball",c,b-110);x("doesn't do a lot - it simply moves in one direction. However,",c,b-90);x("as you are about to find out when you start exploring the game,",c,b-70);x("there are lots of types of enemies, each having their own color.",c,b-50);x("Coming in contact with an enemy downs you. While downed, you can't move,",c,b+50);x("and after a while, you die, unless other players revive you by touching you.",c,b+70);x("Press KeyT to continue",c,b+120);break;case 6:b=I.g[z.id].x2,c=I.g[z.id].y2,Sa(b,c,.2*a),x(`You can press ${k.settings} to open settings.`,b,c-80),x("There are a lot of cool options to change. Try it out later.",b,c-60),x("That's it for this tutorial. See how far you can go!",b,c+60),x("GLHF!",b,c+80),x("Press KeyT to end the tutorial",b,c+130)}}class ab{constructor(){this.i=this.g=0;this.h=null}progress(){0==this.g?n.show_tutorial&&z.g&&(this.g=1,this.i=t.j,t.j=n.fov.max,u.block(),bb(),L.block()):7==++this.g&&(this.h.click(),this.g=0,t.j=this.i,u.g=!1,P.g=!1,L.g=!1)}}function bb(){var a=P;a.i&&(a.g=!1,cb(a));a.g=!0}function db(a){a.l.innerHTML="";T(a,"CHAT");a.add(a.text("Show chat"),U("chat_on",function(b){b?Qa():(b=G,b.u||(b.D.style.display="none"))}));a.add(a.text("Max number of chat messages"),W(a,"max_chat_messages","",G.H.bind(G)));a.add(a.text("Chat text scale"),W(a,"chat_text_scale","",G.I.bind(G)));T(a,"MENU");a.add(a.text("Show latency"),U("show_ping",B.K.bind(B)));T(a,"GAME");$a.h=U("show_tutorial");a.add(a.text("Enable tutorial"),$a.h);T(a,"VISUALS");a.add(a.text("Default FOV"),W(a,"fov"));a.add(a.text("Draw balls' fill"),U("draw_ball_fill"));a.add(a.text("Draw balls' stroke"),U("draw_ball_stroke"));a.add(a.text("Draw stroke-only balls with brighter color"),U("draw_ball_stroke_bright"));a.add(a.text("Balls' stroke radius percentage"),W(a,"ball_stroke","%"));a.add(a.text("Draw players' fill"),U("draw_player_fill"));a.add(a.text("Draw players' stroke"),U("draw_player_stroke"));a.add(a.text("Draw stroke-only players with brighter color"),U("draw_player_stroke_bright"));a.add(a.text("Players' stroke radius percentage"),W(a,"player_stroke","%"));a.add(a.text("Draw players' name"),U("draw_player_name"));a.add(a.text("Draw an arrow towards dead players"),U("draw_death_arrow"));a.add(a.text("Death arrow size"),W(a,"death_arrow_size","px",oa.i.bind(oa)));T(a,"KEYBINDS");eb(a,fb("h5","To change, click a button on the right side and then press the key you want to assign to it."));a.add(a.text("Settings"),X("settings"));a.add(a.text("Move up"),X("up"));a.add(a.text("Move left"),X("left"));a.add(a.text("Move down"),X("down"));a.add(a.text("Move right"),X("right"));a.add(a.text("Move slowly"),X("slowwalk"));a.add(a.text("Spectate previous player"),X("spec_prev",B.l.bind(B)));a.add(a.text("Spectate next player"),X("spec_next",B.l.bind(B)));T(a,"RESET");a.add(a.text("Reset settings"),a.button("RESET",function(){n=JSON.parse(JSON.stringify(l));fa();db(this)}.bind(a)));a.add(a.text("Reset keybinds"),a.button("RESET",function(){k=JSON.parse(JSON.stringify(ca));da();db(this)}.bind(a)));a.add(a.text("Reset all tooltips"),a.button("RESET",function(){aa("psfy_tooltip");va(B);aa("tth_tooltip");Na(G)}));a.end()}function cb(a){a.g||(a.i=!1,a.j.style.display="none",L.g=!1,L.start())}function eb(a,b){a.l.appendChild(b)}function T(a,b){a.end();eb(a,fb("h1",b));a.h=q("table")}function fb(a,b){a=q(a);a.innerHTML=b;return a}function U(a,b=function(){}){const c=q("button");n[a]=!n[a];let d=!0;c.onclick=function(){n[a]=!n[a];1==n[a]?(c.innerHTML="ON",c.style["background-color"]="#23c552"):(c.innerHTML="OFF",c.style["background-color"]="#f84f31");fa();d?d=!1:b(n[a])};c.onclick();return c}function X(a,b=function(){}){const c=q("button");c.innerHTML=k[a];c.onclick=async function(){c.innerHTML="...";const d=await Wa();c.innerHTML=d;k[a]=d;da();b()};c.style.color="#000";return c}function W(a,b,c="",d=function(){}){const e=q("div");e.className="input";const m=q("input");m.type="range";m.min=n[b].min;m.max=n[b].max;m.step=n[b].step;m.value=n[b].value;m.oninput=function(){m.nextElementSibling.innerHTML=m.value+c;n[b].value=m.valueAsNumber;d()};m.onchange=fa;e.appendChild(m);e.appendChild(a.text(m.value+c));return e}class gb{constructor(){this.j=p("ID_settings_container");this.l=p("ID_settings");this.g=this.i=!1;this.h=null;db(this)}add(a,b){const c=q("tr");let d=q("td");d.appendChild(a);c.appendChild(d);d=q("td");d.appendChild(b);b.onchange=fa;c.appendChild(d);this.h.appendChild(c)}end(){null!=this.h&&(eb(this,this.h),this.h=null)}text(a){return fb("h3",a)}button(a,b){const c=q("button");c.innerHTML=a;c.onclick=b;return c}}class hb{constructor(){this.i=q("canvas");this.h=this.i.getContext("2d");this.j=q("canvas");this.o=this.j.getContext("2d");this.g=this.height=this.width=0;this.l=-1}}class ib{constructor(){this.i=p("ID_canvas");this.g=this.i.getContext("2d");this.height=this.width=0;this.j=this.h=n.fov.value;this.o=-1;this.A=!1;this.u=this.l=0;this.i.onwheel=this.F.bind(this);this.i.onmousedown=this.D.bind(this)}stop(){this.A=!0;this.i.parentElement.removeChild(this.i)}F(a){a=.05*-Math.sign(a.deltaY);this.j=1<this.j?this.j+3*a:this.j+a;this.j=Math.min(Math.max(this.j,n.fov.min),n.fov.max)}D(){L.o=!L.o;Y(L)}text(a,b,c){this.g.font="700 20px Ubuntu";this.g.textAlign="center";this.g.textBaseline="middle";this.g.fillStyle="#fff";this.g.strokeStyle="#333";this.g.lineWidth=1;this.g.fillText(a,b,c);this.g.strokeText(a,b,c)}B(a){if(!this.A){this.l=Math.min(Math.max(this.l,y.g[0]),y.g[1]);var b=this.h;this.h=v(this.h,this.j,.1);this.h!=b&&Y(L);b=y.g[0]==y.g[1]?1:(this.l-y.g[0])/(y.g[1]-y.g[0]);this.l+=a-this.u;this.u=a;n.show_ping&&(B.A.innerHTML=y.C.toFixed(1)+"ms");u.x=v(u.x1,u.x2,b);u.y=v(u.y1,u.y2,b);this.g.resetTransform();this.g.fillStyle="#333";this.g.fillRect(0,0,this.i.width,this.i.height);this.g.translate(.5*this.i.width,.5*this.i.height);this.g.scale(this.h,this.h);this.g.translate(-u.x,-u.y);this.g.drawImage(K.i,0,0,K.width,K.height);1>this.h&&(this.g.globalAlpha=1-4*(this.h-n.fov.min)/3,this.g.drawImage(K.j,0,0,K.width,K.height),this.g.globalAlpha=1);a=Array(65635);var c=0;if(n.draw_player_fill||n.draw_player_stroke)for(var d=0;100>d;++d)void 0!=I.g[d]&&(I.g[d].x=v(I.g[d].x1,I.g[d].x2,b),I.g[d].y=v(I.g[d].y1,I.g[d].y2,b),I.g[d].r=v(I.g[d].r1,I.g[d].r2,b),a[c++]=I.g[d]);if(n.draw_ball_fill||n.draw_ball_stroke)for(d=0;65535>d;++d)void 0!=J.g[d]&&(J.g[d].x=v(J.g[d].x1,J.g[d].x2,b),J.g[d].y=v(J.g[d].y1,J.g[d].y2,b),J.g[d].r=v(J.g[d].r1,J.g[d].r2,b),a[c++]=J.g[d]);a.sort((m,w)=>w.r-m.r);for(c=0;c<a.length;++c)if(void 0!=a[c])if(this.g.beginPath(),d=a[c],d.S){var e=n.player_stroke.value/200*d.r;this.g.moveTo(d.x+d.r-e,d.y);this.g.arc(d.x,d.y,d.r-e,0,2*Math.PI);n.draw_player_fill&&(this.g.fillStyle="#ebecf0",this.g.fill());n.draw_player_stroke&&(!n.draw_player_fill&&n.draw_player_stroke_bright?this.g.strokeStyle="#ebecf0":this.g.strokeStyle=ka("#ebecf0"),this.g.lineWidth=2*e,this.g.stroke());n.draw_player_name&&0!=d.name.length&&(this.g.font=`700 ${d.r/this.h}px Ubuntu`,this.g.textAlign="center",this.g.textBaseline="middle",this.g.fillStyle="#00000080",d.P=v(d.P,1<this.h?.5*d.r:.5*d.r+2/(this.h*this.h),.1),this.g.fillText(d.name,d.x,d.y-d.r-d.P));if(d.N&&(this.g.font=`700 ${d.r/Math.min(this.h,1)}px Ubuntu`,this.g.textAlign="center",this.g.textBaseline="middle",this.g.fillStyle="#f00",this.g.fillText(d.O,d.x,d.y),n.draw_death_arrow)){const [m,w,F]=na(d.x,d.y);F&&(this.g.translate(m,w),e=Math.atan2(d.y-w,d.x-m),this.g.rotate(e),La(this.g),this.g.rotate(-e),this.g.font=`700 ${.3*oa.size}px Ubuntu`,this.g.fillText(d.O,0,0),this.g.translate(-m,-w))}}else e=n.ball_stroke.value/200*d.r,this.g.moveTo(d.x+d.r-e,d.y),this.g.arc(d.x,d.y,d.r-e,0,2*Math.PI),n.draw_ball_fill&&(this.g.fillStyle=qa[d.type],this.g.fill()),n.draw_ball_stroke&&(this.g.strokeStyle=!n.draw_ball_fill&&n.draw_ball_stroke_bright?qa[d.type]:ka(qa[d.type]),this.g.lineWidth=2*e,this.g.stroke());Za(b);this.o=window.requestAnimationFrame(this.B.bind(this))}}}class jb{constructor(){this.h=this.i=this.g=0;this.j=[0,0];window.onresize=this.l.bind(this);window.onkeyup=this.A.bind(this);window.onkeydown=this.u.bind(this);window.onmousemove=this.B.bind(this);window.onbeforeunload=this.o.bind(this)}l(){if(window.devicePixelRatio!=this.g||window.innerWidth!=this.i||window.innerHeight!=this.h){this.g=window.devicePixelRatio;this.i=window.innerWidth;this.h=window.innerHeight;var a=t;a.width=Z.i*Z.g;a.height=Z.h*Z.g;a.i.width=a.width;a.i.height=a.height}}u(a){if(!a.repeat)if(Xa.g)a.preventDefault(),Xa.h(a.code);else if(a.code==k.settings)P.i?cb(P):(a=P,a.g||(a.i=!0,a.j.style.display="block",L.stop(),L.block()));else{if(z.h)switch(a.code){case k.spec_prev:Ba(-1),E(y);case k.spec_next:Ba(1),E(y)}switch(a.code){case "Enter":G.focus(a);break;case k.up:L.A||(L.A=1,Y(L));break;case k.down:L.l||(L.l=1,Y(L));break;case k.left:L.i||(L.i=1,Y(L));break;case k.right:L.j||(L.j=1,Y(L));break;case k.slowwalk:1==L.u&&(kb(.5),Y(L));break;case "KeyT":$a.progress()}}}A(a){if(!a.repeat)switch(a.code){case k.up:L.A&&(L.A=0,Y(L));break;case k.down:L.l&&(L.l=0,Y(L));break;case k.left:L.i&&(L.i=0,Y(L));break;case k.right:L.j&&(L.j=0,Y(L));break;case k.slowwalk:.5==L.u&&(kb(1),Y(L))}}B(a){this.j=[a.clientX*this.g,a.clientY*this.g];Y(L)}o(a){if(z.g)return a.preventDefault(),a.returnValue="Are you sure you want to quit?"}}function Y(a){if(z.g&&!a.g){a=D;let c=0;var b=0;if(L.o){b=Z.j[0]-.5*t.i.width;const d=Z.j[1]-.5*t.i.height;c=Math.atan2(d,b);b=Math.hypot(b,d)/t.h}else if(L.A!=L.l||L.i!=L.j)c=Math.atan2(L.l-L.A,L.j-L.i),b=160*Z.g;a.g[0]=1;a.view.setFloat32(1,c,!0);a.g[5]=b>=160*Z.g?255*L.h:1.59375*b/Z.g*L.h;a.h=6;E(y)}}function kb(a){var b=L;b.g||(b.h=a);b.u=a}class lb{constructor(){this.o=!1;this.h=this.u=1;this.g=!1;this.j=this.i=this.l=this.A=0}block(){this.g=!0}stop(){this.g||(this.u=this.h,this.h=0,Y(this))}start(){this.g||(this.h=this.u,Y(this))}}function sa(){xa();B.name.style.display="none";r.innerHTML="Connecting";Qa();Pa(G,"Waiting for connection...");bb()}function Ia(){z.g=!1;xa();r.innerHTML="Disconnected";var a=B;y.once||ja();a.name.style.display="none";a.B.style.display="none";a.u.style.display="none";a.D.style.display="block";clearInterval(a.I);bb()}class mb{constructor(){this.i=this.h=this.g=!1;this.id=-1}j(){xa();B.name.style.display="block";r.innerHTML="";G.A();P.g=!1}}const B=new za,y=new Ea,D=new Ka,oa=new Ma,G=new Ra,u=new Ta,I=new Ua,J=new Va,Xa=new Ya,$a=new ab,P=new gb,K=new hb,t=new ib,Z=new jb,L=new lb,z=new mb;Z.l();(async function(){sa();let a;var b=new Promise(function(e){a=e});const c=[];for(const [,,e]of B.o)c[c.length]=new ta(e,a);setTimeout(a,2E3,"");b=await b;let d;if(0==b.length){b=0;for(const e of c)e.v.readyState==WebSocket.OPEN&&e.L>b&&(b=e.L,d=e.v.url)}else d=b;if(void 0==d)throw r.innerHTML="Couldn't connect to any server",ja(),Error(r.innerHTML);for(const e of c)e.v.url!=d?e.stop():ua(e);wa()})();