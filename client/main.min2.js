const d=document.getElementById.bind(document),f=document.createElement.bind(document),k=window.localStorage;let l=d("loading");l.innerHTML="Fetching servers...";let aa=d("sub"),m=d("name"),r=d("canvas"),v=r.getContext("2d"),w=f("canvas"),ba=w.getContext("2d"),ca=f("canvas"),da=ca.getContext("2d"),x=f("canvas"),y=x.getContext("2d"),ea=0,fa=["#dddddd","#aaaaaa","#333333","#fedf78"],ha="#808080 #fc46aa #008080 #ff8e06 #3cdfff #663a82".split(" "),ia=0,ja=0,z=0,ka=new ArrayBuffer(1048576),A=new Uint8Array(ka),C=new DataView(A.buffer),la=0,ma=0,D=[],E=[];var F=0,H=0,na=0,oa=0,pa=0,qa=0;let I=[0,0],J=null,ra=0,K=[0,0],sa=0,va=0,wa=0,xa=d("settings"),ya=d("ss"),L=!1,za=Array(5).fill(0),Aa=k.getItem("tutorial")?1:0,M=0,Ba=0,Ca=0,Ea=k.getItem("keybinds"),Fa={settings:"Escape",up:"KeyW",left:"KeyA",right:"KeyD",down:"KeyS",slowwalk:"ShiftLeft"},N=null!=Ea?JSON.parse(Ea):Fa;for(let b in Fa)void 0==N[b]&&(N[b]=Fa[b]);for(let b in N)void 0==Fa[b]&&delete N[b];var Ga=0,Ha=0,Ia=0,Ja=0,Ka=1,La=0,Ma=0,O=0,Na=0,Oa=0,Pa=0,Qa=0,Ra=0,P=0,Sa=[],Ta=[];let Ua=k.getItem("settings"),Q={fov:{min:.25,max:1.75,value:1.75,step:.05},chat_on:!0,max_chat_messages:{min:1,max:1E3,value:100,step:1},chat_text_scale:{min:1,max:2,value:1,step:.05},draw_ball_fill:!0,draw_ball_stroke:!0,draw_ball_stroke_bright:!1,ball_stroke:{min:0,max:100,value:20,step:1},draw_player_fill:!0,draw_player_stroke:!0,draw_player_stroke_bright:!1,player_stroke:{min:0,max:100,value:10,step:1},draw_player_name:!0,draw_death_arrow:!0,death_arrow_size:{min:10,max:100,value:40,step:1}},R=null!=Ua?JSON.parse(Ua):JSON.parse(JSON.stringify(Q));for(let b in Q)void 0==R[b]&&(R[b]=Q[b]);for(let b in R)void 0==Q[b]&&delete R[b],R[b].min&&R[b].min!=Q[b].min&&(R[b].min=Q[b].min),R[b].max&&R[b].max!=Q[b].max&&(R[b].max=Q[b].max),R[b].value=Math.max(Math.min(R[b].value,R[b].max),R[b].min);k.setItem("settings",JSON.stringify(R));let Va=!1,Wa="",Ya,S=R.fov.value,T=S,Za=d("chat"),$a=d("messages"),U=d("sendmsg"),ab=R.chat_on,bb=0;window.s.then(b=>b.json()).then(b=>cb(b));function db(){setTimeout(location.reload.bind(location),1E3)}function eb(){k.setItem("settings",JSON.stringify(R))}function fb(){k.setItem("keybinds",JSON.stringify(N))}function V(b){ya.appendChild(b)}function gb(b){let e=f("h1");e.innerHTML=b;return e}function W(b){let e=f("h3");e.innerHTML=b;return e}function hb(){let b=f("h5");b.innerHTML="To change, click a button on the right side and then press the key you want to asign to it.";return b}function X(b,e,t){let q=f("tr"),n=f("td");n.appendChild(e);q.appendChild(n);n=f("td");n.appendChild(t);q.appendChild(n);b.appendChild(q)}function Y(b){let e=f("button");R[b]=!R[b];e.onclick=function(){R[b]=!R[b];1==R[b]?(e.innerHTML="ON",e.style["background-color"]="#23c552"):(e.innerHTML="OFF",e.style["background-color"]="#f84f31");eb()};e.onclick();return e}function ib(b){let e=f("button");e.innerHTML=N[b];e.onclick=async function(){e.innerHTML="...";Va=1;await new Promise(function(t){Ya=t});Va=0;e.innerHTML=Wa;N[b]=Wa;fb()};return e}function jb(b,e="",t=function(){}){let q=f("div");q.className="input";let n=f("input");n.type="range";n.min=R[b].min;n.max=R[b].max;n.step=R[b].step;n.value=R[b].value;n.oninput=function(){n.nextElementSibling.innerHTML=n.value+e;R[b].value=n.valueAsNumber;t()};n.onchange=eb;q.appendChild(n);q.appendChild(W(n.value+e));return q}function kb(b){let e=f("button");e.innerHTML="RESET";e.onclick=b;return e}function lb(){ya.innerHTML="";V(gb("CHAT"));let b=f("table");X(b,W("Show chat"),Y("chat_on"));X(b,W("Max number of chat messages"),jb("max_chat_messages","",function(){for(;bb>R.max_chat_messages.value;)$a.removeChild($a.lastChild),--bb}));X(b,W("Chat text scale"),jb("chat_text_scale","",function(){$a.style["font-size"]=R.chat_text_scale.value+"em"}));V(b);V(gb("VISUALS"));b=f("table");X(b,W("Default FOV"),jb("fov"));X(b,W("Draw balls' fill"),Y("draw_ball_fill"));X(b,W("Draw balls' stroke"),Y("draw_ball_stroke"));X(b,W("Draw stroke-only balls with brighter color"),Y("draw_ball_stroke_bright"));X(b,W("Balls' stroke radius percentage"),jb("ball_stroke"," %"));X(b,W("Draw players' fill"),Y("draw_player_fill"));X(b,W("Draw players' stroke"),Y("draw_player_stroke"));X(b,W("Draw stroke-only players with brighter color"),Y("draw_player_stroke_bright"));X(b,W("Players' stroke radius percentage"),jb("player_stroke"," %"));X(b,W("Draw players' name"),Y("draw_player_name"));X(b,W("Draw an arrow towards dead players"),Y("draw_death_arrow"));X(b,W("Death arrow size"),jb("death_arrow_size","px",mb));V(b);V(gb("KEYBINDS"));V(hb());b=f("table");X(b,W("Settings"),ib("settings"));X(b,W("Move up"),ib("up"));X(b,W("Move left"),ib("left"));X(b,W("Move down"),ib("down"));X(b,W("Move right"),ib("right"));X(b,W("Move slowly"),ib("slowwalk"));V(b);V(gb("RESET"));b=f("table");X(b,W("Reset settings"),kb(function(){R=Q;eb();lb()}));X(b,W("Reset keybinds"),kb(function(){N=Fa;fb();lb()}));V(b)}lb();function pb(b,e){let t=f("p");t.appendChild(document.createTextNode(b+": "+e));$a.insertBefore(t,$a.firstChild);++bb>R.max_chat_messages.value&&$a.removeChild($a.lastChild)}function mb(){x.width=x.height=R.death_arrow_size.value;let b=.5*x.width,e=x.width;y.beginPath();y.moveTo(b+.45*e,b);y.lineTo(b-.225*e,b-.675*e/Math.sqrt(3));y.lineTo(b-.225*e,b+.675*e/Math.sqrt(3));y.closePath();y.fillStyle="#bbbbbbb0";y.fill();y.lineWidth=.05*x.width;y.strokeStyle="#f00";y.stroke()}mb();function cb(b){if(0==b.length)l.innerHTML="No servers found",db();else{l.innerHTML="Connecting...";var e=b.map(function(t){t=new WebSocket(t[1]);t.binaryType="arraybuffer";t.i=[];t.onopen=function(){this.send(new Uint8Array(0));this.time=performance.now()};t.onmessage=function(){this.i[this.i.length]=performance.now()-this.time;5>this.i.length&&this.send(new Uint8Array(0))};return t});setTimeout(function(){let t=999999,q=null;for(let n of e){n.h=0;for(let G of n.i)n.h+=G;0<n.i.length?n.h/=n.i.length:n.h=999999;n.h<t&&(t=n.h,q=n)}for(let n of e)n.onopen=function(){},n.onmessage=function(){},delete n.i,delete n.time,delete n.h,n!=q&&n.close();null==q||1!=q.readyState?(l.innerHTML="Failed connecting",db()):qb(q)},1E3)}}function rb(){na=oa;pa=qa;for(let b of D)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2);for(let b of E)b&&(b.g.x1=b.g.x2,b.g.y1=b.g.y2,b.g.r1=b.g.r2)}function sb(b){return function(e){let t=e instanceof ClipboardEvent;if(t&&"paste"!=e.type)return!0;let q=e.target.value+(t?e.clipboardData.getData("text"):e.key);if((new TextEncoder).encode(q).byteLength>b){if(""==e.target.value&&t){const n=e.target.placeholder;e.target.placeholder="Text too long to paste!";setTimeout(function(){e.target.placeholder=n},1E3)}e.preventDefault();return!1}return!0}}function Z(b,e,t){v.translate(e,t);v.font="700 20px Ubuntu";v.textAlign="center";v.textBaseline="middle";v.fillStyle="#fff";v.strokeStyle="#333";v.lineWidth=1;v.fillText(b,0,0);v.strokeText(b,0,0);v.translate(-e,-t)}function qb(b){l.innerHTML="Enter your name<br>";aa.innerHTML="You are limited to 4 characters<br>Special characters might not fit<br>Press enter when you are done";m.style.display="block";m.focus();let e=k.getItem("name");e&&(m.value=e);m.onkeypress=m.onpaste=sb(4);b.onclose=function(){window.onbeforeunload=function(){};r.parentElement.removeChild(r);xa.parentElement.removeChild(xa);Za.parentElement.removeChild(Za);l.innerHTML="Disconnected";aa.innerHTML="";m.style.display="none";db()};window.onkeydown=function(t){if("Enter"==t.code){k.setItem("name",m.value);l.innerHTML="Spawning...";aa.innerHTML="";m.style.display="none";t=(t=k.getItem("token"))?t.split(",").map(n=>+n):[];let q=(new TextEncoder).encode(m.value);b.send(new Uint8Array([...q,...t]));tb(b)}}}function tb(b){function e({data:a}){A.set(new Uint8Array(a));la=a.byteLength;a=A[0]|A[1]<<8|A[2]<<16|A[3]<<24;if(0!=Da&&4!=a-Da)throw b.onmessage=function(){},Error(`tick - last_tick = ${a-Da}`);Da=a;a=4;K[0]=K[1];K[1]=performance.now();rb();if(a!=la){if(0==A[a]){++a;sa=1;E=[];ma=A[a++];Na=A[a]|A[a+1]<<8;a+=2;Oa=A[a]|A[a+1]<<8;a+=2;Pa=A[a]|A[a+1]<<8;a+=2;P=A[a++];Qa=Oa*P;Ra=Pa*P;Sa=Array(256);Ta=Array(256);for(var g=0;g<Oa;++g)for(var c=0;c<Pa;++c)null==Sa[A[a]]&&(Sa[A[a]]=new Path2D,Ta[A[a]]=new Path2D),Sa[A[a]].rect((1.5+g*P)*R.fov.max,(1.5+c*P)*R.fov.max,(P-3)*R.fov.max,(P-3)*R.fov.max),Ta[A[a]].rect(g*P*R.fov.max,c*P*R.fov.max,P*R.fov.max,P*R.fov.max),++a;w.width=P*Oa*R.fov.max;w.height=P*Pa*R.fov.max;ca.width=P*Oa*R.fov.max;ca.height=P*Pa*R.fov.max;for(g=0;256>g;++g)Sa[g]&&(ba.fillStyle=fa[g]+"b0",ba.fill(Ta[g]),ba.fillStyle=fa[g],ba.fill(Sa[g]),da.fillStyle=fa[g],da.fill(Ta[g]));ea||(requestAnimationFrame(nb),ea=1)}if(a!=la){if(1==A[a])for(++a,g=A[a++],c=0;c<g;++c){var h=A[a++];if(D[h]){var p=A[a++];if(p)for(;p;){switch(p){case 1:D[h].g.x2=C.getFloat32(a,!0);a+=4;ma==h&&(oa=D[h].g.x2);break;case 2:D[h].g.y2=C.getFloat32(a,!0);a+=4;ma==h&&(qa=D[h].g.y2);break;case 3:D[h].g.r2=C.getFloat32(a,!0);a+=4;break;case 4:D[h].j=A[a++];D[h].j&&(D[h].l=A[a++]);break;case 5:p=A[a++],pb(D[h].name,(new TextDecoder).decode(A.subarray(a,a+p))),a+=p}p=A[a++]}else D[h]=void 0}else{p=C.getFloat32(a,!0);a+=4;var B=C.getFloat32(a,!0);a+=4;var u=C.getFloat32(a,!0);a+=4;var ta=A[a++],ua=(new TextDecoder).decode(A.subarray(a,a+ta));a+=ta;ta=A[a++];let ob=0;ta&&(ob=A[a++]);let Xa=A[a++];0<Xa&&(pb(ua,(new TextDecoder).decode(A.subarray(a,a+Xa))),a+=Xa);D[h]={x:0,y:0,r:0,g:{x1:p,x2:p,y1:B,y2:B,r1:u,r2:u},name:ua,j:ta,l:ob};ma==h&&(oa=p,qa=B)}}if(a!=la){if(2==A[a])for(++a,g=A[a]|A[a+1]<<8,a+=2,c=0;c<g;++c)if(h=A[a]|A[a+1]<<8,a+=2,E[h])if(p=A[a++])for(;p;){switch(p){case 1:E[h].g.x2=C.getFloat32(a,!0);a+=4;break;case 2:E[h].g.y2=C.getFloat32(a,!0);a+=4;break;case 3:E[h].g.r2=C.getFloat32(a,!0);if(1>E[h].g.r2||60<E[h].g.r2)throw console.log(`update ball id ${h} r ${E[h].g.r2}`),b.onmessage=function(){},Error();a+=4}p=A[a++]}else E[h]=void 0;else if(p=A[a++],0!=p&&(--p,B=C.getFloat32(a,!0),a+=4,u=C.getFloat32(a,!0),a+=4,ua=C.getFloat32(a,!0),a+=4,E[h]={type:p,x:0,y:0,r:0,g:{x1:B,x2:B,y1:u,y2:u,r1:ua,r2:ua}},1>E[h].g.r2||60<E[h].g.r2))throw console.log(`create ball id ${h} r ${E[h].g.r2}`),b.onmessage=function(){},Error();if(a!=la&&3==A[a])for(++a,g=A[a++],c=0;c<g;++c)p=A[a++],h=(new TextDecoder).decode(A.subarray(a,a+p)),a+=p,p=A[a++],pb(h,(new TextDecoder).decode(A.subarray(a,a+p))),a+=p}}}}function t(){if(window.innerWidth!=ia||window.innerHeight!=ja||z!=window.devicePixelRatio)z=window.devicePixelRatio,ia=window.innerWidth,r.width=ia*z,ja=window.innerHeight,r.height=ja*z}function q(a,g,c){return a+(g-a)*c}function n(a){return"#"+(.8*parseInt(a.substring(1,3),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(3,5),16)>>0).toString(16).padStart(2,"0")+(.8*parseInt(a.substring(5,7),16)>>0).toString(16).padStart(2,"0")+a.substring(7)}function G(){Ma||(0==Ja-Ga&&0==Ia-Ha?O=La=0:(La=Math.atan2(Ja-Ga,Ia-Ha),O=160*z));L||M?b.send(new Uint8Array([0,0,0,0,0,0])):(A[0]=0,C.setFloat32(1,La,!0),O>=160*z?C.setUint8(5,255*Ka>>>0):C.setUint8(5,1.59375*O/z*Ka>>>0),b.send(A.subarray(0,6)))}function nb(a){if(0!=K[0]){R.chat_on==!ab&&(ab=R.chat_on,Za.style.display=ab?"block":"none");J?J<K[0]?J=K[0]:J>K[1]&&(J=K[1]):J=K[0];var g=S;S=q(S,T,.1);S!=g&&(O=Math.hypot(I[0]-.5*r.width,I[1]-.5*r.height)/S,G());g=K[0]==K[1]?0:(J-K[0])/(K[1]-K[0]);J+=a-ra;ra=a;M||(F=q(na,oa,g),H=q(pa,qa,g));v.resetTransform();v.fillStyle="#333";v.fillRect(0,0,r.width,r.height);v.translate(.5*r.width,.5*r.height);v.scale(S,S);v.translate(-F,-H);v.drawImage(w,0,0,w.width/R.fov.max,w.height/R.fov.max);1>S&&(v.globalAlpha=1-S*S,v.drawImage(ca,0,0,w.width/R.fov.max,w.height/R.fov.max),v.globalAlpha=1);if(M)switch(Ba){case 0:Z("<-- Your character",F+110,H);Z("Your character --\x3e",F-110,H);Z("This is your character. You can control it with these keys:",F,H-220);Z(`${N.up}: up`,F,H-170);Z(`${N.left}: left`,F,H-130);Z(`${N.right}: right`,F,H-90);Z(`${N.down}: down`,F,H-50);Z("You can also control it with mouse. Just",F,H+50);Z("press any mouse button to start or stop moving.",F,H+70);Z("Scroll to change your field of view.",F,H+110);Z("Note that you won't be able to perform some",F,H+150);Z("of the above actions until the tutorial ends.",F,H+170);Z("Press T to continue",F,H+220);break;case 1:var c=.5*Qa-6*P;a=.5*Ra;F=q(F,c,.2*g);H=q(H,a,.2*g);Z("--\x3e",c+2*P,a-P);Z("--\x3e",c+2*P,a);Z("--\x3e",c+2*P,a+P);Z("<--",c-2*P,a-2*P);Z("<--",c-3*P,a-P);Z("<--",c-4*P,a);Z("<--",c-3*P,a+P);Z("<--",c-2*P,a+2*P);Z("These are safezones. Enemies can't",c,a-130);Z("reach you inside of these tiles.",c,a-110);Z("Press T to continue",c,a+110);break;case 2:c=.5*Qa+6*P;a=.5*Ra;F=q(F,c,.2*g);H=q(H,a,.2*g);Z("<--",c-2*P,a-2*P);Z("<--",c-P,a-3*P);Z("<--",c,a-4*P);Z("<--",c-2*P,a+2*P);Z("<--",c-P,a+3*P);Z("<--",c,a+4*P);Z("--\x3e",c+2*P,a-3*P);Z("--\x3e",c+2*P,a+3*P);Z("<--",c+5*P,a-2*P);Z("<--",c+6*P,a-P);Z("<--",c+7*P,a);Z("<--",c+6*P,a+P);Z("<--",c+5*P,a+2*P);Z("These are walls. Players can't walk over them.",c,a-40);Z("However, some types (colors) of enemies can.",c,a-10);Z("Press T to continue",c,a+40);break;case 3:c=.5*P;a=.5*Ra;F=q(F,c,.2*g);H=q(H,a,.2*g);Z("--\x3e",c,a);Z("This is a teleport tile. If you walk on it, it will teleport you",c,a-90);Z("to an area it points to. Using the number on the tile, you can",c,a-70);Z("look at the minimap in the top left corner to see where that area is.",c,a-50);Z("Press T to continue",c,a+50);break;case 4:for(const B of E)if(B){c=B;break}a=c.x;c=c.y;F=q(F,a,.2*g);H=q(H,c,.2*g);Z("This is an enemy, also called simply a ball. A grey ball",a,c-110);Z("doesn't do a lot - it simply moves in one direction. However,",a,c-90);Z("as you are about to find out when you start exploring the game,",a,c-70);Z("there are lots of types of enemies, each having their own color.",a,c-50);Z("Coming in contact with an enemy downs you. While downed, you can't move,",a,c+50);Z("and after a while, you die, unless other players revive you by touching you.",a,c+70);Z("Press T to continue",a,c+120);break;case 5:c=oa;a=qa;F=q(F,c,.2*g);H=q(H,a,.2*g);Z(`You can press ${N.settings} to open settings. There`,c,a-80);Z("are a lot of cool options there to change. Try it out later.",c,a-60);Z("That's it for this tutorial. See how far you can go!",c,a+60);Z("GLHF!",c,a+80);Z("Press T to end the tutorial",c,a+130);break;case 6:T=Ca,M=0,k.setItem("tutorial","1"),Aa=1}else 0!=Na||Aa||Z("Need help? Press T for a tutorial.",.5*Qa,2.5*P);c=[];if(R.draw_player_fill||R.draw_player_stroke)for(var h of D)h&&(h.x=q(h.g.x1,h.g.x2,g),h.y=q(h.g.y1,h.g.y2,g),h.r=q(h.g.r1,h.g.r2,g),c[c.length]={u:h});if(R.draw_ball_fill||R.draw_ball_stroke)for(var p of E)p&&(p.x=q(p.g.x1,p.g.x2,g),p.y=q(p.g.y1,p.g.y2,g),p.r=q(p.g.r1,p.g.r2,g),c[c.length]={o:p});c.sort((B,u)=>B.r-u.r);for(let {o:B,u}of c)if(v.beginPath(),u){if(h=R.player_stroke.value/200*u.r,v.moveTo(u.x+u.r-h,u.y),v.arc(u.x,u.y,u.r-h,0,2*Math.PI),R.draw_player_fill&&(v.fillStyle="#ebecf0",v.fill()),R.draw_player_stroke&&(!R.draw_player_fill&&R.draw_player_stroke_bright?v.strokeStyle="#ebecf0":v.strokeStyle=n("#ebecf0"),v.lineWidth=2*h,v.stroke()),R.draw_player_name&&0!=u.name.length&&(v.font=`700 ${u.r/S}px Ubuntu`,v.textAlign="center",v.textBaseline="middle",v.fillStyle="#00000080",wa=1<S?.5*u.r:.5*u.r+2/(S*S),va=q(va,wa,.1),v.fillText(u.name,u.x,u.y-u.r-va)),u.j&&(v.font=`700 ${u.r/Math.min(S,1)}px Ubuntu`,v.textAlign="center",v.textBaseline="middle",v.fillStyle="#f00",v.fillText(u.l,u.x,u.y),R.draw_death_arrow&&(g=.5*r.width+(u.x-F)*S,c=.5*r.height+(u.y-H)*S,a=.75*x.width*S,0>g||g>r.width||0>c||c>r.height)))p=Math.max(Math.min(g,r.width-a),a),h=Math.max(Math.min(c,r.height-a),a),g=(g<a||g>r.width-a)&&(c<a||c>r.height-a)?Math.atan2(c-h,g-p):Math.atan2(c<a?-1:c>r.height-a?1:0,g<a?-1:g>r.width-a?1:0),p=(p-.5*r.width)/S+F,h=(h-.5*r.height)/S+H,v.translate(p,h),v.rotate(g),v.drawImage(x,.5*-x.width,.5*-x.width),v.rotate(-g),v.font=`700 ${.3*x.width}px Ubuntu`,v.textAlign="center",v.textBaseline="middle",v.fillStyle="#f00",v.fillText(u.l,0,0),v.translate(-p,-h)}else h=R.ball_stroke.value/200*B.r,v.moveTo(B.x+B.r-h,B.y),v.arc(B.x,B.y,B.r-h,0,2*Math.PI),R.draw_ball_fill&&(v.fillStyle=ha[B.type],v.fill()),R.draw_ball_stroke&&(v.strokeStyle=!R.draw_ball_fill&&R.draw_ball_stroke_bright?ha[B.type]:n(ha[B.type]),v.lineWidth=2*h,v.stroke())}requestAnimationFrame(nb)}ab=!R.chat_on;let Da=0;b.onmessage=function(a){sa=0;e(a);sa&&(l.innerHTML="",rb())};U.onkeydown=function(a){a.stopPropagation();if("Enter"==a.code){a=(new TextEncoder).encode(U.value.trim());if(0<a.length){A[0]=1;A[1]=a.length;A.set(a,2);b.send(A.subarray(0,A[1]+2));za.pop();za.unshift((new Date).getTime());a=Math.abs(za[za.length-1]-za[0]);const g=1E3*za.length;if(a<g){const c=U.placeholder;U.placeholder="You are on cooldown for sending too many messages too fast";U.m=1;U.onkeypress=U.onpaste=null;setTimeout(function(){U.onkeypress=U.onpaste=sb(128);U.m=0;U.placeholder=c},g-a)}}U.value="";U.blur();r.focus()}};U.onkeyup=function(a){a.stopPropagation()};U.onkeypress=U.onpaste=sb(128);t();window.onresize=t;r.onwheel=function(a){a=.05*-Math.sign(a.deltaY);T=1<T?T+3*a:T+a;T=Math.min(Math.max(T,R.fov.min),R.fov.max)};window.onmousemove=function(a){I=[a.clientX*z,a.clientY*z];La=Math.atan2(I[1]-.5*r.height,I[0]-.5*r.width);O=Math.hypot(I[0]-.5*r.width,I[1]-.5*r.height)/S;G()};r.onmousedown=function(){M||(Ma=!Ma);La=Math.atan2(I[1]-.5*r.height,I[0]-.5*r.width);O=Math.hypot(I[0]-.5*r.width,I[1]-.5*r.height)/S;G()};window.onkeydown=function(a){if(!a.repeat)if(L)Va?(a.preventDefault(),Wa=a.code,Ya()):a.code==N.settings&&(L=!1,xa.style.display="none");else switch(a.code){case "Enter":U.m||U.focus();a.preventDefault();break;case N.slowwalk:1==Ka&&(Ka=.5,G());break;case N.up:Ga||(Ga=1,G());break;case N.left:Ha||(Ha=1,G());break;case N.right:Ia||(Ia=1,G());break;case N.down:Ja||(Ja=1,G());break;case N.settings:M||(L=!L,xa.style.display=L?"block":"none");break;case "KeyT":M?++Ba:0==Na&&(M=1,Ba=0,Ca=T,T=R.fov.max)}};window.onkeyup=function(a){if(!a.repeat&&!L)switch(a.code){case N.slowwalk:.5==Ka&&(Ka=1,G());break;case N.up:Ga&&(Ga=0,G());break;case N.left:Ha&&(Ha=0,G());break;case N.right:Ia&&(Ia=0,G());break;case N.down:Ja&&(Ja=0,G())}};window.onbeforeunload=function(a){a.preventDefault();a.returnValue="Are you sure you want to quit?";k.setItem("settings",JSON.stringify(R));return"Are you sure you want to quit?"};r.oncontextmenu=function(a){a.preventDefault();return!1}};