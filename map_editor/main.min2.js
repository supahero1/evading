const aa=document.getElementById.bind(document),b=document.createElement.bind(document),e=aa("canvas"),g=e.getContext("2d"),h=b("canvas"),k=h.getContext("2d"),l=b("canvas"),m=l.getContext("2d"),n=aa("tiles");n.a=n.appendChild.bind(n);const p=["#dddddd","#aaaaaa","#333333","#fedf78"],ba=["Path","Safezone","Wall","Teleport"];let q=0,r=[];function ca(){for(let a=0;a<r.length;++a)r[a].style["text-decoration"]=a==q?"underline":"none"}let da=0,t=0,u=new Uint8Array(0),w=9,x=9;function y(){let a=new Uint8Array(w*x);for(var c=0;c<da;++c)if(!(c>=w))for(let d=0;d<t;++d)d>=x||(a[c*x+d]=u[c*t+d]);for(c=0;c<z.length;++c)if(z[c][0]>=w||z[c][1]>=x)delete A[`${z[c][0]},${z[c][1]}`],z.splice(c--,1);da=w;t=x;u=a;ea()}let B=0,C=0,D=0,E=.2,F=1;const G=20*x;let H=0,I=G,J=[0,0],K=0,fa=0;var L=0,N=0,O=0,P=0;let Q=[0,0],R;var S=[],T=[];let U=0,A={},V=!0,z=[],ha=0;function ia(){}function ja(){}function W(){if(U){var a=R/x|0,c=R%x,d=`${a},${c}`;K&&void 0==A[d]?(A[d]=[a,c],X("S",20+40*A[d][0],20+40*A[d][1],0,!1,!1),z[z.length]=A[d]):fa&&void 0!=A[d]&&(delete A[d],ka(),z=Object.values(A))}}function la(){if(window.innerWidth!=B||window.innerHeight!=C||D!=window.devicePixelRatio)V=!0,D=window.devicePixelRatio,B=window.innerWidth,e.width=B*D,C=window.innerHeight,e.height=C*D}la();window.onresize=la;function Y(a,c,d){return a+(c-a)*d}e.onwheel=function(a){a=.05*-Math.sign(a.deltaY);F=1<F?F+3*a:F+a;F=Math.min(Math.max(F,.2),2)};window.onmousemove=function(a){J=[a.clientX*D,a.clientY*D];{const {g:c,h:d}={g:(J[0]-.5*e.width)/E+H,h:(J[1]-.5*e.height)/E+I},f=Math.floor(c/40);0>f||f>=w?R=-1:(a=Math.floor(d/40),R=0>a||a>=x?-1:f*x+a)}-1!=R&&(K&&!U&&u[R]!=q&&(u[R]=q,ka()),W())};e.onmousedown=function(a){0==a.button?(K=1,-1!=R&&(U||u[R]==q||(u[R]=q,ka()),W())):2==a.button&&(fa=1,W())};e.onmouseup=function(a){0==a.button?K=0:2==a.button&&(fa=0)};window.onkeydown=function(a){if(!a.repeat)switch(a.keyCode){case 81:U=1;-1!=R&&W();break;case 69:V=ha=1;break;case 38:case 87:O=1;break;case 40:case 83:P=1;break;case 37:case 65:L=1;break;case 39:case 68:N=1}};window.onkeyup=function(a){if(!a.repeat)switch(a.keyCode){case 81:U=0;break;case 38:case 87:O=0;break;case 40:case 83:P=0;break;case 37:case 65:L=0;break;case 39:case 68:N=0}};window.onbeforeunload=function(a){a.preventDefault();return a.returnValue="Are you sure you want to quit?"};e.oncontextmenu=function(a){a.preventDefault();return!1};function ma(){var a=0!=z.length?" ":"";a=`#include "../consts.h"\n\nstatic struct tile_info t;\n\nstruct area_info area_000 = {\n  &t,\n  (struct ball_info[]){\n    {0}\n  },\n  (struct pos[]){${a}${z.map(f=>`{ ${f.join(", ")} }`).join(", ")}${a}}, ${z.length}\n};\n\nstruct tile_info name = { ${w}, ${x}, 40, (uint8_t[]){\n`;let c="/*       ";for(var d=0;d<x;++d)c+=d.toString().padStart(3," ")+" ";c+="*/\n";a+=c+"\n";for(d=0;d<w;++d){a+=`/*${d.toString().padStart(4," ")}*/  `;for(let f=0;f<x;++f)a+=` ${u[d*x+f]}, `;a=a.substring(0,a.length-1);a+="\n\n"}a=a.substring(0,a.length-1);return btoa(a+`\n${c}  }\n};\n`)}function na(a){try{a=atob(a);let c=a.match(/{ (\d+), (\d+) }/g);if(null==c)return 0;c=c.map(pa=>pa.match(/\d+/g).map(qa=>+qa));if(c.length!=a.match(/}, (\d+)\n};/)[1])return 0;const d=a.match(/{ (\d+), (\d+), 40, \(uint8_t\[\]\){/);if(null==d)return 0;const f=+d[1],v=+d[2];if(1>f||200<f||1>v||200<v)return 0;const M=eval(`[${a.substring(d.index+d[0].length,a.length-5)}]`);if(!(M instanceof Array)||M.length!=f*v)return 0;for(a=0;a<c.length;++a)if(c[a][0]>=f||c[a][1]>=v)return 0;w=f;x=v;ia();ja();A={};for(a=0;a<c.length;++a)A[c[a][0]*x+c[a][1]]=[c[a][0],c[a][1]];z=Object.values(A);u=new Uint8Array(f*v);u.set(M);ea();return 1}catch(c){return 0}}function ea(){S=Array(p.length);T=Array(p.length);var a=0;for(let c=0;c<w;++c)for(let d=0;d<x;++d)null==S[u[a]]&&(S[u[a]]=new Path2D,T[u[a]]=new Path2D),S[u[a]].rect(2*(1.5+40*c),2*(1.5+40*d),74,74),T[u[a]].rect(80*c,80*d,80,80),++a;h.width=80*w;h.height=80*x;l.width=80*w;l.height=80*x;for(a=0;256>a;++a)S[a]&&(k.fillStyle=p[a]+"b0",k.fill(T[a]),k.fillStyle=p[a],k.fill(S[a]),m.fillStyle=p[a],m.fill(T[a]));V=1}function ka(){var a=R;const c=a%x;a=(a-c)/x;k.clearRect(80*a,80*c,80,80);k.fillStyle=p[q]+"b0";k.fillRect(80*a,80*c,80,80);k.fillStyle=p[q];k.fillRect(2*(1.5+40*a),2*(1.5+40*c),74,74);m.fillStyle=p[q];m.fillRect(80*a,80*c,80,80);V=1}y();let Z=b("button");Z.innerHTML="Export & copy";Z.timeout=-1;Z.onclick=function(){const a=ma();window.navigator.clipboard.writeText(a);-1!=this.timeout&&clearTimeout(this.timeout);this.innerHTML="Exported & copied";this.timeout=setTimeout(function(){this.innerHTML="Export & copy";this.timeout=-1}.bind(this),500)}.bind(Z);n.a(Z);Z=b("button");Z.innerHTML="Import";Z.onclick=function(){let a=prompt("Please paste the config below:");a&&(a=a.trim(),0!=a.length&&(na(a)||alert("The config is invalid, it won't be loaded.")))};n.a(Z);Z=b("h4");Z.innerHTML="Width";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="range";Z.min=1;Z.max=200;Z.value=10;Z.step=1;ia=function(){this.value=w;this.nextElementSibling.innerHTML=w+" tiles";this.nextElementSibling.nextElementSibling.value=w}.bind(Z);Z.oninput=function(){w=this.valueAsNumber||1;ia();y()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML=w+" tiles";Z.style["margin-top"]="2px";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="number";Z.style["margin-top"]="2px";Z.value=w;Z.min=1;Z.max=200;Z.oninput=function(){this.valueAsNumber=w=this.valueAsNumber?Math.max(Math.min(this.valueAsNumber,this.max),this.min):1;this.previousElementSibling.innerHTML=w+" tiles";this.previousElementSibling.previousElementSibling.value=w;y()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML="Height";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="range";Z.min=1;Z.max=200;Z.value=10;Z.step=1;ja=function(){this.value=x;this.nextElementSibling.innerHTML=x+" tiles";this.nextElementSibling.nextElementSibling.value=x}.bind(Z);Z.oninput=function(){x=this.valueAsNumber||1;ja();y()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML=x+" tiles";Z.style["margin-top"]="2px";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="number";Z.style["margin-top"]="2px";Z.value=x;Z.min=1;Z.max=200;Z.oninput=function(){this.valueAsNumber=x=this.valueAsNumber?Math.max(Math.min(this.valueAsNumber,this.max),this.min):1;this.previousElementSibling.innerHTML=x+" tiles";this.previousElementSibling.previousElementSibling.value=x;y()}.bind(Z);n.a(Z);for(let a=0;a<p.length;++a){const c=b("div");Z=b("h4");Z.innerHTML=ba[a];c.appendChild(Z);r[r.length]=Z;Z=b("div");Z.className="tile";Z.style["background-color"]=p[a];Z.onclick=function(){q=a;ca()};c.appendChild(Z);n.a(c)}ca();function X(a,c,d,f,v,M){f*=E;c=.5*e.width+(c-H)*E;d=.5*e.height+(d-I)*E;v=((v&&(c<f||c>e.width-f)?Math.max(Math.min(c,e.width-f),f):c)-.5*e.width)/E+H;f=((M&&(d<f||d>e.height-f)?Math.max(Math.min(d,e.height-f),f):d)-.5*e.height)/E+I;g.translate(v,f);g.font="700 20px Ubuntu";g.textAlign="center";g.textBaseline="middle";g.fillStyle="#fff";g.strokeStyle="#333";g.lineWidth=1;g.fillText(a,0,0);g.strokeText(a,0,0);g.translate(-v,-f)}function oa(){var a=E;E=Y(E,F,.075);let c=H,d=I;if(0==P-O&&0==N-L)Q=[Y(Q[0],0,.1),Y(Q[1],0,.1)];else{const f=Math.atan2(P-O,N-L);Q=[Y(Q[0],10*Math.cos(f)/E,.1),Y(Q[1],10*Math.sin(f)/E,.1)]}H+=Q[0];I+=Q[1];if(V||a!=E||c!=H||d!=I){V=!1;g.resetTransform();g.clearRect(0,0,e.width,e.height);g.translate(.5*e.width,.5*e.height);g.scale(E,E);g.translate(-H,-I);g.drawImage(h,0,0,h.width/2,h.height/2);1>E&&(g.globalAlpha=1-E*E,g.drawImage(l,0,0,h.width/2,h.height/2),g.globalAlpha=1);ha||(X("WASD or arrow keys to move around, scroll to zoom",-500,G-80,0,!1,!1),X("Click on the left to pick what type of tile you want to place",-500,G-40,0,!1,!1),X("Set spawnpoints by clicking LMB and pressing Q at the same time",-500,G,0,!1,!1),X("Unset spawnpoints by clicking RMB and pressing Q at the same time",-500,G+40,0,!1,!1),X("Press E to hide this message",-500,G+80,0,!1,!1));for(const f of z)X("S",20+40*f[0],20+40*f[1],0,!1,!1);for(a=0;a<w;++a)X(a.toString(),20+40*a,-40,20,!1,!0);w&1?X("M",20+40*(w-1>>1),-20,40,!1,!0):(X("M",20+40*(w>>1),-20,40,!1,!0),X("M",20+40*((w>>1)-1),-20,40,!1,!0));for(a=0;a<x;++a)X(a.toString(),42*w+20,20+40*a,20,!0,!1);x&1?X("M",40*w+20,20+40*(x-1>>1),40,!0,!1):(X("M",40*w+20,20+40*(x>>1),40,!0,!1),X("M",40*w+20,20+40*((x>>1)-1),40,!0,!1))}requestAnimationFrame(oa)}oa();