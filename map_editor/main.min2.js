const b=document.getElementById.bind(document),d=document.createElement.bind(document),f=b("canvas"),g=f.getContext("2d"),h=d("canvas"),k=h.getContext("2d"),l=d("canvas"),n=l.getContext("2d"),p=b("tiles");p.a=p.appendChild.bind(p);const q=["#dddddd","#aaaaaa","#333333","#fedf78"],r=["Path","Safezone","Wall","Teleport"];let t=0,u=[];function v(){for(let a=0;a<u.length;++a)u[a].style["text-decoration"]=a==t?"underline":"none"}let w=new Uint8Array(0),x=10,y=10;function z(){w=new Uint8Array(x*y);A()}let B=0,C=0,D=0,E=.2,G=1,H=0,I=0,J=[0,0],K=0;var L=0,M=0,N=0,O=0;let P=[0,0];var Q=[],R=[];let S=!0;function T(){if(window.innerWidth!=B||window.innerHeight!=C||D!=window.devicePixelRatio)S=!0,D=window.devicePixelRatio,B=window.innerWidth,f.width=B*D,C=window.innerHeight,f.height=C*D}T();window.onresize=T;function U(a,c,e){return a+(c-a)*e}f.onwheel=function(a){a=.05*-Math.sign(a.deltaY);G=1<G?G+3*a:G+a;G=Math.min(Math.max(G,.2),2)};window.onmousemove=function(a){J=[a.clientX*D,a.clientY*D]};f.onmousedown=function(){K=1};f.onmouseup=function(){K=0};window.onkeydown=function(a){if(!a.repeat)switch(a.keyCode){case 38:case 87:N=1;break;case 40:case 83:O=1;break;case 37:case 65:L=1;break;case 39:case 68:M=1}};window.onkeyup=function(a){if(!a.repeat)switch(a.keyCode){case 38:case 87:N=0;break;case 40:case 83:O=0;break;case 37:case 65:L=0;break;case 39:case 68:M=0}};window.onbeforeunload=function(a){a.preventDefault();return a.returnValue="Are you sure you want to quit?"};f.oncontextmenu=function(a){a.preventDefault();return!1};function V(){let a=`struct tile_info name = { ${x}, ${y}, 40, (uint8_t[]){\n`,c="/*       ";for(var e=0;e<y;++e)c+=e.toString().padStart(3," ")+" ";c+="*/\n";a+=c+"\n";for(e=0;e<x;++e){a+=`/*${e.toString().padStart(4," ")}*/  `;for(let m=0;m<y;++m)a+=` ${w[e*y+m]}, `;a=a.substring(0,a.length-1);a+="\n\n"}a=a.substring(0,a.length-1);return btoa(a+`\n${c}  }\n};`)}function W(a){try{a=atob(a.trim());const c=a.match(/struct tile_info \w.*? = { (\d+), (\d+), 40, \(uint8_t\[\]\){/),e=+c[1],m=+c[2];if(null==c)return 0;const F=eval(a.replace(c[0],"[").replace("}\n};","]"));if(!F.length||F.length!=e*m)return 0;w.set(F);x=e;y=m;A();S=!0;return 1}catch(c){return 0}}function A(){Q=Array(q.length);R=Array(q.length);var a=0;for(let c=0;c<x;++c)for(let e=0;e<y;++e)null==Q[w[a]]&&(Q[w[a]]=new Path2D,R[w[a]]=new Path2D),Q[w[a]].rect(2*(1.5+50*c),2*(1.5+50*e),94,94),R[w[a]].rect(100*c,100*e,100,100),++a;h.width=100*x;h.height=100*y;l.width=100*x;l.height=100*y;for(a=0;256>a;++a)Q[a]&&(k.fillStyle=q[a]+"b0",k.fill(R[a]),k.fillStyle=q[a],k.fill(Q[a]),n.fillStyle=q[a],n.fill(R[a]))}z();let X=d("button");X.innerHTML="Export & copy";X.timeout=-1;X.onclick=function(){window.navigator.clipboard.writeText(V());if(-1==this.timeout){const a=this.innerHTML;this.innerHTML="Exported & copied";this.timeout=setTimeout(function(){this.innerHTML=a;this.timeout=-1}.bind(this),500)}}.bind(X);p.a(X);X=d("button");X.innerHTML="Import";X.onclick=function(){let a=prompt("Please paste the config below:");W(a)||alert("The config is invalid, it won't be loaded.")};p.a(X);X=d("h4");X.innerHTML="Width";X.style["margin-bottom"]="2px";p.a(X);X=d("input");X.type="range";X.min=1;X.max=128;X.value=10;X.step=1;X.oninput=function(){x=this.valueAsNumber||1;this.nextElementSibling.innerHTML=x+" tiles";this.nextElementSibling.nextElementSibling.value=x;z()}.bind(X);p.a(X);X=d("h4");X.innerHTML=x+" tiles";X.style["margin-top"]="2px";X.style["margin-bottom"]="2px";p.a(X);X=d("input");X.type="number";X.style["margin-top"]="2px";X.value=x;X.min=1;X.max=128;X.oninput=function(){x=this.valueAsNumber||1;this.previousElementSibling.innerHTML=x+" tiles";this.previousElementSibling.previousElementSibling.value=x;z()}.bind(X);p.a(X);X=d("h4");X.innerHTML="Height";X.style["margin-bottom"]="2px";p.a(X);X=d("input");X.type="range";X.min=1;X.max=128;X.value=10;X.step=1;X.oninput=function(){y=this.valueAsNumber||1;this.nextElementSibling.innerHTML=y+" tiles";this.nextElementSibling.nextElementSibling.value=y;z()}.bind(X);p.a(X);X=d("h4");X.innerHTML=y+" tiles";X.style["margin-top"]="2px";X.style["margin-bottom"]="2px";p.a(X);X=d("input");X.type="number";X.style["margin-top"]="2px";X.value=y;X.min=1;X.max=128;X.oninput=function(){y=this.valueAsNumber||1;this.previousElementSibling.innerHTML=y+" tiles";this.previousElementSibling.previousElementSibling.value=y;z()}.bind(X);p.a(X);for(let a=0;a<q.length;++a){const c=d("div");X=d("h4");X.innerHTML=r[a];c.appendChild(X);u[u.length]=X;X=d("div");X.className="tile";X.style["background-color"]=q[a];X.onclick=function(){t=a;v()};c.appendChild(X);p.a(c)}v();function Y(){var a=E;E=U(E,G,.075);var c=H;let e=I;if(0==O-N&&0==M-L)P=[U(P[0],0,.1),U(P[1],0,.1)];else{const m=Math.atan2(O-N,M-L);P=[U(P[0],10*Math.cos(m)/E,.1),U(P[1],10*Math.sin(m)/E,.1)]}H+=P[0];I+=P[1];if(S||a!=E||c!=H||e!=I)S=!1,g.resetTransform(),g.clearRect(0,0,f.width,f.height),g.translate(.5*f.width,.5*f.height),g.scale(E,E),g.translate(-H,-I),g.drawImage(h,0,0,h.width/2,h.height/2),1>E&&(g.globalAlpha=1-E*E,g.drawImage(l,0,0,h.width/2,h.height/2),g.globalAlpha=1);if(K){{const {g:m,h:F}={g:(J[0]-.5*window.innerWidth)/E+H,h:(J[1]-.5*window.innerHeight)/E+I};c=Math.floor(m/50);0>c||c>=x?a=-1:(a=Math.floor(F/50),a=0>a||a>=y?-1:c*y+a)}c=a;-1!=c&&w[c]!=t&&(w[c]=t,a=c%y,c=(c-a)/y,k.clearRect(100*c,100*a,100,100),k.fillStyle=q[t]+"b0",k.fillRect(100*c,100*a,100,100),k.fillStyle=q[t],k.fillRect(2*(1.5+50*c),2*(1.5+50*a),94,94),n.fillStyle=q[t],n.fillRect(100*c,100*a,100,100),S=1)}requestAnimationFrame(Y)}Y();