const aa=document.getElementById.bind(document),b=document.createElement.bind(document),f=aa("canvas"),g=f.getContext("2d"),h=b("canvas"),k=h.getContext("2d"),l=b("canvas"),m=l.getContext("2d"),n=aa("tiles");n.a=n.appendChild.bind(n);const p=["#dddddd","#aaaaaa","#333333","#fedf78"],ba=["Path","Safezone","Wall","Teleport"];let q=0,r=[];function ca(){for(let a=0;a<r.length;++a)r[a].style["text-decoration"]=a==q?"underline":"none"}let da=0,t=0,v=new Uint8Array(0),w=9,x=9;
function y(){let a=new Uint8Array(w*x);for(let c=0;c<da;++c)if(!(c>=w))for(let d=0;d<t;++d)d>=x||(a[c*x+d]=v[c*t+d]);da=w;t=x;v=a;ea()}let z=0,A=0,B=0,C=.2,D=1;const E=20*x;let F=0,G=E,H=[0,0],I=0,fa=0;var J=0,K=0,L=0,N=0;let O=[0,0],P;var Q=[],R=[];let S=0,T={},U=!0,V=[],ha=0;function ia(){}function ja(){}function W(){I&&void 0==T[P]?(T[P]=[P/x|0,P%x],X("S",20+40*T[P][0],20+40*T[P][1],0,!1,!1),V[V.length]=T[P]):fa&&void 0!=T[P]&&(delete T[P],ka(),V=Object.values(T))}
function la(){if(window.innerWidth!=z||window.innerHeight!=A||B!=window.devicePixelRatio)U=!0,B=window.devicePixelRatio,z=window.innerWidth,f.width=z*B,A=window.innerHeight,f.height=A*B}la();window.onresize=la;function Y(a,c,d){return a+(c-a)*d}f.onwheel=function(a){a=.05*-Math.sign(a.deltaY);D=1<D?D+3*a:D+a;D=Math.min(Math.max(D,.2),2)};
window.onmousemove=function(a){H=[a.clientX*B,a.clientY*B];{const {g:c,h:d}={g:(H[0]-.5*f.width)/C+F,h:(H[1]-.5*f.height)/C+G},e=Math.floor(c/40);0>e||e>=w?P=-1:(a=Math.floor(d/40),P=0>a||a>=x?-1:e*x+a)}-1!=P&&(I&&v[P]!=q&&(v[P]=q,ka()),S&&W())};f.onmousedown=function(a){0==a.button?(I=1,-1!=P&&(v[P]!=q&&(v[P]=q,ka()),S&&W())):2==a.button&&(fa=1,S&&W())};f.onmouseup=function(a){0==a.button?I=0:2==a.button&&(fa=0)};
window.onkeydown=function(a){if(!a.repeat)switch(a.keyCode){case 81:S=1;-1!=P&&W();break;case 82:U=ha=1;break;case 38:case 87:L=1;break;case 40:case 83:N=1;break;case 37:case 65:J=1;break;case 39:case 68:K=1}};window.onkeyup=function(a){if(!a.repeat)switch(a.keyCode){case 81:S=0;break;case 38:case 87:L=0;break;case 40:case 83:N=0;break;case 37:case 65:J=0;break;case 39:case 68:K=0}};window.onbeforeunload=function(a){a.preventDefault();return a.returnValue="Are you sure you want to quit?"};
f.oncontextmenu=function(a){a.preventDefault();return!1};function ma(){var a=0!=V.length?" ":"";a=`#include "../consts.h"\n
\n
static struct tile_info t;\n
\n
struct area_info area_000 = {\n
  &t,\n
  (struct ball_info[]){\n
    {0}\n
  },\n
  (struct pos[]){${a}${V.map(e=>`{ ${e.join(", ")} }`).join(", ")}${a}}, ${V.length}\n
};\n
\n
struct tile_info name = { ${w}, ${x}, 40, (uint8_t[]){\n`;let c="/*       ";for(var d=0;d<x;++d)c+=d.toString().padStart(3," ")+" ";c+="*/\n";a+=c+"\n";for(d=0;d<w;++d){a+=`/*${d.toString().padStart(4," ")}*/  `;for(let e=0;e<x;++e)a+=` ${v[d*x+e]}, `;a=a.substring(0,a.length-1);a+="\n\n"}a=a.substring(0,a.length-1);return btoa(a+`\n${c}  }\n};\n`)}
function na(a){try{a=atob(a);let c=a.match(/{ (\d+), (\d+) }/g);if(null==c)return 0;c=c.map(pa=>pa.match(/\d+/g).map(qa=>+qa));if(c.length!=a.match(/}, (\d+)\n};/)[1])return 0;const d=a.match(/{ (\d+), (\d+), 40, \(uint8_t\[\]\){/);if(null==d)return 0;const e=+d[1],u=+d[2];if(1>e||200<e||1>u||200<u)return 0;const M=eval(`[${a.substring(d.index+d[0].length,a.length-5)}]`);if(!(M instanceof Array)||M.length!=e*u)return 0;for(a=0;a<c.length;++a)if(c[a][0]>=e||c[a][1]>=u)return 0;w=e;x=u;ia();ja();T=
{};for(a=0;a<c.length;++a)T[c[a][0]*x+c[a][1]]=[c[a][0],c[a][1]];V=Object.values(T);v=new Uint8Array(e*u);v.set(M);ea();return 1}catch(c){return 0}}
function ea(){Q=Array(p.length);R=Array(p.length);var a=0;for(let c=0;c<w;++c)for(let d=0;d<x;++d)null==Q[v[a]]&&(Q[v[a]]=new Path2D,R[v[a]]=new Path2D),Q[v[a]].rect(2*(1.5+40*c),2*(1.5+40*d),74,74),R[v[a]].rect(80*c,80*d,80,80),++a;h.width=80*w;h.height=80*x;l.width=80*w;l.height=80*x;for(a=0;256>a;++a)Q[a]&&(k.fillStyle=p[a]+"b0",k.fill(R[a]),k.fillStyle=p[a],k.fill(Q[a]),m.fillStyle=p[a],m.fill(R[a]));U=1}
function ka(){var a=P;const c=a%x;a=(a-c)/x;k.clearRect(80*a,80*c,80,80);k.fillStyle=p[q]+"b0";k.fillRect(80*a,80*c,80,80);k.fillStyle=p[q];k.fillRect(2*(1.5+40*a),2*(1.5+40*c),74,74);m.fillStyle=p[q];m.fillRect(80*a,80*c,80,80);U=1}y();let Z=b("button");Z.innerHTML="Export & copy";Z.timeout=-1;
Z.onclick=function(){const a=ma();window.navigator.clipboard.writeText(a);-1!=this.timeout&&clearTimeout(this.timeout);this.innerHTML="Exported & copied";this.timeout=setTimeout(function(){this.innerHTML="Export & copy";this.timeout=-1}.bind(this),500)}.bind(Z);n.a(Z);Z=b("button");Z.innerHTML="Import";Z.onclick=function(){let a=prompt("Please paste the config below:");a&&(a=a.trim(),0!=a.length&&(na(a)||alert("The config is invalid, it won't be loaded.")))};n.a(Z);Z=b("h4");Z.innerHTML="Width";
Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="range";Z.min=1;Z.max=200;Z.value=10;Z.step=1;ia=function(){this.value=w;this.nextElementSibling.innerHTML=w+" tiles";this.nextElementSibling.nextElementSibling.value=w}.bind(Z);Z.oninput=function(){w=this.valueAsNumber||1;ia();y()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML=w+" tiles";Z.style["margin-top"]="2px";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="number";Z.style["margin-top"]="2px";Z.value=w;Z.min=1;Z.max=200;
Z.oninput=function(){this.valueAsNumber=w=this.valueAsNumber?Math.max(Math.min(this.valueAsNumber,this.max),this.min):1;this.previousElementSibling.innerHTML=w+" tiles";this.previousElementSibling.previousElementSibling.value=w;y()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML="Height";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="range";Z.min=1;Z.max=200;Z.value=10;Z.step=1;
ja=function(){this.value=x;this.nextElementSibling.innerHTML=x+" tiles";this.nextElementSibling.nextElementSibling.value=x}.bind(Z);Z.oninput=function(){x=this.valueAsNumber||1;ja();y()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML=x+" tiles";Z.style["margin-top"]="2px";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="number";Z.style["margin-top"]="2px";Z.value=x;Z.min=1;Z.max=200;
Z.oninput=function(){this.valueAsNumber=x=this.valueAsNumber?Math.max(Math.min(this.valueAsNumber,this.max),this.min):1;this.previousElementSibling.innerHTML=x+" tiles";this.previousElementSibling.previousElementSibling.value=x;y()}.bind(Z);n.a(Z);for(let a=0;a<p.length;++a){const c=b("div");Z=b("h4");Z.innerHTML=ba[a];c.appendChild(Z);r[r.length]=Z;Z=b("div");Z.className="tile";Z.style["background-color"]=p[a];Z.onclick=function(){q=a;ca()};c.appendChild(Z);n.a(c)}ca();
function X(a,c,d,e,u,M){e*=C;c=.5*f.width+(c-F)*C;d=.5*f.height+(d-G)*C;u=((u&&(c<e||c>f.width-e)?Math.max(Math.min(c,f.width-e),e):c)-.5*f.width)/C+F;e=((M&&(d<e||d>f.height-e)?Math.max(Math.min(d,f.height-e),e):d)-.5*f.height)/C+G;g.translate(u,e);g.font="700 20px Ubuntu";g.textAlign="center";g.textBaseline="middle";g.fillStyle="#fff";g.strokeStyle="#333";g.lineWidth=1;g.fillText(a,0,0);g.strokeText(a,0,0);g.translate(-u,-e)}
function oa(){var a=C;C=Y(C,D,.075);let c=F,d=G;if(0==N-L&&0==K-J)O=[Y(O[0],0,.1),Y(O[1],0,.1)];else{const e=Math.atan2(N-L,K-J);O=[Y(O[0],10*Math.cos(e)/C,.1),Y(O[1],10*Math.sin(e)/C,.1)]}F+=O[0];G+=O[1];if(U||a!=C||c!=F||d!=G){U=!1;g.resetTransform();g.clearRect(0,0,f.width,f.height);g.translate(.5*f.width,.5*f.height);g.scale(C,C);g.translate(-F,-G);g.drawImage(h,0,0,h.width/2,h.height/2);1>C&&(g.globalAlpha=1-C*C,g.drawImage(l,0,0,h.width/2,h.height/2),g.globalAlpha=1);ha||(X("WASD or arrow keys to move around, scroll to zoom",
-500,E-80,0,!1,!1),X("Click on the left to pick what type of tile you want to place",-500,E-40,0,!1,!1),X("Set spawnpoints by clicking LMB and pressing Q at the same time",-500,E,0,!1,!1),X("Unset spawnpoints by clicking RMB and pressing Q at the same time",-500,E+40,0,!1,!1),X("Press R to hide this message",-500,E+80,0,!1,!1));for(const e of V)X("S",20+40*e[0],20+40*e[1],0,!1,!1);for(a=0;a<w;++a)X(a.toString(),20+40*a,-40,20,!1,!0);w&1&&X("M",20+40*(w-1>>1),-20,40,!1,!0);for(a=0;a<x;++a)X(a.toString(),
42*w+20,20+40*a,20,!0,!1);x&1&&X("M",40*w+20,20+40*(x-1>>1),40,!0,!1)}requestAnimationFrame(oa)}oa();
