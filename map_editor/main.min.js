const aa=document.getElementById.bind(document),b=document.createElement.bind(document),e=aa("canvas"),g=e.getContext("2d"),h=b("canvas"),k=h.getContext("2d"),l=b("canvas"),m=l.getContext("2d"),n=aa("tiles");n.a=n.appendChild.bind(n);const p=["#dddddd","#aaaaaa","#333333","#fedf78"],ba=["Path","Safezone","Wall","Teleport"];let q=0,r=[];function ca(){for(let a=0;a<r.length;++a)r[a].style["text-decoration"]=a==q?"underline":"none"}let t=0,u=0,v=new Uint8Array(0),x=9,y=9;
function z(){let a=new Uint8Array(x*y);for(var c=0;c<t;++c)if(!(c>=x))for(let d=0;d<u;++d)d>=y||(a[c*y+d]=v[c*u+d]);for(c=0;c<A.length;++c)if(A[c][0]>=x||A[c][1]>=y)delete B[`${A[c][0]},${A[c][1]}`],A.splice(c--,1);t=x;u=y;v=a;da()}let C=0,ea=0,D=0,E=.2,F=1;const G=20*y;let H=0,I=G,fa=[0,0],J=0,ha=0;var K=0,L=0,M=0,N=0;let P=[0,0],Q;var R=[],S=[];let T=0,B={},U=!0,A=[],ia=0;function ja(){}function ka(){}
function V(){if(T){var a=Q/y|0,c=Q%y,d=`${a},${c}`;J&&void 0==B[d]?(B[d]=[a,c],W("S",20+40*B[d][0],20+40*B[d][1],0,!1,!1),A[A.length]=B[d]):ha&&void 0!=B[d]&&(delete B[d],a=q,q=v[Q],X(),q=a,A=Object.values(B))}}function la(){if(window.innerWidth!=C||window.innerHeight!=ea||D!=window.devicePixelRatio)U=!0,D=window.devicePixelRatio,C=window.innerWidth,e.width=C*D,ea=window.innerHeight,e.height=ea*D}la();window.onresize=la;function Y(a,c,d){return a+(c-a)*d}
e.onwheel=function(a){a=.05*-Math.sign(a.deltaY);F=1<F?F+3*a:F+a;F=Math.min(Math.max(F,.2),2)};window.onmousemove=function(a){fa=[a.clientX*D,a.clientY*D];Q=ma();-1!=Q&&(J&&!T&&v[Q]!=q&&(v[Q]=q,X()),V())};e.onmousedown=function(a){0==a.button?(J=1,-1!=Q&&(T||v[Q]==q||(v[Q]=q,X()),V())):2==a.button&&(ha=1,V())};e.onmouseup=function(a){0==a.button?J=0:2==a.button&&(ha=0)};
window.onkeydown=function(a){if(!a.repeat)switch(a.keyCode){case 81:T=1;-1!=Q&&V();break;case 69:U=ia=1;break;case 38:case 87:M=1;break;case 40:case 83:N=1;break;case 37:case 65:K=1;break;case 39:case 68:L=1}};window.onkeyup=function(a){if(!a.repeat)switch(a.keyCode){case 81:T=0;break;case 38:case 87:M=0;break;case 40:case 83:N=0;break;case 37:case 65:K=0;break;case 39:case 68:L=0}};window.onbeforeunload=function(a){a.preventDefault();return a.returnValue="Are you sure you want to quit?"};
e.oncontextmenu=function(a){a.preventDefault();return!1};function na(){var a=0!=A.length?" ":"";a=`#include "../consts.h"\n
\n
static struct tile_info t;\n
\n
struct area_info area_000 = {\n
  &t,\n
  (struct ball_info[]){\n
    {0}\n
  },\n
  (struct pos[]){${a}${A.map(f=>`{ ${f.join(", ")} }`).join(", ")}${a}}, ${A.length}\n
};\n
\n
static struct tile_info t = { ${x}, ${y}, 40, (uint8_t[]){\n`;let c="/*       ";for(var d=0;d<y;++d)c+=d.toString().padStart(3," ")+" ";c+="*/\n";a+=c+"\n";for(d=0;d<x;++d){a+=`/*${d.toString().padStart(4," ")}*/  `;for(let f=0;f<y;++f)a+=` ${v[d*y+f]}, `;a=a.substring(0,a.length-1);a+="\n\n"}a=a.substring(0,a.length-1);return btoa(a+`\n${c}  }\n};\n`)}
function oa(a){try{a=atob(a);let c=a.match(/{ (\d+), (\d+) }/g);if(null==c)return 0;c=c.map(qa=>qa.match(/\d+/g).map(ra=>+ra));if(c.length!=a.match(/}, (\d+)\n};/)[1])return 0;const d=a.match(/{ (\d+), (\d+), 40, \(uint8_t\[\]\){/);if(null==d)return 0;const f=+d[1],w=+d[2];if(1>f||200<f||1>w||200<w)return 0;const O=eval(`[${a.substring(d.index+d[0].length,a.length-5)}]`);if(!(O instanceof Array)||O.length!=f*w)return 0;for(a=0;a<c.length;++a)if(c[a][0]>=f||c[a][1]>=w)return 0;x=f;y=w;t=x;u=y;ja();
ka();B={};for(a=0;a<c.length;++a)B[`${c[a][0]},${c[a][1]}`]=[c[a][0],c[a][1]];A=Object.values(B);v=new Uint8Array(f*w);v.set(O);da();return 1}catch(c){return 0}}
function da(){R=Array(p.length);S=Array(p.length);var a=0;for(let c=0;c<x;++c)for(let d=0;d<y;++d)null==R[v[a]]&&(R[v[a]]=new Path2D,S[v[a]]=new Path2D),R[v[a]].rect(2*(1.5+40*c),2*(1.5+40*d),74,74),S[v[a]].rect(80*c,80*d,80,80),++a;h.width=80*x;h.height=80*y;l.width=80*x;l.height=80*y;for(a=0;256>a;++a)R[a]&&(k.fillStyle=p[a]+"b0",k.fill(S[a]),k.fillStyle=p[a],k.fill(R[a]),m.fillStyle=p[a],m.fill(S[a]));U=1}
function X(){var a=Q;const c=a%y;a=(a-c)/y;k.clearRect(80*a,80*c,80,80);k.fillStyle=p[q]+"b0";k.fillRect(80*a,80*c,80,80);k.fillStyle=p[q];k.fillRect(2*(1.5+40*a),2*(1.5+40*c),74,74);m.fillStyle=p[q];m.fillRect(80*a,80*c,80,80);U=1}function ma(){const {g:a,h:c}={g:(fa[0]-.5*e.width)/E+H,h:(fa[1]-.5*e.height)/E+I},d=Math.floor(a/40);if(0>d||d>=x)return-1;const f=Math.floor(c/40);return 0>f||f>=y?-1:d*y+f}z();let Z=b("button");Z.innerHTML="Export & copy";Z.timeout=-1;
Z.onclick=function(){const a=na();window.navigator.clipboard.writeText(a);-1!=this.timeout&&clearTimeout(this.timeout);this.innerHTML="Exported & copied";this.timeout=setTimeout(function(){this.innerHTML="Export & copy";this.timeout=-1}.bind(this),500)}.bind(Z);n.a(Z);Z=b("button");Z.innerHTML="Import";Z.onclick=function(){let a=prompt("Please paste the config below:");a&&(a=a.trim(),0!=a.length&&(oa(a)||alert("The config is invalid, it won't be loaded.")))};n.a(Z);Z=b("h4");Z.innerHTML="Width";
Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="range";Z.min=1;Z.max=200;Z.value=10;Z.step=1;ja=function(){this.value=x;this.nextElementSibling.innerHTML=x+" tiles";this.nextElementSibling.nextElementSibling.value=x}.bind(Z);Z.oninput=function(){x=this.valueAsNumber||1;ja();z()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML=x+" tiles";Z.style["margin-top"]="2px";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="number";Z.style["margin-top"]="2px";Z.value=x;Z.min=1;Z.max=200;
Z.oninput=function(){this.valueAsNumber=x=this.valueAsNumber?Math.max(Math.min(this.valueAsNumber,this.max),this.min):1;this.previousElementSibling.innerHTML=x+" tiles";this.previousElementSibling.previousElementSibling.value=x;z()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML="Height";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="range";Z.min=1;Z.max=200;Z.value=10;Z.step=1;
ka=function(){this.value=y;this.nextElementSibling.innerHTML=y+" tiles";this.nextElementSibling.nextElementSibling.value=y}.bind(Z);Z.oninput=function(){y=this.valueAsNumber||1;ka();z()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML=y+" tiles";Z.style["margin-top"]="2px";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="number";Z.style["margin-top"]="2px";Z.value=y;Z.min=1;Z.max=200;
Z.oninput=function(){this.valueAsNumber=y=this.valueAsNumber?Math.max(Math.min(this.valueAsNumber,this.max),this.min):1;this.previousElementSibling.innerHTML=y+" tiles";this.previousElementSibling.previousElementSibling.value=y;z()}.bind(Z);n.a(Z);for(let a=0;a<p.length;++a){const c=b("div");Z=b("h4");Z.innerHTML=ba[a];c.appendChild(Z);r[r.length]=Z;Z=b("div");Z.className="tile";Z.style["background-color"]=p[a];Z.onclick=function(){q=a;ca()};c.appendChild(Z);n.a(c)}ca();
function W(a,c,d,f,w,O){f*=E;c=.5*e.width+(c-H)*E;d=.5*e.height+(d-I)*E;w=((w&&(c<f||c>e.width-f)?Math.max(Math.min(c,e.width-f),f):c)-.5*e.width)/E+H;f=((O&&(d<f||d>e.height-f)?Math.max(Math.min(d,e.height-f),f):d)-.5*e.height)/E+I;g.translate(w,f);g.font="700 20px Ubuntu";g.textAlign="center";g.textBaseline="middle";g.fillStyle="#fff";g.strokeStyle="#333";g.lineWidth=1;g.fillText(a,0,0);g.strokeText(a,0,0);g.translate(-w,-f)}
function pa(){var a=E;E=Y(E,F,.075);let c=H,d=I;if(0==N-M&&0==L-K)P=[Y(P[0],0,.1),Y(P[1],0,.1)];else{const f=Math.atan2(N-M,L-K);P=[Y(P[0],10*Math.cos(f)/E,.1),Y(P[1],10*Math.sin(f)/E,.1)]}H+=P[0];I+=P[1];Q=ma();-1!=Q&&(J&&!T&&v[Q]!=q&&(v[Q]=q,X()),V());if(U||a!=E||c!=H||d!=I){U=!1;g.resetTransform();g.clearRect(0,0,e.width,e.height);g.translate(.5*e.width,.5*e.height);g.scale(E,E);g.translate(-H,-I);g.drawImage(h,0,0,h.width/2,h.height/2);1>E&&(g.globalAlpha=1-E*E,g.drawImage(l,0,0,h.width/2,h.height/
2),g.globalAlpha=1);ia||(W("WASD or arrow keys to move around, scroll to zoom",-500,G-80,0,!1,!1),W("Click on the left to pick what type of tile you want to place",-500,G-40,0,!1,!1),W("Set spawnpoints by clicking LMB and pressing Q at the same time",-500,G,0,!1,!1),W("Unset spawnpoints by clicking RMB and pressing Q at the same time",-500,G+40,0,!1,!1),W("Press E to hide this message",-500,G+80,0,!1,!1));for(const f of A)W("S",20+40*f[0],20+40*f[1],0,!1,!1);for(a=0;a<x;++a)W(a.toString(),20+40*a,
-40,20,!1,!0);x&1?W("M",20+40*(x-1>>1),-20,40,!1,!0):(W("M",20+40*(x>>1),-20,40,!1,!0),W("M",20+40*((x>>1)-1),-20,40,!1,!0));for(a=0;a<y;++a)W(a.toString(),40*x+40,20+40*a,20,!0,!1);y&1?W("M",40*x+20,20+40*(y-1>>1),40,!0,!1):(W("M",40*x+20,20+40*(y>>1),40,!0,!1),W("M",40*x+20,20+40*((y>>1)-1),40,!0,!1))}requestAnimationFrame(pa)}pa();
