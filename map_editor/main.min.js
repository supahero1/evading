const aa=document.getElementById.bind(document),b=document.createElement.bind(document),e=aa("canvas"),g=e.getContext("2d"),h=b("canvas"),k=h.getContext("2d"),l=b("canvas"),m=l.getContext("2d"),n=aa("tiles");n.a=n.appendChild.bind(n);const p=["#dddddd","#aaaaaa","#333333","#fedf78"],ba=["Path","Safezone","Wall","Teleport"];let q=0,r=[];function ca(){for(let a=0;a<r.length;++a)r[a].style["text-decoration"]=a==q?"underline":"none"}let t=0,u=0,w=new Uint8Array(0),x=9,y=9;
function z(){let a=new Uint8Array(x*y);for(var c=0;c<t;++c)if(!(c>=x))for(let d=0;d<u;++d)d>=y||(a[c*y+d]=w[c*u+d]);for(c=0;c<A.length;++c)if(A[c][0]>=x||A[c][1]>=y)delete B[`${A[c][0]},${A[c][1]}`],A.splice(c--,1);t=x;u=y;w=a;da()}let C=0,D=0,E=0,F=.2,G=1;const H=20*y;let I=0,J=H,ea=[0,0],K=0,fa=0;var L=0,N=0,O=0,P=0;let Q=[0,0],R;var S=[],T=[];let U=0,B={},V=!0,A=[],ha=0;function ia(){}function ja(){}
function W(){if(U){var a=R/y|0,c=R%y,d=`${a},${c}`;K&&void 0==B[d]?(B[d]=[a,c],X("S",20+40*B[d][0],20+40*B[d][1],0,!1,!1),A[A.length]=B[d]):fa&&void 0!=B[d]&&(delete B[d],ka(),A=Object.values(B))}}function la(){if(window.innerWidth!=C||window.innerHeight!=D||E!=window.devicePixelRatio)V=!0,E=window.devicePixelRatio,C=window.innerWidth,e.width=C*E,D=window.innerHeight,e.height=D*E}la();window.onresize=la;function Y(a,c,d){return a+(c-a)*d}
e.onwheel=function(a){a=.05*-Math.sign(a.deltaY);G=1<G?G+3*a:G+a;G=Math.min(Math.max(G,.2),2)};window.onmousemove=function(a){ea=[a.clientX*E,a.clientY*E];{const {g:c,h:d}={g:(ea[0]-.5*e.width)/F+I,h:(ea[1]-.5*e.height)/F+J},f=Math.floor(c/40);0>f||f>=x?R=-1:(a=Math.floor(d/40),R=0>a||a>=y?-1:f*y+a)}-1!=R&&(K&&!U&&w[R]!=q&&(w[R]=q,ka()),W())};e.onmousedown=function(a){0==a.button?(K=1,-1!=R&&(U||w[R]==q||(w[R]=q,ka()),W())):2==a.button&&(fa=1,W())};
e.onmouseup=function(a){0==a.button?K=0:2==a.button&&(fa=0)};window.onkeydown=function(a){if(!a.repeat)switch(a.keyCode){case 81:U=1;-1!=R&&W();break;case 69:V=ha=1;break;case 38:case 87:O=1;break;case 40:case 83:P=1;break;case 37:case 65:L=1;break;case 39:case 68:N=1}};window.onkeyup=function(a){if(!a.repeat)switch(a.keyCode){case 81:U=0;break;case 38:case 87:O=0;break;case 40:case 83:P=0;break;case 37:case 65:L=0;break;case 39:case 68:N=0}};
window.onbeforeunload=function(a){a.preventDefault();return a.returnValue="Are you sure you want to quit?"};e.oncontextmenu=function(a){a.preventDefault();return!1};function ma(){var a=0!=A.length?" ":"";a=`#include "../consts.h"\n
\n
static struct tile_info t;\n
\n
struct area_info area_000 = {\n
  &t,\n
  (struct ball_info[]){\n
    {0}\n
  },\n
  (struct pos[]){${a}${A.map(f=>`{ ${f.join(", ")} }`).join(", ")}${a}}, ${A.length}\n
};\n
\n
struct tile_info name = { ${x}, ${y}, 40, (uint8_t[]){\n`;let c="/*       ";for(var d=0;d<y;++d)c+=d.toString().padStart(3," ")+" ";c+="*/\n";a+=c+"\n";for(d=0;d<x;++d){a+=`/*${d.toString().padStart(4," ")}*/  `;for(let f=0;f<y;++f)a+=` ${w[d*y+f]}, `;a=a.substring(0,a.length-1);a+="\n\n"}a=a.substring(0,a.length-1);return btoa(a+`\n${c}  }\n};\n`)}
function na(a){try{a=atob(a);let c=a.match(/{ (\d+), (\d+) }/g);if(null==c)return 0;c=c.map(pa=>pa.match(/\d+/g).map(qa=>+qa));if(c.length!=a.match(/}, (\d+)\n};/)[1])return 0;const d=a.match(/{ (\d+), (\d+), 40, \(uint8_t\[\]\){/);if(null==d)return 0;const f=+d[1],v=+d[2];if(1>f||200<f||1>v||200<v)return 0;const M=eval(`[${a.substring(d.index+d[0].length,a.length-5)}]`);if(!(M instanceof Array)||M.length!=f*v)return 0;for(a=0;a<c.length;++a)if(c[a][0]>=f||c[a][1]>=v)return 0;x=f;y=v;t=x;u=y;ia();
ja();B={};for(a=0;a<c.length;++a)B[c[a][0]*y+c[a][1]]=[c[a][0],c[a][1]];A=Object.values(B);w=new Uint8Array(f*v);w.set(M);da();return 1}catch(c){return 0}}
function da(){S=Array(p.length);T=Array(p.length);var a=0;for(let c=0;c<x;++c)for(let d=0;d<y;++d)null==S[w[a]]&&(S[w[a]]=new Path2D,T[w[a]]=new Path2D),S[w[a]].rect(2*(1.5+40*c),2*(1.5+40*d),74,74),T[w[a]].rect(80*c,80*d,80,80),++a;h.width=80*x;h.height=80*y;l.width=80*x;l.height=80*y;for(a=0;256>a;++a)S[a]&&(k.fillStyle=p[a]+"b0",k.fill(T[a]),k.fillStyle=p[a],k.fill(S[a]),m.fillStyle=p[a],m.fill(T[a]));V=1}
function ka(){var a=R;const c=a%y;a=(a-c)/y;k.clearRect(80*a,80*c,80,80);k.fillStyle=p[q]+"b0";k.fillRect(80*a,80*c,80,80);k.fillStyle=p[q];k.fillRect(2*(1.5+40*a),2*(1.5+40*c),74,74);m.fillStyle=p[q];m.fillRect(80*a,80*c,80,80);V=1}z();let Z=b("button");Z.innerHTML="Export & copy";Z.timeout=-1;
Z.onclick=function(){const a=ma();window.navigator.clipboard.writeText(a);-1!=this.timeout&&clearTimeout(this.timeout);this.innerHTML="Exported & copied";this.timeout=setTimeout(function(){this.innerHTML="Export & copy";this.timeout=-1}.bind(this),500)}.bind(Z);n.a(Z);Z=b("button");Z.innerHTML="Import";Z.onclick=function(){let a=prompt("Please paste the config below:");a&&(a=a.trim(),0!=a.length&&(na(a)||alert("The config is invalid, it won't be loaded.")))};n.a(Z);Z=b("h4");Z.innerHTML="Width";
Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="range";Z.min=1;Z.max=200;Z.value=10;Z.step=1;ia=function(){this.value=x;this.nextElementSibling.innerHTML=x+" tiles";this.nextElementSibling.nextElementSibling.value=x}.bind(Z);Z.oninput=function(){x=this.valueAsNumber||1;ia();z()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML=x+" tiles";Z.style["margin-top"]="2px";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="number";Z.style["margin-top"]="2px";Z.value=x;Z.min=1;Z.max=200;
Z.oninput=function(){this.valueAsNumber=x=this.valueAsNumber?Math.max(Math.min(this.valueAsNumber,this.max),this.min):1;this.previousElementSibling.innerHTML=x+" tiles";this.previousElementSibling.previousElementSibling.value=x;z()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML="Height";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="range";Z.min=1;Z.max=200;Z.value=10;Z.step=1;
ja=function(){this.value=y;this.nextElementSibling.innerHTML=y+" tiles";this.nextElementSibling.nextElementSibling.value=y}.bind(Z);Z.oninput=function(){y=this.valueAsNumber||1;ja();z()}.bind(Z);n.a(Z);Z=b("h4");Z.innerHTML=y+" tiles";Z.style["margin-top"]="2px";Z.style["margin-bottom"]="2px";n.a(Z);Z=b("input");Z.type="number";Z.style["margin-top"]="2px";Z.value=y;Z.min=1;Z.max=200;
Z.oninput=function(){this.valueAsNumber=y=this.valueAsNumber?Math.max(Math.min(this.valueAsNumber,this.max),this.min):1;this.previousElementSibling.innerHTML=y+" tiles";this.previousElementSibling.previousElementSibling.value=y;z()}.bind(Z);n.a(Z);for(let a=0;a<p.length;++a){const c=b("div");Z=b("h4");Z.innerHTML=ba[a];c.appendChild(Z);r[r.length]=Z;Z=b("div");Z.className="tile";Z.style["background-color"]=p[a];Z.onclick=function(){q=a;ca()};c.appendChild(Z);n.a(c)}ca();
function X(a,c,d,f,v,M){f*=F;c=.5*e.width+(c-I)*F;d=.5*e.height+(d-J)*F;v=((v&&(c<f||c>e.width-f)?Math.max(Math.min(c,e.width-f),f):c)-.5*e.width)/F+I;f=((M&&(d<f||d>e.height-f)?Math.max(Math.min(d,e.height-f),f):d)-.5*e.height)/F+J;g.translate(v,f);g.font="700 20px Ubuntu";g.textAlign="center";g.textBaseline="middle";g.fillStyle="#fff";g.strokeStyle="#333";g.lineWidth=1;g.fillText(a,0,0);g.strokeText(a,0,0);g.translate(-v,-f)}
function oa(){var a=F;F=Y(F,G,.075);let c=I,d=J;if(0==P-O&&0==N-L)Q=[Y(Q[0],0,.1),Y(Q[1],0,.1)];else{const f=Math.atan2(P-O,N-L);Q=[Y(Q[0],10*Math.cos(f)/F,.1),Y(Q[1],10*Math.sin(f)/F,.1)]}I+=Q[0];J+=Q[1];if(V||a!=F||c!=I||d!=J){V=!1;g.resetTransform();g.clearRect(0,0,e.width,e.height);g.translate(.5*e.width,.5*e.height);g.scale(F,F);g.translate(-I,-J);g.drawImage(h,0,0,h.width/2,h.height/2);1>F&&(g.globalAlpha=1-F*F,g.drawImage(l,0,0,h.width/2,h.height/2),g.globalAlpha=1);ha||(X("WASD or arrow keys to move around, scroll to zoom",
-500,H-80,0,!1,!1),X("Click on the left to pick what type of tile you want to place",-500,H-40,0,!1,!1),X("Set spawnpoints by clicking LMB and pressing Q at the same time",-500,H,0,!1,!1),X("Unset spawnpoints by clicking RMB and pressing Q at the same time",-500,H+40,0,!1,!1),X("Press E to hide this message",-500,H+80,0,!1,!1));for(const f of A)X("S",20+40*f[0],20+40*f[1],0,!1,!1);for(a=0;a<x;++a)X(a.toString(),20+40*a,-40,20,!1,!0);x&1?X("M",20+40*(x-1>>1),-20,40,!1,!0):(X("M",20+40*(x>>1),-20,40,
!1,!0),X("M",20+40*((x>>1)-1),-20,40,!1,!0));for(a=0;a<y;++a)X(a.toString(),40*x+40,20+40*a,20,!0,!1);y&1?X("M",40*x+20,20+40*(y-1>>1),40,!0,!1):(X("M",40*x+20,20+40*(y>>1),40,!0,!1),X("M",40*x+20,20+40*((y>>1)-1),40,!0,!1))}requestAnimationFrame(oa)}oa();
